<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SlowDay ‚Äî Back Office</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #18181f;
    --border: rgba(255,255,255,0.07);
    --border-bright: rgba(255,255,255,0.13);
    --accent: #7c5cfc;
    --accent2: #fc5c7d;
    --green: #22d3a0;
    --yellow: #f5c842;
    --red: #fc5c5c;
    --text: #f0f0f8;
    --text2: #8888aa;
    --text3: #4a4a6a;
    --mono: 'DM Mono', monospace;
    --sans: 'DM Sans', sans-serif;
}

body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
}

/* LOGIN SCREEN */
#loginScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: var(--bg);
    position: relative;
}
#loginScreen::before {
    content: '';
    position: absolute;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(124,92,252,0.15) 0%, transparent 70%);
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
}

.login-box {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: 20px;
    padding: 48px 40px;
    width: 380px;
    position: relative;
    z-index: 1;
}
.login-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 32px;
}
.login-logo-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
}
.login-logo-text {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
}
.login-logo-text span {
    color: var(--text2);
    font-weight: 400;
    font-size: 13px;
    display: block;
    font-family: var(--mono);
    letter-spacing: 1px;
    text-transform: uppercase;
}
.login-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
.login-sub { color: var(--text2); font-size: 14px; margin-bottom: 28px; }

.login-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text2);
    margin-bottom: 8px;
}
.login-field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 20px;
}
.login-field input:focus { border-color: var(--accent); }
.login-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), #5a3dcc);
    border: none;
    border-radius: 10px;
    padding: 13px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    font-family: var(--sans);
}
.login-btn:hover { opacity: 0.85; }
.login-error {
    background: rgba(252,92,92,0.1);
    border: 1px solid rgba(252,92,92,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 13px;
    color: var(--red);
    margin-bottom: 16px;
    display: none;
}

/* DASHBOARD */
#dashboard { display: none; min-height: 100vh; }

/* SIDEBAR */
.sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    padding: 24px 0;
}
.sidebar-logo {
    display: flex; align-items: center; gap: 10px;
    padding: 0 20px 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
}
.sidebar-logo-icon {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
}
.sidebar-logo-text { font-size: 15px; font-weight: 700; }
.sidebar-logo-text span {
    display: block;
    font-family: var(--mono);
    font-size: 9px;
    color: var(--text2);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: 400;
    margin-top: 1px;
}
.nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px;
    color: var(--text2);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border-radius: 0;
    transition: all 0.15s;
    border-left: 3px solid transparent;
    margin: 1px 0;
}
.nav-item:hover { color: var(--text); background: rgba(255,255,255,0.04); }
.nav-item.active { color: var(--text); background: rgba(124,92,252,0.1); border-left-color: var(--accent); }
.nav-icon { font-size: 16px; width: 20px; text-align: center; }

.sidebar-bottom {
    margin-top: auto;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
}
.logout-btn {
    display: flex; align-items: center; gap: 8px;
    color: var(--text2);
    cursor: pointer;
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.15s;
    background: none; border: none; width: 100%;
    font-family: var(--sans);
}
.logout-btn:hover { color: var(--red); background: rgba(252,92,92,0.1); }

/* MAIN CONTENT */
.main {
    margin-left: 220px;
    padding: 32px 36px;
    min-height: 100vh;
}
.page { display: none; }
.page.active { display: block; }

.page-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 32px;
}
.page-title { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
.page-sub { color: var(--text2); font-size: 14px; margin-top: 4px; }
.refresh-btn {
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 10px;
    padding: 8px 16px;
    color: var(--text2);
    font-size: 13px;
    cursor: pointer;
    font-family: var(--sans);
    transition: all 0.15s;
    display: flex; align-items: center; gap: 6px;
}
.refresh-btn:hover { color: var(--text); border-color: var(--accent); }

/* STAT CARDS */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
}
.stat-card:hover { border-color: var(--border-bright); }
.stat-card::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 80px; height: 80px;
    border-radius: 50%;
    opacity: 0.08;
}
.stat-card.purple::before { background: var(--accent); }
.stat-card.pink::before { background: var(--accent2); }
.stat-card.green::before { background: var(--green); }
.stat-card.yellow::before { background: var(--yellow); }

.stat-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text2);
    margin-bottom: 10px;
}
.stat-value {
    font-size: 32px;
    font-weight: 700;
    font-family: var(--mono);
    letter-spacing: -1px;
    line-height: 1;
    margin-bottom: 6px;
}
.stat-value.purple { color: var(--accent); }
.stat-value.green { color: var(--green); }
.stat-value.yellow { color: var(--yellow); }
.stat-value.pink { color: var(--accent2); }
.stat-change {
    font-size: 12px;
    color: var(--text3);
    font-family: var(--mono);
}

/* SECTION HEADERS */
.section-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text2);
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
}
.section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
}

/* TABLE */
.table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 28px;
}
.table-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}
.table-title { font-size: 14px; font-weight: 600; }
.table-count {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text2);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
thead th {
    padding: 10px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
}
tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(255,255,255,0.02); }
tbody td {
    padding: 12px 16px;
    color: var(--text2);
    vertical-align: middle;
}
tbody td.bold { color: var(--text); font-weight: 500; }
tbody td.mono { font-family: var(--mono); font-size: 12px; }

/* CATEGORY ACCORDION */
.category-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 16px;
    overflow: hidden;
}
.category-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    cursor: pointer;
    transition: background 0.15s;
    user-select: none;
}
.category-header:hover { background: rgba(255,255,255,0.03); }
.category-header-left { display: flex; align-items: center; gap: 12px; }
.category-icon { font-size: 22px; }
.category-name { font-size: 15px; font-weight: 600; }
.category-providers { font-size: 12px; color: var(--text2); margin-top: 2px; font-family: var(--mono); }
.category-badge {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    background: rgba(124,92,252,0.15);
    color: var(--accent);
    border: 1px solid rgba(124,92,252,0.25);
}
.chevron { color: var(--text3); font-size: 12px; transition: transform 0.2s; }
.category-block.open .chevron { transform: rotate(180deg); }
.category-body { display: none; border-top: 1px solid var(--border); }
.category-block.open .category-body { display: block; }

.provider-row {
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
}
.provider-row:last-child { border-bottom: none; }
.provider-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.provider-location { font-size: 12px; color: var(--text2); margin-bottom: 12px; }
.deal-status {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
    margin-bottom: 12px;
}
.deal-status.active { background: rgba(34,211,160,0.12); color: var(--green); border: 1px solid rgba(34,211,160,0.25); }
.deal-status.inactive { background: rgba(252,92,92,0.1); color: var(--red); border: 1px solid rgba(252,92,92,0.2); }

/* SLOT MINI TABLE */
.slot-table { width: 100%; border-collapse: collapse; font-size: 12px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
.slot-table th { padding: 7px 12px; text-align: left; font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); }
.slot-table td { padding: 8px 12px; color: var(--text2); border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
.slot-table tr:last-child td { border-bottom: none; }
.slot-table tr:hover td { background: rgba(255,255,255,0.02); }

.slot-bar {
    display: flex; align-items: center; gap: 8px;
}
.slot-bar-track {
    flex: 1;
    height: 5px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    overflow: hidden;
    min-width: 60px;
}
.slot-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent);
    transition: width 0.3s;
}
.slot-bar-fill.full { background: var(--red); }
.slot-bar-fill.half { background: var(--yellow); }
.slot-bar-fill.low { background: var(--green); }

/* LOADING */
.loading {
    display: flex; align-items: center; justify-content: center;
    padding: 60px;
    color: var(--text2);
    gap: 12px;
    font-size: 14px;
}
.spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border-bright);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* PILL BADGES */
.pill {
    display: inline-block;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
}
.pill.green { background: rgba(34,211,160,0.12); color: var(--green); }
.pill.red { background: rgba(252,92,92,0.1); color: var(--red); }
.pill.yellow { background: rgba(245,200,66,0.12); color: var(--yellow); }
.pill.purple { background: rgba(124,92,252,0.15); color: var(--accent); }

/* LAST UPDATED */
.last-updated {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    margin-bottom: 24px;
}

/* TWO COL GRID */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
@media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ LEAD FINDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.lead-search-box {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
}
.lead-field-row { display: flex; gap: 16px; margin-bottom: 20px; }
.lead-field { flex: 1; }
.lead-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text2);
    margin-bottom: 8px;
}
.lead-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 10px;
    padding: 11px 16px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}
.lead-input:focus { border-color: var(--accent); }
.lead-industry-actions { display: flex; gap: 8px; margin-bottom: 10px; }
.lead-toggle-btn {
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 6px;
    color: var(--text2);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 12px;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
}
.lead-toggle-btn:hover { color: var(--accent); border-color: var(--accent); }
.lead-industries {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.lead-check {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 7px 14px;
    font-size: 13px;
    color: var(--text2);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    user-select: none;
}
.lead-check:has(input:checked) { border-color: var(--accent); color: var(--text); }
.lead-check input { accent-color: var(--accent); cursor: pointer; }
.lead-search-btn {
    margin-top: 20px;
    background: linear-gradient(135deg, var(--accent), #5a3dcc);
    border: none;
    border-radius: 10px;
    padding: 12px 28px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    font-family: var(--sans);
}
.lead-search-btn:hover { opacity: 0.85; }
.lead-search-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.lead-status {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.lead-results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    flex-wrap: wrap;
    gap: 8px;
}
.lead-count {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--green);
    font-weight: 600;
}
.lead-note {
    font-size: 12px;
    color: var(--text3);
}
.lead-table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
}
.lead-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.lead-table th {
    background: var(--surface2);
    color: var(--text2);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 12px 14px;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
}
.lead-table td {
    padding: 11px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: middle;
    max-width: 200px;
}
.lead-table tr:last-child td { border-bottom: none; }
.lead-table tr:hover td { background: var(--surface2); }
.lead-table td:first-child { color: var(--text3); font-family: var(--mono); width: 40px; }
.lead-name { font-weight: 600; }
.lead-phone { font-family: var(--mono); color: var(--green); white-space: nowrap; }
.lead-email { font-family: var(--mono); font-size: 12px; color: var(--accent); word-break: break-all; }
.lead-addr { font-size: 12px; color: var(--text2); }
.lead-web a { color: var(--accent2); font-size: 12px; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 140px; }
.lead-web a:hover { text-decoration: underline; }
.lead-service { }
.lead-service .pill { font-size: 11px; }
.lead-contact-input {
    background: transparent;
    border: none;
    border-bottom: 1px dashed var(--border-bright);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    padding: 2px 4px;
    width: 100%;
    outline: none;
    min-width: 120px;
}
.lead-contact-input:focus { border-bottom-color: var(--accent); }
.lead-contact-input::placeholder { color: var(--text3); font-style: italic; }
.lead-empty { color: var(--text3); font-style: italic; }

/* LEAD TABS */
.lead-tabs {
    display: flex; gap: 4px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 4px;
    width: fit-content; margin-bottom: 24px;
}
.lead-tab-btn {
    background: none; border: none; border-radius: 9px;
    padding: 8px 22px; color: var(--text2);
    font-family: var(--sans); font-size: 14px; font-weight: 500;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; gap: 7px;
}
.lead-tab-btn:hover { color: var(--text); }
.lead-tab-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
.lead-tab-badge {
    background: var(--accent); color: white;
    font-size: 11px; font-family: var(--mono);
    padding: 1px 7px; border-radius: 20px; min-width: 20px; text-align: center;
}

/* LEAD FILTER BAR */
.lead-filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.lead-filter-select, .lead-filter-input {
    background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 8px; padding: 8px 12px;
    color: var(--text); font-family: var(--sans); font-size: 13px;
    outline: none; transition: border-color 0.2s;
}
.lead-filter-select { min-width: 150px; cursor: pointer; }
.lead-filter-input { min-width: 180px; }
.lead-filter-select:focus, .lead-filter-input:focus { border-color: var(--accent); }

/* LEAD STATUS SELECT */
.lead-status-select {
    background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 6px; padding: 4px 8px;
    color: var(--text); font-family: var(--sans); font-size: 12px;
    cursor: pointer; outline: none; width: 130px;
}
.lead-status-select.s-new       { border-color: var(--accent); color: var(--accent); }
.lead-status-select.s-contacted { border-color: var(--yellow); color: var(--yellow); }
.lead-status-select.s-interested{ border-color: var(--green);  color: var(--green);  }
.lead-status-select.s-onboarded { border-color: #9d7dff;       color: #9d7dff;       }
.lead-status-select.s-rejected  { border-color: var(--red);    color: var(--red);    }

/* LEAD NOTES INPUT */
.lead-notes-input {
    background: none; border: none;
    border-bottom: 1px solid var(--border-bright);
    color: var(--text2); font-family: var(--sans); font-size: 12px;
    padding: 3px 0; outline: none; width: 150px; transition: border-color 0.2s;
}
.lead-notes-input:focus { border-bottom-color: var(--accent); }
.lead-notes-input::placeholder { color: var(--text3); font-style: italic; }

/* LEAD SAVE + DELETE */
.lead-save-btn {
    background: linear-gradient(135deg, var(--green), #0fa87a);
    border: none; border-radius: 8px; padding: 8px 18px;
    color: #051a10; font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: var(--sans); transition: opacity 0.2s;
    display: flex; align-items: center; gap: 6px;
}
.lead-save-btn:hover { opacity: 0.85; }
.lead-save-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.lead-delete-btn {
    background: none; border: none; color: var(--text3);
    cursor: pointer; padding: 4px 6px; border-radius: 4px;
    font-size: 15px; transition: color 0.15s; line-height: 1;
}
.lead-delete-btn:hover { color: var(--red); }
.lead-saved-count { font-size: 13px; color: var(--text2); margin-left: auto; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-box">
        <div class="login-logo">
            <div class="login-logo-icon">‚ö°</div>
            <div class="login-logo-text">SlowDay <span>Back Office</span></div>
        </div>
        <div class="login-title">Internal Access Only</div>
        <div class="login-sub">Enter your admin password to continue</div>
        <div class="login-error" id="loginError">Incorrect password. Try again.</div>
        <div class="login-field">
            <label>Admin Password</label>
            <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="login-btn" onclick="doLogin()">Access Dashboard ‚Üí</button>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <div class="sidebar-logo-icon">‚ö°</div>
            <div class="sidebar-logo-text">SlowDay <span>Back Office</span></div>
        </div>
        <div class="nav-item active" onclick="showPage('overview')" id="nav-overview">
            <span class="nav-icon">üìä</span> Overview
        </div>
        <div class="nav-item" onclick="showPage('categories')" id="nav-categories">
            <span class="nav-icon">üóÇÔ∏è</span> Categories & Slots
        </div>
        <div class="nav-item" onclick="showPage('users')" id="nav-users">
            <span class="nav-icon">üë•</span> Users
        </div>
        <div class="nav-item" onclick="showPage('bookings')" id="nav-bookings">
            <span class="nav-icon">üìÖ</span> Bookings
        </div>
        <div class="nav-item" onclick="showPage('leads')" id="nav-leads">
            <span class="nav-icon">üéØ</span> Lead Finder
        </div>
        <div class="sidebar-bottom">
            <button class="logout-btn" onclick="doLogout()">üö™ Sign Out</button>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main">

        <!-- OVERVIEW PAGE -->
        <div class="page active" id="page-overview">
            <div class="page-header">
                <div>
                    <div class="page-title">Overview</div>
                    <div class="page-sub">Platform health at a glance</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div class="last-updated" id="lastUpdated">Loading...</div>

            <div class="section-title">Application Usage</div>
            <div class="stats-grid" id="usageStats">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>

            <div class="section-title">User Breakdown</div>
            <div class="stats-grid" id="userStats">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>

            <div class="section-title">Bookings & Revenue</div>
            <div class="stats-grid" id="bookingStats">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- CATEGORIES & SLOTS PAGE -->
        <div class="page" id="page-categories">
            <div class="page-header">
                <div>
                    <div class="page-title">Categories & Slots</div>
                    <div class="page-sub">Service deals grouped by category with slot availability</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="categoriesContent">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- USERS PAGE -->
        <div class="page" id="page-users">
            <div class="page-header">
                <div>
                    <div class="page-title">User Analytics</div>
                    <div class="page-sub">Active users and growth metrics</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="usersContent">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- BOOKINGS PAGE -->
        <div class="page" id="page-bookings">
            <div class="page-header">
                <div>
                    <div class="page-title">Booking Analytics</div>
                    <div class="page-sub">Booking volume and revenue tracking</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="bookingsContent">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- LEAD FINDER PAGE -->
        <div class="page" id="page-leads">
            <div class="page-header">
                <div>
                    <div class="page-title">Lead Finder</div>
                    <div class="page-sub">Find &amp; track outreach to local service businesses</div>
                </div>
            </div>

            <!-- Tab switcher -->
            <div class="lead-tabs">
                <button class="lead-tab-btn active" id="leadTabSearch" onclick="switchLeadTab('search')">Search</button>
                <button class="lead-tab-btn" id="leadTabSaved" onclick="switchLeadTab('saved')">
                    My Leads
                    <span class="lead-tab-badge" id="leadSavedBadge" style="display:none">0</span>
                </button>
            </div>

            <!-- ‚îÄ‚îÄ SEARCH VIEW ‚îÄ‚îÄ -->
            <div id="leadSearchView">
                <div class="lead-search-box">
                    <div class="lead-field-row">
                        <div class="lead-field">
                            <label class="lead-label">Town / City</label>
                            <input type="text" id="leadCity" placeholder="e.g. Toronto, ON" class="lead-input" onkeydown="if(event.key==='Enter')searchLeads()">
                        </div>
                    </div>
                    <div class="lead-field">
                        <label class="lead-label">Industries</label>
                        <div class="lead-industry-actions">
                            <button class="lead-toggle-btn" onclick="selectAllIndustries()">Select All</button>
                            <button class="lead-toggle-btn" onclick="clearAllIndustries()">Clear</button>
                        </div>
                        <div class="lead-industries" id="leadIndustries">
                            <label class="lead-check"><input type="checkbox" value="Haircut" checked> Haircut</label>
                            <label class="lead-check"><input type="checkbox" value="Barber" checked> Barber</label>
                            <label class="lead-check"><input type="checkbox" value="Cleaning Service" checked> Cleaning Service</label>
                            <label class="lead-check"><input type="checkbox" value="Massage" checked> Massage</label>
                            <label class="lead-check"><input type="checkbox" value="Nail Service" checked> Nail Service</label>
                            <label class="lead-check"><input type="checkbox" value="Spa Treatment" checked> Spa Treatment</label>
                            <label class="lead-check"><input type="checkbox" value="Personal Training" checked> Personal Training</label>
                            <label class="lead-check"><input type="checkbox" value="Dog Walking" checked> Dog Walking</label>
                            <label class="lead-check"><input type="checkbox" value="Tutoring" checked> Tutoring</label>
                            <label class="lead-check"><input type="checkbox" value="Photography" checked> Photography</label>
                            <label class="lead-check"><input type="checkbox" value="Car Detailing" checked> Car Detailing</label>
                            <label class="lead-check"><input type="checkbox" value="Laundry Service" checked> Laundry Service</label>
                        </div>
                    </div>
                    <button class="lead-search-btn" onclick="searchLeads()" id="leadSearchBtn">üîç Find Leads</button>
                </div>

                <div id="leadStatus" class="lead-status" style="display:none;"></div>

                <div id="leadResults" style="display:none;">
                    <div class="lead-results-header">
                        <span id="leadCount" class="lead-count"></span>
                        <div style="display:flex;align-items:center;gap:10px;margin-left:auto;">
                            <button class="lead-save-btn" id="leadSaveBtn" onclick="saveLeadsToDb()">Ôºã Save to My Leads</button>
                            <button class="refresh-btn" id="leadExportBtn" onclick="exportLeadsCSV()">‚Üì CSV</button>
                        </div>
                    </div>
                    <div class="lead-table-wrap">
                        <table class="lead-table" id="leadTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Business Name</th>
                                    <th>Contact Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Website</th>
                                    <th>Service</th>
                                </tr>
                            </thead>
                            <tbody id="leadTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ MY LEADS VIEW ‚îÄ‚îÄ -->
            <div id="leadSavedView" style="display:none;">
                <div class="lead-filter-bar">
                    <select class="lead-filter-select" id="savedFilterStatus" onchange="loadSavedLeads()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="interested">Interested</option>
                        <option value="onboarded">Onboarded</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <input class="lead-filter-input" id="savedFilterCity" placeholder="Filter by city‚Ä¶" onkeydown="if(event.key==='Enter')loadSavedLeads()">
                    <select class="lead-filter-select" id="savedFilterService" onchange="loadSavedLeads()">
                        <option value="">All Services</option>
                        <option>Haircut</option><option>Barber</option>
                        <option>Cleaning Service</option><option>Massage</option>
                        <option>Nail Service</option><option>Spa Treatment</option>
                        <option>Personal Training</option><option>Dog Walking</option>
                        <option>Tutoring</option><option>Photography</option>
                        <option>Car Detailing</option><option>Laundry Service</option>
                    </select>
                    <button class="lead-toggle-btn" onclick="loadSavedLeads()">Apply</button>
                    <span class="lead-saved-count" id="savedLeadsCount"></span>
                </div>
                <div id="savedLeadsStatus" class="lead-status" style="display:none;"></div>
                <div class="lead-table-wrap">
                    <table class="lead-table" id="savedLeadsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Business Name</th>
                                <th>Contact Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>City</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Notes</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="savedLeadsBody">
                            <tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text3);">Click "My Leads" tab to load saved leads.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const API_BASE = 'https://slowday-deals.onrender.com/api';
let adminKey = '';
let cachedData = null;

const CATEGORY_ICONS = {
    'Haircut': '‚úÇÔ∏è', 'Barber': 'üíà', 'Cleaning': 'üßπ', 'Massage': 'üíÜ',
    'Nails': 'üíÖ', 'Spa': 'üõÅ', 'Personal Training': 'üèãÔ∏è', 'Dog Walking': 'üêï',
    'Tutoring': 'üìö', 'Photography': 'üì∑', 'Car Detailing': 'üöó',
    'Laundry Service': 'üëï', 'Other': '‚ú®'
};

function doLogin() {
    const pass = document.getElementById('adminPass').value.trim();
    if (!pass) return;
    adminKey = pass;
    document.getElementById('loginError').style.display = 'none';
    loadData(true);
}

function doLogout() {
    adminKey = '';
    cachedData = null;
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminPass').value = '';
}

async function loadData(isLogin = false) {
    try {
        const res = await fetch(`${API_BASE}/admin/analytics`, {
            headers: { 'x-admin-key': adminKey }
        });
        if (res.status === 401) {
            document.getElementById('loginError').style.display = 'block';
            return;
        }
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        cachedData = data;
        if (isLogin) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }
        renderAll(data);
    } catch (err) {
        console.error(err);
        if (isLogin) {
            document.getElementById('loginError').style.display = 'block';
            document.getElementById('loginError').textContent = 'Connection error. Check API URL.';
        }
    }
}

function renderAll(data) {
    const time = new Date(data.generatedAt).toLocaleString();
    document.getElementById('lastUpdated').textContent = `Last updated: ${time}`;
    renderOverview(data);
    renderCategories(data);
    renderUsers(data);
    renderBookings(data);
}

function renderOverview(data) {
    const { users, bookings } = data;

    document.getElementById('usageStats').innerHTML = `
        <div class="stat-card purple">
            <div class="stat-label">Daily Active Users</div>
            <div class="stat-value purple">${users.dau}</div>
            <div class="stat-change">last 24 hours</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-label">Weekly Active Users</div>
            <div class="stat-value purple">${users.wau}</div>
            <div class="stat-change">last 7 days</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-label">Monthly Active Users</div>
            <div class="stat-value purple">${users.mau}</div>
            <div class="stat-change">last 30 days</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Bookings Today</div>
            <div class="stat-value green">${bookings.bookingsToday}</div>
            <div class="stat-change">this week: ${bookings.bookingsWeek}</div>
        </div>
    `;

    document.getElementById('userStats').innerHTML = `
        <div class="stat-card purple">
            <div class="stat-label">Total Users</div>
            <div class="stat-value purple">${users.totalUsers}</div>
            <div class="stat-change">+${users.newUsersToday} today</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Total Customers</div>
            <div class="stat-value green">${users.totalCustomers}</div>
            <div class="stat-change">+${users.newUsersWeek} this week</div>
        </div>
        <div class="stat-card pink">
            <div class="stat-label">Total Providers</div>
            <div class="stat-value pink">${users.totalProviders}</div>
            <div class="stat-change">+${users.newUsersMonth} this month</div>
        </div>
    `;

    document.getElementById('bookingStats').innerHTML = `
        <div class="stat-card purple">
            <div class="stat-label">Total Bookings</div>
            <div class="stat-value purple">${bookings.totalBookings}</div>
            <div class="stat-change">all time</div>
        </div>
        <div class="stat-card yellow">
            <div class="stat-label">Pending</div>
            <div class="stat-value yellow">${bookings.pendingBookings}</div>
            <div class="stat-change">awaiting confirmation</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Confirmed</div>
            <div class="stat-value green">${bookings.confirmedBookings}</div>
            <div class="stat-change">+ ${bookings.completedBookings} completed</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value green">$${bookings.totalRevenue.toLocaleString()}</div>
            <div class="stat-change">$${bookings.totalSaved.toLocaleString()} saved by users</div>
        </div>
    `;
}

function renderCategories(data) {
    const { byCategory } = data.services;
    const cats = Object.keys(byCategory).sort();

    if (cats.length === 0) {
        document.getElementById('categoriesContent').innerHTML = '<div class="loading">No services found</div>';
        return;
    }

    let html = `<p style="font-size:13px;color:var(--text2);margin-bottom:20px;">${data.services.total} active services across ${cats.length} categories. Click a category to expand.</p>`;

    cats.forEach(cat => {
        const providers = byCategory[cat];
        const icon = CATEGORY_ICONS[cat] || '‚ú®';
        const totalSlots = providers.reduce((sum, p) => {
            return sum + p.slots.reduce((s2, sl) => s2 + (typeof sl.totalSlots === 'number' ? sl.totalSlots : 0), 0);
        }, 0);

        html += `
        <div class="category-block" id="cat-${cat.replace(/\s/g,'_')}">
            <div class="category-header" onclick="toggleCat('${cat.replace(/\s/g,'_')}')">
                <div class="category-header-left">
                    <div class="category-icon">${icon}</div>
                    <div>
                        <div class="category-name">${cat}</div>
                        <div class="category-providers">${providers.length} provider${providers.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span class="category-badge">${providers.length} deals</span>
                    <span class="chevron">‚ñº</span>
                </div>
            </div>
            <div class="category-body">`;

        providers.forEach(prov => {
            html += `
                <div class="provider-row">
                    <div class="provider-name">${prov.providerName}</div>
                    <div class="provider-location">üìç ${prov.location}</div>
                    <span class="deal-status ${prov.dealActive ? 'active' : 'inactive'}">
                        ${prov.dealActive ? '‚óè Active Deal' : '‚óã Deal Off'}
                    </span>
                    <table class="slot-table">
                        <thead>
                            <tr>
                                <th>Day / Period</th>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Price</th>
                                <th>Total Slots</th>
                                <th>Booked</th>
                                <th>Remaining</th>
                                <th>Fill Rate</th>
                            </tr>
                        </thead>
                        <tbody>`;
            prov.slots.forEach(slot => {
                const total = typeof slot.totalSlots === 'number' ? slot.totalSlots : null;
                const booked = slot.bookedSlots || 0;
                const remaining = typeof slot.remainingSlots === 'number' ? slot.remainingSlots : '‚àû';
                const pct = total ? Math.round((booked / total) * 100) : 0;
                const fillClass = pct >= 90 ? 'full' : pct >= 50 ? 'half' : 'low';
                const timeStr = slot.startTime !== '-' ? `${slot.startTime} ‚Äì ${slot.endTime}` : '‚Äî';
                const durStr = slot.duration !== '-' ? `${slot.duration}m` : '‚Äî';

                html += `
                            <tr>
                                <td class="bold">${slot.day}</td>
                                <td class="mono">${timeStr}</td>
                                <td class="mono">${durStr}</td>
                                <td class="mono" style="color:var(--green)">$${slot.price}</td>
                                <td class="mono">${slot.totalSlots}</td>
                                <td class="mono">${booked}</td>
                                <td class="mono">${remaining}</td>
                                <td>
                                    ${total ? `<div class="slot-bar">
                                        <div class="slot-bar-track">
                                            <div class="slot-bar-fill ${fillClass}" style="width:${pct}%"></div>
                                        </div>
                                        <span class="mono" style="font-size:10px;color:var(--text3);min-width:28px">${pct}%</span>
                                    </div>` : '<span style="color:var(--text3);font-size:11px">unlimited</span>'}
                                </td>
                            </tr>`;
            });
            html += `</tbody></table></div>`;
        });

        html += `</div></div>`;
    });

    document.getElementById('categoriesContent').innerHTML = html;
}

function renderUsers(data) {
    const { users } = data;
    document.getElementById('usersContent').innerHTML = `
        <div class="two-col">
            <div class="table-wrap">
                <div class="table-header">
                    <div class="table-title">Active Users</div>
                </div>
                <table>
                    <thead><tr><th>Period</th><th>Active Users</th><th>New Sign-ups</th></tr></thead>
                    <tbody>
                        <tr><td class="bold">Today (24h)</td><td class="mono" style="color:var(--accent)">${users.dau}</td><td class="mono" style="color:var(--green)">+${users.newUsersToday}</td></tr>
                        <tr><td class="bold">This Week (7d)</td><td class="mono" style="color:var(--accent)">${users.wau}</td><td class="mono" style="color:var(--green)">+${users.newUsersWeek}</td></tr>
                        <tr><td class="bold">This Month (30d)</td><td class="mono" style="color:var(--accent)">${users.mau}</td><td class="mono" style="color:var(--green)">+${users.newUsersMonth}</td></tr>
                        <tr><td class="bold">All Time</td><td class="mono" style="color:var(--accent)">${users.totalUsers}</td><td class="mono" style="color:var(--text3)">total</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-wrap">
                <div class="table-header">
                    <div class="table-title">User Breakdown</div>
                </div>
                <table>
                    <thead><tr><th>Type</th><th>Count</th><th>Share</th></tr></thead>
                    <tbody>
                        <tr>
                            <td class="bold">üë• Customers</td>
                            <td class="mono" style="color:var(--green)">${users.totalCustomers}</td>
                            <td><div class="slot-bar"><div class="slot-bar-track"><div class="slot-bar-fill low" style="width:${users.totalUsers ? Math.round(users.totalCustomers/users.totalUsers*100) : 0}%"></div></div><span class="mono" style="font-size:10px;color:var(--text3)">${users.totalUsers ? Math.round(users.totalCustomers/users.totalUsers*100) : 0}%</span></div></td>
                        </tr>
                        <tr>
                            <td class="bold">üè™ Providers</td>
                            <td class="mono" style="color:var(--accent2)">${users.totalProviders}</td>
                            <td><div class="slot-bar"><div class="slot-bar-track"><div class="slot-bar-fill" style="background:var(--accent2);width:${users.totalUsers ? Math.round(users.totalProviders/users.totalUsers*100) : 0}%"></div></div><span class="mono" style="font-size:10px;color:var(--text3)">${users.totalUsers ? Math.round(users.totalProviders/users.totalUsers*100) : 0}%</span></div></td>
                        </tr>
                        <tr>
                            <td class="bold">üìä Total</td>
                            <td class="mono" style="color:var(--accent)">${users.totalUsers}</td>
                            <td><span class="pill purple">100%</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderBookings(data) {
    const { bookings } = data;
    const statuses = [
        { label: 'Pending', count: bookings.pendingBookings, color: 'yellow' },
        { label: 'Confirmed', count: bookings.confirmedBookings, color: 'green' },
        { label: 'Completed', count: bookings.completedBookings, color: 'purple' },
        { label: 'Cancelled', count: bookings.cancelledBookings, color: 'red' },
    ];

    document.getElementById('bookingsContent').innerHTML = `
        <div class="two-col">
            <div class="table-wrap">
                <div class="table-header"><div class="table-title">Booking Volume</div></div>
                <table>
                    <thead><tr><th>Period</th><th>Bookings</th></tr></thead>
                    <tbody>
                        <tr><td class="bold">Today</td><td class="mono" style="color:var(--green)">${bookings.bookingsToday}</td></tr>
                        <tr><td class="bold">This Week (7d)</td><td class="mono" style="color:var(--green)">${bookings.bookingsWeek}</td></tr>
                        <tr><td class="bold">All Time</td><td class="mono" style="color:var(--accent)">${bookings.totalBookings}</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-wrap">
                <div class="table-header"><div class="table-title">Revenue</div></div>
                <table>
                    <thead><tr><th>Metric</th><th>Value</th></tr></thead>
                    <tbody>
                        <tr><td class="bold">Total Revenue</td><td class="mono" style="color:var(--green)">$${bookings.totalRevenue.toLocaleString()}</td></tr>
                        <tr><td class="bold">Total Saved by Users</td><td class="mono" style="color:var(--yellow)">$${bookings.totalSaved.toLocaleString()}</td></tr>
                        <tr><td class="bold">Avg per Booking</td><td class="mono" style="color:var(--accent)">$${bookings.totalBookings ? Math.round(bookings.totalRevenue / bookings.totalBookings) : 0}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="table-wrap">
            <div class="table-header">
                <div class="table-title">Status Breakdown</div>
                <span class="table-count">${bookings.totalBookings} total</span>
            </div>
            <table>
                <thead><tr><th>Status</th><th>Count</th><th>Share</th></tr></thead>
                <tbody>
                    ${statuses.map(s => `
                    <tr>
                        <td class="bold">${s.label}</td>
                        <td class="mono">${s.count}</td>
                        <td><div class="slot-bar">
                            <div class="slot-bar-track">
                                <div class="slot-bar-fill ${s.color === 'red' ? 'full' : s.color === 'yellow' ? 'half' : 'low'}" style="width:${bookings.totalBookings ? Math.round(s.count/bookings.totalBookings*100) : 0}%"></div>
                            </div>
                            <span class="pill ${s.color}">${bookings.totalBookings ? Math.round(s.count/bookings.totalBookings*100) : 0}%</span>
                        </div></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function toggleCat(id) {
    const el = document.getElementById(`cat-${id}`);
    el.classList.toggle('open');
}

function showPage(name) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(`page-${name}`).classList.add('active');
    document.getElementById(`nav-${name}`).classList.add('active');
    if (name === 'leads') refreshSavedBadge();
}

// ‚îÄ‚îÄ LEAD FINDER / CRM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let leadsData = [];

function selectAllIndustries() {
    document.querySelectorAll('#leadIndustries input[type=checkbox]').forEach(c => c.checked = true);
}
function clearAllIndustries() {
    document.querySelectorAll('#leadIndustries input[type=checkbox]').forEach(c => c.checked = false);
}

function switchLeadTab(tab) {
    const isSearch = tab === 'search';
    document.getElementById('leadSearchView').style.display = isSearch ? 'block' : 'none';
    document.getElementById('leadSavedView').style.display  = isSearch ? 'none'  : 'block';
    document.getElementById('leadTabSearch').classList.toggle('active', isSearch);
    document.getElementById('leadTabSaved').classList.toggle('active', !isSearch);
    if (!isSearch) loadSavedLeads();
}

function setLeadStatus(msg, loading = false) {
    const el = document.getElementById('leadStatus');
    el.style.display = 'flex';
    el.innerHTML = loading
        ? `<div class="spinner" style="width:16px;height:16px;border-width:2px;flex-shrink:0;"></div><span>${msg}</span>`
        : `<span>${msg}</span>`;
}

function setSavedStatus(msg, loading = false) {
    const el = document.getElementById('savedLeadsStatus');
    el.style.display = 'flex';
    el.innerHTML = loading
        ? `<div class="spinner" style="width:16px;height:16px;border-width:2px;flex-shrink:0;"></div><span>${msg}</span>`
        : `<span>${msg}</span>`;
}

async function searchLeads() {
    const city = document.getElementById('leadCity').value.trim();
    if (!city) { setLeadStatus('‚ö†Ô∏è Please enter a town or city.'); return; }

    const checked = [...document.querySelectorAll('#leadIndustries input[type=checkbox]:checked')];
    if (!checked.length) { setLeadStatus('‚ö†Ô∏è Please select at least one industry.'); return; }

    const btn = document.getElementById('leadSearchBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Searching‚Ä¶';
    document.getElementById('leadResults').style.display = 'none';

    const industries = checked.map(c => c.value);
    const total = industries.length;
    setLeadStatus(`Searching ${total} industr${total === 1 ? 'y' : 'ies'} in "${city}" ‚Äî this may take up to ${total} min${total > 1 ? 's' : ''}‚Ä¶`, true);

    try {
        const params = new URLSearchParams({ city });
        industries.forEach(i => params.append('industries', i));

        const res = await fetch(`${API_BASE}/admin/leads?${params}`, {
            headers: { 'x-admin-key': adminKey }
        });
        const data = await res.json();

        if (!data.success) {
            setLeadStatus(`‚ùå ${data.message}`);
            return;
        }

        leadsData = data.leads || [];
        renderLeads(leadsData, city);
        setLeadStatus(`‚úÖ Done ‚Äî found ${leadsData.length} business${leadsData.length === 1 ? '' : 'es'} across ${industries.length} categor${industries.length === 1 ? 'y' : 'ies'} in ${city}.`);
    } catch (err) {
        setLeadStatus(`‚ùå Request failed: ${err.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Find Leads';
    }
}

function renderLeads(leads, city) {
    const tbody = document.getElementById('leadTableBody');
    if (!leads.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text3);">No businesses found for the selected criteria in ${city}.</td></tr>`;
        document.getElementById('leadCount').textContent = '0 results';
        document.getElementById('leadResults').style.display = 'block';
        return;
    }

    tbody.innerHTML = leads.map((l, i) => `
        <tr>
            <td>${i + 1}</td>
            <td class="lead-name">${esc(l.businessName)}</td>
            <td><input class="lead-contact-input" data-idx="${i}" placeholder="Enter name‚Ä¶" value="${esc(l.contactName)}" oninput="leadsData[${i}].contactName=this.value"></td>
            <td class="lead-phone">${l.phone ? esc(l.phone) : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-email">${l.email ? `<a href="mailto:${esc(l.email)}" style="color:var(--accent);">${esc(l.email)}</a>` : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-addr">${esc(l.address)}</td>
            <td class="lead-web">${l.website ? `<a href="${esc(l.website)}" target="_blank" title="${esc(l.website)}">${esc(l.website.replace(/^https?:\/\/(www\.)?/,'').split('/')[0])}</a>` : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-service"><span class="pill purple">${esc(l.serviceType)}</span></td>
        </tr>
    `).join('');

    document.getElementById('leadCount').textContent = `${leads.length} business${leads.length === 1 ? '' : 'es'} found`;
    document.getElementById('leadResults').style.display = 'block';
}

async function saveLeadsToDb() {
    if (!leadsData.length) return;
    const city = document.getElementById('leadCity').value.trim();
    const btn = document.getElementById('leadSaveBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Saving‚Ä¶';
    try {
        const res = await fetch(`${API_BASE}/admin/leads/save`, {
            method: 'POST',
            headers: { 'x-admin-key': adminKey, 'Content-Type': 'application/json' },
            body: JSON.stringify({ leads: leadsData, city })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        btn.textContent = `‚úÖ ${data.saved} saved!`;
        setTimeout(() => { btn.disabled = false; btn.textContent = 'Ôºã Save to My Leads'; }, 2500);
        // Update badge
        refreshSavedBadge();
    } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Ôºã Save to My Leads';
        setLeadStatus(`‚ùå Save failed: ${err.message}`);
    }
}

async function refreshSavedBadge() {
    try {
        const res = await fetch(`${API_BASE}/admin/leads/saved`, { headers: { 'x-admin-key': adminKey } });
        const data = await res.json();
        if (data.success) {
            const badge = document.getElementById('leadSavedBadge');
            badge.textContent = data.total;
            badge.style.display = data.total ? 'inline-block' : 'none';
        }
    } catch { /* silent */ }
}

async function loadSavedLeads() {
    const status   = document.getElementById('savedFilterStatus').value;
    const city     = document.getElementById('savedFilterCity').value.trim();
    const service  = document.getElementById('savedFilterService').value;
    setSavedStatus('Loading‚Ä¶', true);
    try {
        const params = new URLSearchParams();
        if (status)  params.set('status', status);
        if (city)    params.set('city', city);
        if (service) params.set('serviceType', service);
        const res = await fetch(`${API_BASE}/admin/leads/saved?${params}`, {
            headers: { 'x-admin-key': adminKey }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        document.getElementById('savedLeadsStatus').style.display = 'none';
        renderSavedLeads(data.leads);
        document.getElementById('savedLeadsCount').textContent = `${data.total} lead${data.total === 1 ? '' : 's'}`;
        // Sync badge
        const badge = document.getElementById('leadSavedBadge');
        badge.textContent = data.total;
        badge.style.display = data.total ? 'inline-block' : 'none';
    } catch (err) {
        setSavedStatus(`‚ùå ${err.message}`);
    }
}

const STATUS_LABELS = { new: 'New', contacted: 'Contacted', interested: 'Interested', onboarded: 'Onboarded', rejected: 'Rejected' };

function renderSavedLeads(leads) {
    const tbody = document.getElementById('savedLeadsBody');
    if (!leads.length) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text3);">No leads found. Use the Search tab to find and save businesses.</td></tr>`;
        return;
    }
    tbody.innerHTML = leads.map((l, i) => `
        <tr id="srow-${esc(l._id)}">
            <td>${i + 1}</td>
            <td class="lead-name">${esc(l.businessName)}</td>
            <td><input class="lead-contact-input" placeholder="Enter name‚Ä¶" value="${esc(l.contactName)}"
                onchange="updateLeadField('${esc(l._id)}','contactName',this.value)"></td>
            <td class="lead-phone">${l.phone ? esc(l.phone) : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-email">${l.email ? `<a href="mailto:${esc(l.email)}" style="color:var(--accent);">${esc(l.email)}</a>` : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-addr" style="font-size:12px;color:var(--text2);">${esc(l.city || '')}</td>
            <td class="lead-service"><span class="pill purple">${esc(l.serviceType)}</span></td>
            <td>
                <select class="lead-status-select s-${esc(l.status)}" onchange="updateLeadField('${esc(l._id)}','status',this.value);this.className='lead-status-select s-'+this.value">
                    ${Object.entries(STATUS_LABELS).map(([v,lab]) => `<option value="${v}"${l.status===v?' selected':''}>${lab}</option>`).join('')}
                </select>
            </td>
            <td><input class="lead-notes-input" placeholder="Add notes‚Ä¶" value="${esc(l.notes)}"
                onchange="updateLeadField('${esc(l._id)}','notes',this.value)"></td>
            <td><button class="lead-delete-btn" onclick="deleteLead('${esc(l._id)}',this)" title="Delete lead">‚úï</button></td>
        </tr>
    `).join('');
}

async function updateLeadField(id, field, value) {
    try {
        await fetch(`${API_BASE}/admin/leads/saved/${id}`, {
            method: 'PATCH',
            headers: { 'x-admin-key': adminKey, 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
        });
    } catch { /* silent ‚Äî UI already updated */ }
}

async function deleteLead(id, btn) {
    if (!confirm('Delete this lead?')) return;
    try {
        const res = await fetch(`${API_BASE}/admin/leads/saved/${id}`, {
            method: 'DELETE',
            headers: { 'x-admin-key': adminKey }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        const row = document.getElementById(`srow-${id}`);
        if (row) row.remove();
        // recount
        const rows = document.querySelectorAll('#savedLeadsBody tr[id^="srow-"]');
        document.getElementById('savedLeadsCount').textContent = `${rows.length} lead${rows.length === 1 ? '' : 's'}`;
        const badge = document.getElementById('leadSavedBadge');
        badge.textContent = rows.length;
        badge.style.display = rows.length ? 'inline-block' : 'none';
    } catch (err) {
        alert(`Delete failed: ${err.message}`);
    }
}

function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function exportLeadsCSV() {
    if (!leadsData.length) return;
    const headers = ['#','Business Name','Contact Name','Phone','Email','Address','Website','Service Type'];
    const rows = leadsData.map((l, i) => [
        i + 1, l.businessName, l.contactName, l.phone, l.email, l.address, l.website, l.serviceType
    ]);
    const csv = [headers, ...rows].map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const city = document.getElementById('leadCity').value.trim().replace(/\s+/g, '_') || 'leads';
    a.href = url;
    a.download = `slowday_leads_${city}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
