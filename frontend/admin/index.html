<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SlowDay ‚Äî Back Office</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@twilio/voice-sdk@2.12.2/dist/twilio.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #18181f;
    --border: rgba(255,255,255,0.07);
    --border-bright: rgba(255,255,255,0.13);
    --accent: #7c5cfc;
    --accent2: #fc5c7d;
    --green: #22d3a0;
    --yellow: #f5c842;
    --red: #fc5c5c;
    --text: #f0f0f8;
    --text2: #8888aa;
    --text3: #4a4a6a;
    --mono: 'DM Mono', monospace;
    --sans: 'DM Sans', sans-serif;
}

body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
}

/* LOGIN SCREEN */
#loginScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: var(--bg);
    position: relative;
}
#loginScreen::before {
    content: '';
    position: absolute;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(124,92,252,0.15) 0%, transparent 70%);
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
}

.login-box {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: 20px;
    padding: 48px 40px;
    width: 380px;
    position: relative;
    z-index: 1;
}
.login-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 32px;
}
.login-logo-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
}
.login-logo-icon img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 10px;
}
.login-logo-text {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
}
.login-logo-text span {
    color: var(--text2);
    font-weight: 400;
    font-size: 13px;
    display: block;
    font-family: var(--mono);
    letter-spacing: 1px;
    text-transform: uppercase;
}
.login-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
.login-sub { color: var(--text2); font-size: 14px; margin-bottom: 28px; }

.login-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text2);
    margin-bottom: 8px;
}
.login-field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 20px;
}
.login-field input:focus { border-color: var(--accent); }
.login-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), #5a3dcc);
    border: none;
    border-radius: 10px;
    padding: 13px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    font-family: var(--sans);
}
.login-btn:hover { opacity: 0.85; }
.login-error {
    background: rgba(252,92,92,0.1);
    border: 1px solid rgba(252,92,92,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 13px;
    color: var(--red);
    margin-bottom: 16px;
    display: none;
}

/* DASHBOARD */
#dashboard { display: none; min-height: 100vh; }

/* SIDEBAR */
.sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    padding: 24px 0;
    transition: width 0.25s ease;
    overflow: hidden;
}
.sidebar.collapsed { width: 62px; }
.sidebar-logo {
    display: flex; align-items: center; gap: 10px;
    padding: 0 20px 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
    white-space: nowrap;
}
.sidebar-logo-icon {
    width: 34px; height: 34px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
}
.sidebar-logo-icon img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 8px;
}
.sidebar-logo-text { font-size: 15px; font-weight: 700; white-space: nowrap; }
.sidebar-logo-text span {
    display: block;
    font-family: var(--mono);
    font-size: 9px;
    color: var(--text2);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: 400;
    margin-top: 1px;
}
.sidebar.collapsed .sidebar-logo-text { display: none; }
.sidebar-toggle {
    position: absolute;
    top: 24px;
    right: -14px;
    width: 28px; height: 28px;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    color: var(--text2);
    font-size: 14px;
    z-index: 101;
    transition: all 0.2s;
}
.sidebar-toggle:hover { color: var(--text); background: var(--accent); border-color: var(--accent); }
.sidebar.collapsed .sidebar-toggle { transform: rotate(180deg); }
.nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px;
    color: var(--text2);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border-radius: 0;
    transition: all 0.15s;
    border-left: 3px solid transparent;
    margin: 1px 0;
    white-space: nowrap;
    overflow: hidden;
}
.nav-item:hover { color: var(--text); background: rgba(255,255,255,0.04); }
.nav-item.active { color: var(--text); background: rgba(124,92,252,0.1); border-left-color: var(--accent); }
.nav-icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }
.nav-text { transition: opacity 0.2s; }
.sidebar.collapsed .nav-text { opacity: 0; }
.sidebar.collapsed .nav-badge { display: none !important; }

.sidebar-bottom {
    margin-top: auto;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    white-space: nowrap;
    overflow: hidden;
}
.sidebar.collapsed #staffNameDisplay { display: none; }
.sidebar.collapsed .logout-text { display: none; }
.logout-btn {
    display: flex; align-items: center; gap: 8px;
    color: var(--text2);
    cursor: pointer;
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.15s;
    background: none; border: none; width: 100%;
    font-family: var(--sans);
    white-space: nowrap;
    overflow: hidden;
}
.logout-btn:hover { color: var(--red); background: rgba(252,92,92,0.1); }

/* MAIN CONTENT */
.main {
    margin-left: 220px;
    padding: 32px 36px;
    min-height: 100vh;
    transition: margin-left 0.25s ease;
}
.sidebar.collapsed ~ .main { margin-left: 62px; }
.page { display: none; }
.page.active { display: block; }

.page-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 32px;
}
.page-title { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
.page-sub { color: var(--text2); font-size: 14px; margin-top: 4px; }
.refresh-btn {
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 10px;
    padding: 8px 16px;
    color: var(--text2);
    font-size: 13px;
    cursor: pointer;
    font-family: var(--sans);
    transition: all 0.15s;
    display: flex; align-items: center; gap: 6px;
}
.refresh-btn:hover { color: var(--text); border-color: var(--accent); }

/* STAT CARDS */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
}
.stat-card:hover { border-color: var(--border-bright); }
.stat-card::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 80px; height: 80px;
    border-radius: 50%;
    opacity: 0.08;
}
.stat-card.purple::before { background: var(--accent); }
.stat-card.pink::before { background: var(--accent2); }
.stat-card.green::before { background: var(--green); }
.stat-card.yellow::before { background: var(--yellow); }

.stat-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text2);
    margin-bottom: 10px;
}
.stat-value {
    font-size: 32px;
    font-weight: 700;
    font-family: var(--mono);
    letter-spacing: -1px;
    line-height: 1;
    margin-bottom: 6px;
}
.stat-value.purple { color: var(--accent); }
.stat-value.green { color: var(--green); }
.stat-value.yellow { color: var(--yellow); }
.stat-value.pink { color: var(--accent2); }
.stat-change {
    font-size: 12px;
    color: var(--text3);
    font-family: var(--mono);
}

/* SECTION HEADERS */
.section-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text2);
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
}
.section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
}

/* TABLE */
.table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 28px;
}
.table-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}
.table-title { font-size: 14px; font-weight: 600; }
.table-count {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text2);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
thead th {
    padding: 10px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
}
tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(255,255,255,0.02); }
tbody td {
    padding: 12px 16px;
    color: var(--text2);
    vertical-align: middle;
}
tbody td.bold { color: var(--text); font-weight: 500; }
tbody td.mono { font-family: var(--mono); font-size: 12px; }

/* CATEGORY ACCORDION */
.category-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 16px;
    overflow: hidden;
}
.category-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    cursor: pointer;
    transition: background 0.15s;
    user-select: none;
}
.category-header:hover { background: rgba(255,255,255,0.03); }
.category-header-left { display: flex; align-items: center; gap: 12px; }
.category-icon { font-size: 22px; }
.category-name { font-size: 15px; font-weight: 600; }
.category-providers { font-size: 12px; color: var(--text2); margin-top: 2px; font-family: var(--mono); }
.category-badge {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    background: rgba(124,92,252,0.15);
    color: var(--accent);
    border: 1px solid rgba(124,92,252,0.25);
}
.chevron { color: var(--text3); font-size: 12px; transition: transform 0.2s; }
.category-block.open .chevron { transform: rotate(180deg); }
.category-body { display: none; border-top: 1px solid var(--border); }
.category-block.open .category-body { display: block; }

.provider-row {
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
}
.provider-row:last-child { border-bottom: none; }
.provider-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.provider-location { font-size: 12px; color: var(--text2); margin-bottom: 12px; }
.deal-status {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
    margin-bottom: 12px;
}
.deal-status.active { background: rgba(34,211,160,0.12); color: var(--green); border: 1px solid rgba(34,211,160,0.25); }
.deal-status.inactive { background: rgba(252,92,92,0.1); color: var(--red); border: 1px solid rgba(252,92,92,0.2); }

/* SLOT MINI TABLE */
.slot-table { width: 100%; border-collapse: collapse; font-size: 12px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
.slot-table th { padding: 7px 12px; text-align: left; font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); }
.slot-table td { padding: 8px 12px; color: var(--text2); border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
.slot-table tr:last-child td { border-bottom: none; }
.slot-table tr:hover td { background: rgba(255,255,255,0.02); }

.slot-bar {
    display: flex; align-items: center; gap: 8px;
}
.slot-bar-track {
    flex: 1;
    height: 5px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    overflow: hidden;
    min-width: 60px;
}
.slot-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent);
    transition: width 0.3s;
}
.slot-bar-fill.full { background: var(--red); }
.slot-bar-fill.half { background: var(--yellow); }
.slot-bar-fill.low { background: var(--green); }

/* LOADING */
.loading {
    display: flex; align-items: center; justify-content: center;
    padding: 60px;
    color: var(--text2);
    gap: 12px;
    font-size: 14px;
}
.spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border-bright);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* PILL BADGES */
.pill {
    display: inline-block;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
}
.pill.green { background: rgba(34,211,160,0.12); color: var(--green); }
.pill.red { background: rgba(252,92,92,0.1); color: var(--red); }
.pill.yellow { background: rgba(245,200,66,0.12); color: var(--yellow); }
.pill.purple { background: rgba(124,92,252,0.15); color: var(--accent); }

/* LAST UPDATED */
.last-updated {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    margin-bottom: 24px;
}

/* TWO COL GRID */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
@media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

/* ‚îÄ‚îÄ LEAD FINDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.lead-search-box {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
}
.lead-field-row { display: flex; gap: 16px; margin-bottom: 20px; }
.lead-field { flex: 1; }
.lead-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text2);
    margin-bottom: 8px;
}
.lead-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 10px;
    padding: 11px 16px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}
.lead-input:focus { border-color: var(--accent); }
.lead-industry-actions { display: flex; gap: 8px; margin-bottom: 10px; }
.lead-toggle-btn {
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: 6px;
    color: var(--text2);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 12px;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
}
.lead-toggle-btn:hover { color: var(--accent); border-color: var(--accent); }
.lead-industries {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.lead-check {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 7px 14px;
    font-size: 13px;
    color: var(--text2);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    user-select: none;
}
.lead-check:has(input:checked) { border-color: var(--accent); color: var(--text); }
.lead-check input { accent-color: var(--accent); cursor: pointer; }
.lead-search-btn {
    margin-top: 20px;
    background: linear-gradient(135deg, var(--accent), #5a3dcc);
    border: none;
    border-radius: 10px;
    padding: 12px 28px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    font-family: var(--sans);
}
.lead-search-btn:hover { opacity: 0.85; }
.lead-search-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.lead-status {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.lead-results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    flex-wrap: wrap;
    gap: 8px;
}
.lead-count {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--green);
    font-weight: 600;
}
.lead-note {
    font-size: 12px;
    color: var(--text3);
}
.lead-table-wrap {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border);
}
.lead-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.lead-table th {
    background: var(--surface2);
    color: var(--text2);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 12px 14px;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
}
.lead-table td {
    padding: 11px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: middle;
    max-width: 200px;
}
.lead-table tr:last-child td { border-bottom: none; }
.lead-table tr:hover td { background: var(--surface2); }
.lead-table td:first-child { color: var(--text3); font-family: var(--mono); width: 40px; }
.lead-name { font-weight: 600; }
.lead-phone { font-family: var(--mono); color: var(--green); white-space: nowrap; }
.lead-email { font-family: var(--mono); font-size: 12px; color: var(--accent); word-break: break-all; }
.lead-addr { font-size: 12px; color: var(--text2); }
.lead-web a { color: var(--accent2); font-size: 12px; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 140px; }
.lead-web a:hover { text-decoration: underline; }
.lead-service { }
.lead-service .pill { font-size: 11px; }
.lead-contact-input {
    background: transparent;
    border: none;
    border-bottom: 1px dashed var(--border-bright);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    padding: 2px 4px;
    width: 100%;
    outline: none;
    min-width: 120px;
}
.lead-contact-input:focus { border-bottom-color: var(--accent); }
.lead-contact-input::placeholder { color: var(--text3); font-style: italic; }
.lead-empty { color: var(--text3); font-style: italic; }

/* LEAD TABS */
.lead-tabs {
    display: flex; gap: 4px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 4px;
    width: fit-content; margin-bottom: 24px;
}
.lead-tab-btn {
    background: none; border: none; border-radius: 9px;
    padding: 8px 22px; color: var(--text2);
    font-family: var(--sans); font-size: 14px; font-weight: 500;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; gap: 7px;
}
.lead-tab-btn:hover { color: var(--text); }
.lead-tab-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
.lead-tab-badge {
    background: var(--accent); color: white;
    font-size: 11px; font-family: var(--mono);
    padding: 1px 7px; border-radius: 20px; min-width: 20px; text-align: center;
}

/* LEAD FILTER BAR */
.lead-filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.lead-filter-select, .lead-filter-input {
    background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 8px; padding: 8px 12px;
    color: var(--text); font-family: var(--sans); font-size: 13px;
    outline: none; transition: border-color 0.2s;
}
.lead-filter-select { min-width: 150px; cursor: pointer; }
.lead-filter-input { min-width: 180px; }
.lead-filter-select:focus, .lead-filter-input:focus { border-color: var(--accent); }

/* LEAD STATUS SELECT */
.lead-status-select {
    background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 6px; padding: 4px 8px;
    color: var(--text); font-family: var(--sans); font-size: 12px;
    cursor: pointer; outline: none; width: 130px;
}
.lead-status-select.s-new       { border-color: var(--accent); color: var(--accent); }
.lead-status-select.s-contacted { border-color: var(--yellow); color: var(--yellow); }
.lead-status-select.s-interested{ border-color: var(--green);  color: var(--green);  }
.lead-status-select.s-onboarded { border-color: #9d7dff;       color: #9d7dff;       }
.lead-status-select.s-rejected  { border-color: var(--red);    color: var(--red);    }
.lead-status-select.s-live      { border-color: #00c853;       color: #00c853;       }

/* LEAD NOTES INPUT */
.lead-notes-input {
    background: none; border: none;
    border-bottom: 1px solid var(--border-bright);
    color: var(--text2); font-family: var(--sans); font-size: 12px;
    padding: 3px 0; outline: none; width: 150px; transition: border-color 0.2s;
}
.lead-notes-input:focus { border-bottom-color: var(--accent); }
.lead-notes-input::placeholder { color: var(--text3); font-style: italic; }
.lead-price-input {
    background: none; border: none;
    border-bottom: 1px solid var(--border-bright);
    color: var(--green); font-family: var(--mono); font-size: 12px;
    padding: 3px 0; outline: none; width: 70px; transition: border-color 0.2s;
}
.lead-price-input:focus { border-bottom-color: var(--green); }
.lead-price-input::placeholder { color: var(--text3); }
.lead-day-chips { display: flex; flex-wrap: wrap; gap: 3px; min-width: 160px; }
.lead-day-chip {
    font-size: 10px; font-family: var(--mono); font-weight: 600;
    padding: 2px 6px; border-radius: 4px; cursor: pointer;
    border: 1px solid var(--border-bright); color: var(--text3);
    background: none; transition: all 0.15s; user-select: none;
}
.lead-day-chip.active { background: var(--accent); border-color: var(--accent); color: white; }

/* ADD LEAD MODAL */
.lead-modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    z-index: 999; align-items: center; justify-content: center;
}
.lead-modal-overlay.open { display: flex; }
.lead-modal {
    background: var(--surface); border: 1px solid var(--border-bright);
    border-radius: 18px; padding: 32px 36px; width: 560px; max-width: 95vw;
    max-height: 90vh; overflow-y: auto;
}
.lead-modal-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px;
}
.lead-modal-title { font-size: 18px; font-weight: 700; }
.lead-modal-close {
    background: none; border: none; color: var(--text2);
    font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px;
    transition: color 0.15s;
}
.lead-modal-close:hover { color: var(--red); }
.lead-modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.lead-modal-field { display: flex; flex-direction: column; gap: 6px; }
.lead-modal-field.full { grid-column: 1 / -1; }
.lead-modal-label {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--text2);
}
.lead-modal-input {
    background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 8px; padding: 9px 12px; color: var(--text);
    font-family: var(--sans); font-size: 13px; outline: none;
    transition: border-color 0.2s;
}
.lead-modal-input:focus { border-color: var(--accent); }
.lead-modal-input::placeholder { color: var(--text3); }
.lead-modal-days { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 2px; }
.lead-modal-submit {
    width: 100%; margin-top: 24px;
    background: linear-gradient(135deg, var(--accent), #5a3dcc);
    border: none; border-radius: 10px; padding: 13px;
    color: white; font-size: 15px; font-weight: 600;
    cursor: pointer; font-family: var(--sans); transition: opacity 0.2s;
}
.lead-modal-submit:hover { opacity: 0.85; }
.lead-modal-submit:disabled { opacity: 0.45; cursor: not-allowed; }
.lead-add-btn {
    background: var(--accent); border: none; border-radius: 8px;
    padding: 8px 14px; color: white; font-size: 18px; font-weight: 600;
    cursor: pointer; line-height: 1; transition: opacity 0.15s;
}
.lead-add-btn:hover { opacity: 0.85; }

/* LEAD SAVE + DELETE */
.lead-save-btn {
    background: linear-gradient(135deg, var(--green), #0fa87a);
    border: none; border-radius: 8px; padding: 8px 18px;
    color: #051a10; font-size: 13px; font-weight: 600;
    cursor: pointer; font-family: var(--sans); transition: opacity 0.2s;
    display: flex; align-items: center; gap: 6px;
}
.lead-save-btn:hover { opacity: 0.85; }
.lead-save-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.lead-delete-btn {
    background: none; border: none; color: var(--text3);
    cursor: pointer; padding: 4px 6px; border-radius: 4px;
    font-size: 15px; transition: color 0.15s; line-height: 1;
}
.lead-delete-btn:hover { color: var(--red); }
.lead-saved-count { font-size: 13px; color: var(--text2); margin-left: auto; }

/* LEAD PHOTOS */
.lead-photos-grid { display: flex; gap: 4px; flex-wrap: wrap; min-width: 100px; }
.lead-photo-thumb { position: relative; width: 40px; height: 40px; border-radius: 4px; overflow: hidden; }
.lead-photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
.lead-photo-remove {
    position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff;
    border: none; cursor: pointer; font-size: 10px; width: 16px; height: 16px;
    display: flex; align-items: center; justify-content: center; border-radius: 0 4px 0 4px;
    opacity: 0; transition: opacity 0.15s;
}
.lead-photo-thumb:hover .lead-photo-remove { opacity: 1; }
.lead-photo-add {
    width: 40px; height: 40px; border-radius: 4px; border: 2px dashed var(--border);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    color: var(--text3); font-size: 18px; transition: border-color 0.15s;
}
.lead-photo-add:hover { border-color: var(--accent); color: var(--accent); }

/* CALL BUTTON */
.call-btn {
    background: rgba(34,211,160,0.15); border: 1px solid rgba(34,211,160,0.3);
    border-radius: 8px; padding: 5px 10px; color: var(--green);
    cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;
    text-decoration: none; transition: all 0.15s; font-family: var(--sans);
}
.call-btn:hover { background: rgba(34,211,160,0.25); }
.call-count-badge {
    background: var(--accent); color: white; font-size: 10px; font-family: var(--mono);
    padding: 1px 6px; border-radius: 10px; cursor: pointer; margin-left: 4px;
}

/* EMAIL BUTTON */
.email-send-btn {
    background: rgba(102,126,234,0.15); border: 1px solid rgba(102,126,234,0.3);
    border-radius: 8px; padding: 5px 10px; color: var(--accent);
    cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;
    text-decoration: none; transition: all 0.15s; font-family: var(--sans);
}
.email-send-btn:hover { background: rgba(102,126,234,0.25); }
.email-count-badge {
    background: #9d7dff; color: white; font-size: 10px; font-family: var(--mono);
    padding: 1px 6px; border-radius: 10px; cursor: pointer; margin-left: 4px;
}

/* CALL MODAL */
.call-modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
    z-index: 9999; align-items: center; justify-content: center;
}
.call-modal-overlay.open { display: flex; }
.call-modal {
    background: var(--surface); border: 1px solid var(--border-bright);
    border-radius: 20px; padding: 0; width: 380px; max-width: 95vw;
    overflow: hidden;
}
.call-modal-header {
    background: linear-gradient(135deg, #22d3a0, #1ab394);
    padding: 28px 24px 20px; text-align: center;
}
.call-modal-header.ended { background: linear-gradient(135deg, var(--surface2), var(--surface)); }
.call-modal-header.failed { background: linear-gradient(135deg, #fc5c5c, #e04444); }
.call-modal-avatar {
    width: 56px; height: 56px; border-radius: 50%;
    background: rgba(255,255,255,0.2); display: flex;
    align-items: center; justify-content: center;
    font-size: 22px; margin: 0 auto 12px; color: white; font-weight: 700;
}
.call-modal-name { font-size: 18px; font-weight: 700; color: white; }
.call-modal-phone { font-size: 13px; color: rgba(255,255,255,0.7); margin-top: 4px; }
.call-modal-status {
    font-size: 12px; color: rgba(255,255,255,0.6);
    margin-top: 8px; font-family: var(--mono);
}
.call-modal-timer {
    font-size: 28px; font-weight: 700; color: white;
    font-family: var(--mono); margin-top: 8px; letter-spacing: 2px;
}
.call-controls {
    display: flex; gap: 16px; justify-content: center; padding: 20px 0 24px;
}
.call-control-btn {
    width: 52px; height: 52px; border-radius: 50%;
    border: none; cursor: pointer; font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
}
.call-control-btn.mute {
    background: var(--surface2); border: 1px solid var(--border-bright); color: var(--text);
}
.call-control-btn.mute.active { background: var(--yellow); color: #000; }
.call-control-btn.hangup {
    background: var(--red); color: white; width: 60px; height: 60px; font-size: 24px;
}
.call-control-btn.hangup:hover { background: #e04444; }
.call-notes-area { display: none; padding: 20px 24px; }
.call-notes-area.show { display: block; }
.call-notes-textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 10px; padding: 12px 14px; color: var(--text);
    font-family: var(--sans); font-size: 13px; outline: none;
    height: 80px; resize: none; margin-bottom: 12px;
}
.call-notes-textarea:focus { border-color: var(--accent); }
.call-notes-save {
    background: var(--accent); border: none; border-radius: 10px;
    padding: 10px 20px; color: white; font-size: 13px;
    font-weight: 600; cursor: pointer; width: 100%; font-family: var(--sans);
}
.call-notes-save:hover { opacity: 0.9; }

/* CALL HISTORY */
.call-history-panel {
    background: var(--surface); border: 1px solid var(--border-bright);
    border-radius: 14px; padding: 16px;
}
.call-history-title {
    font-size: 13px; font-weight: 600; color: var(--text2);
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
}
.call-history-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 10px 0; border-bottom: 1px solid var(--border);
}
.call-history-item:last-child { border-bottom: none; }
.call-history-icon {
    width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; flex-shrink: 0;
}
.call-history-icon.completed { background: rgba(34,211,160,0.15); color: var(--green); }
.call-history-icon.failed { background: rgba(252,92,92,0.15); color: var(--red); }
.call-history-meta { flex: 1; min-width: 0; }
.call-history-date { font-size: 12px; color: var(--text3); font-family: var(--mono); }
.call-history-info { font-size: 12px; color: var(--text2); margin-top: 2px; }
.call-history-info span { margin-right: 10px; }
.call-history-notes {
    font-size: 12px; color: var(--text); margin-top: 4px;
    font-style: italic; opacity: 0.8;
}

/* ASSIGNEE SELECT */
.lead-assignee-select {
    background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 6px; padding: 4px 8px; color: var(--text2);
    font-family: var(--sans); font-size: 12px; cursor: pointer; outline: none; width: 130px;
}

/* SUPPORT TAB */
.ticket-filters {
    display: flex; gap: 4px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 4px; width: fit-content; margin-bottom: 24px;
}
.ticket-filter-btn {
    background: none; border: none; border-radius: 9px; padding: 8px 18px;
    color: var(--text2); font-family: var(--sans); font-size: 13px; font-weight: 500;
    cursor: pointer; transition: all 0.15s;
}
.ticket-filter-btn:hover { color: var(--text); }
.ticket-filter-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
.ticket-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
    padding: 20px; margin-bottom: 12px; cursor: pointer; transition: border-color 0.15s;
}
.ticket-card:hover { border-color: var(--border-bright); }
.ticket-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.ticket-subject { font-weight: 600; font-size: 15px; }
.ticket-status-pill {
    font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 20px; font-family: var(--mono);
}
.ticket-status-pill.open { background: rgba(245,200,66,0.12); color: var(--yellow); }
.ticket-status-pill.in_progress { background: rgba(124,92,252,0.15); color: var(--accent); }
.ticket-status-pill.resolved { background: rgba(34,211,160,0.12); color: var(--green); }
.ticket-meta { font-size: 12px; color: var(--text3); margin-bottom: 8px; font-family: var(--mono); }
.ticket-preview { font-size: 13px; color: var(--text2); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.ticket-detail {
    background: var(--surface); border: 1px solid var(--border-bright); border-radius: 16px;
    padding: 28px; margin-bottom: 24px;
}
.ticket-detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
.ticket-detail-back {
    background: var(--surface2); border: 1px solid var(--border-bright); border-radius: 8px;
    padding: 6px 14px; color: var(--text2); cursor: pointer; font-size: 13px;
    font-family: var(--sans); transition: color 0.15s;
}
.ticket-detail-back:hover { color: var(--text); }
.ticket-detail-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; }
.ticket-detail-controls select {
    background: var(--surface2); border: 1px solid var(--border-bright); border-radius: 8px;
    padding: 8px 12px; color: var(--text); font-family: var(--sans); font-size: 13px; outline: none;
}
.ticket-reply {
    background: var(--surface2); border-radius: 10px; padding: 14px; margin-bottom: 10px;
}
.ticket-reply-author { font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
.ticket-reply-date { font-size: 11px; color: var(--text3); font-family: var(--mono); }
.ticket-reply-msg { font-size: 13px; color: var(--text); line-height: 1.5; margin-top: 6px; }
.ticket-reply-form { margin-top: 20px; }
.ticket-reply-form textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border-bright);
    border-radius: 10px; padding: 12px; color: var(--text); font-family: var(--sans);
    font-size: 14px; outline: none; height: 100px; resize: none; margin-bottom: 10px; box-sizing: border-box;
}
.ticket-reply-submit {
    background: linear-gradient(135deg, var(--accent), #5a3dcc); border: none; border-radius: 10px;
    padding: 10px 24px; color: white; font-size: 14px; font-weight: 600;
    cursor: pointer; font-family: var(--sans);
}

/* EMPLOYEES TAB */
.staff-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
    padding: 16px 20px; margin-bottom: 10px; transition: border-color 0.15s;
}
.staff-card:hover { border-color: var(--border-bright); }
.staff-info { display: flex; align-items: center; gap: 14px; }
.staff-avatar {
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center;
    justify-content: center; font-size: 18px; font-weight: 700; color: white;
}
.staff-name { font-weight: 600; font-size: 14px; }
.staff-email { font-size: 12px; color: var(--text2); font-family: var(--mono); }
.staff-role-pill {
    font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 20px; font-family: var(--mono);
}
.staff-role-pill.super_admin { background: rgba(252,92,125,0.15); color: var(--accent2); }
.staff-role-pill.admin { background: rgba(124,92,252,0.15); color: var(--accent); }
.staff-role-pill.sales { background: rgba(34,211,160,0.12); color: var(--green); }
.staff-role-pill.support { background: rgba(245,200,66,0.12); color: var(--yellow); }
.staff-actions { display: flex; align-items: center; gap: 10px; }
.staff-remove-btn {
    background: none; border: none; color: var(--text3); cursor: pointer;
    font-size: 15px; padding: 4px 8px; border-radius: 6px; transition: color 0.15s;
}
.staff-remove-btn:hover { color: var(--red); }
.staff-invited-pill {
    font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 20px;
    background: rgba(255,255,255,0.06); color: var(--text3); font-family: var(--mono);
}
.nav-badge {
    background: var(--accent2); color: white; font-size: 10px; font-family: var(--mono);
    padding: 1px 6px; border-radius: 10px; min-width: 18px; text-align: center; margin-left: auto;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-box" id="loginBox">
        <div class="login-logo">
            <div class="login-logo-icon"><img src="../apple-touch-icon.png" alt="SlowDay" /></div>
            <div class="login-logo-text">SlowDay <span>Back Office</span></div>
        </div>
        <div class="login-title" id="loginTitle">Welcome Back</div>
        <div class="login-sub" id="loginSub">Sign in to your account</div>
        <div class="login-error" id="loginError"></div>
        <div class="login-field">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="you@example.com" onkeydown="if(event.key==='Enter')document.getElementById('loginPass').focus()">
        </div>
        <div class="login-field">
            <label>Password</label>
            <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="login-btn" id="loginBtn" onclick="doLogin()">Sign In ‚Üí</button>
        <div id="setupLink" style="text-align:center;margin-top:16px;display:none;">
            <span style="font-size:13px;color:var(--text3);cursor:pointer;" onclick="showSetupForm()">First time? Set up your admin account ‚Üí</span>
        </div>
    </div>
    <!-- SETUP FORM (one-time super admin creation) -->
    <div class="login-box" id="setupBox" style="display:none;">
        <div class="login-logo">
            <div class="login-logo-icon"><img src="../apple-touch-icon.png" alt="SlowDay" /></div>
            <div class="login-logo-text">SlowDay <span>Back Office</span></div>
        </div>
        <div class="login-title">Create Admin Account</div>
        <div class="login-sub">One-time setup for the super admin</div>
        <div class="login-error" id="setupError"></div>
        <div class="login-field">
            <label>Your Name</label>
            <input type="text" id="setupName" placeholder="Your full name">
        </div>
        <div class="login-field">
            <label>Email</label>
            <input type="email" id="setupEmail" placeholder="you@example.com">
        </div>
        <div class="login-field">
            <label>Password</label>
            <input type="password" id="setupPass" placeholder="At least 6 characters" onkeydown="if(event.key==='Enter')doSetup()">
        </div>
        <button class="login-btn" onclick="doSetup()">Create Account ‚Üí</button>
        <div style="text-align:center;margin-top:16px;">
            <span style="font-size:13px;color:var(--text3);cursor:pointer;" onclick="showLoginForm()">‚Üê Back to login</span>
        </div>
    </div>
    <!-- INVITE ACCEPTANCE FORM -->
    <div class="login-box" id="inviteBox" style="display:none;">
        <div class="login-logo">
            <div class="login-logo-icon"><img src="../apple-touch-icon.png" alt="SlowDay" /></div>
            <div class="login-logo-text">SlowDay <span>Back Office</span></div>
        </div>
        <div class="login-title">Set Your Password</div>
        <div class="login-sub">You've been invited to join the team</div>
        <div class="login-error" id="inviteError"></div>
        <div class="login-field">
            <label>Password</label>
            <input type="password" id="invitePass" placeholder="At least 6 characters" onkeydown="if(event.key==='Enter')doAcceptInvite()">
        </div>
        <div class="login-field">
            <label>Confirm Password</label>
            <input type="password" id="invitePass2" placeholder="Re-enter password" onkeydown="if(event.key==='Enter')doAcceptInvite()">
        </div>
        <button class="login-btn" onclick="doAcceptInvite()">Activate Account ‚Üí</button>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">‚óÄ</div>
        <div class="sidebar-logo">
            <div class="sidebar-logo-icon"><img src="../apple-touch-icon.png" alt="SlowDay" /></div>
            <div class="sidebar-logo-text">SlowDay <span>Back Office</span></div>
        </div>
        <div class="nav-item active" onclick="showPage('overview')" id="nav-overview">
            <span class="nav-icon">üìä</span> <span class="nav-text">Overview</span>
        </div>
        <div class="nav-item" onclick="showPage('categories')" id="nav-categories">
            <span class="nav-icon">üóÇÔ∏è</span> <span class="nav-text">Categories & Slots</span>
        </div>
        <div class="nav-item" onclick="showPage('users')" id="nav-users">
            <span class="nav-icon">üë•</span> <span class="nav-text">Users</span>
        </div>
        <div class="nav-item" onclick="showPage('bookings')" id="nav-bookings">
            <span class="nav-icon">üìÖ</span> <span class="nav-text">Bookings</span>
        </div>
        <div class="nav-item" onclick="showPage('leads')" id="nav-leads">
            <span class="nav-icon">üéØ</span> <span class="nav-text">Lead Finder</span>
        </div>
        <div class="nav-item" onclick="showPage('support')" id="nav-support" style="display:none;">
            <span class="nav-icon">üé´</span> <span class="nav-text">Support</span>
            <span class="nav-badge" id="supportBadge" style="display:none;">0</span>
        </div>
        <div class="nav-item" onclick="showPage('employees')" id="nav-employees" style="display:none;">
            <span class="nav-icon">üë§</span> <span class="nav-text">Employees</span>
        </div>
        <div class="sidebar-bottom">
            <div id="staffNameDisplay" style="font-size:12px;color:var(--text2);margin-bottom:10px;padding:0 4px;"></div>
            <button class="logout-btn" onclick="doLogout()">üö™ <span class="logout-text">Sign Out</span></button>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main">

        <!-- OVERVIEW PAGE -->
        <div class="page active" id="page-overview">
            <div class="page-header">
                <div>
                    <div class="page-title">Overview</div>
                    <div class="page-sub">Platform health at a glance</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div class="last-updated" id="lastUpdated">Loading...</div>

            <div class="section-title">Application Usage</div>
            <div class="stats-grid" id="usageStats">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>

            <div class="section-title">User Breakdown</div>
            <div class="stats-grid" id="userStats">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>

            <div class="section-title">Bookings & Revenue</div>
            <div class="stats-grid" id="bookingStats">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- CATEGORIES & SLOTS PAGE -->
        <div class="page" id="page-categories">
            <div class="page-header">
                <div>
                    <div class="page-title">Categories & Slots</div>
                    <div class="page-sub">Service deals grouped by category with slot availability</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="categoriesContent">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- USERS PAGE -->
        <div class="page" id="page-users">
            <div class="page-header">
                <div>
                    <div class="page-title">User Analytics</div>
                    <div class="page-sub">Active users and growth metrics</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="usersContent">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- BOOKINGS PAGE -->
        <div class="page" id="page-bookings">
            <div class="page-header">
                <div>
                    <div class="page-title">Booking Analytics</div>
                    <div class="page-sub">Booking volume and revenue tracking</div>
                </div>
                <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
            </div>
            <div id="bookingsContent">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>

        <!-- LEAD FINDER PAGE -->
        <div class="page" id="page-leads">
            <div class="page-header">
                <div>
                    <div class="page-title">Lead Finder</div>
                    <div class="page-sub">Find &amp; track outreach to local service businesses</div>
                </div>
            </div>

            <!-- Tab switcher -->
            <div class="lead-tabs">
                <button class="lead-tab-btn active" id="leadTabSearch" onclick="switchLeadTab('search')">Search</button>
                <button class="lead-tab-btn" id="leadTabSaved" onclick="switchLeadTab('saved')">
                    My Leads
                    <span class="lead-tab-badge" id="leadSavedBadge" style="display:none">0</span>
                </button>
            </div>

            <!-- ‚îÄ‚îÄ SEARCH VIEW ‚îÄ‚îÄ -->
            <div id="leadSearchView">
                <div class="lead-search-box">
                    <div class="lead-field-row">
                        <div class="lead-field">
                            <label class="lead-label">Town / City</label>
                            <input type="text" id="leadCity" placeholder="e.g. Toronto, ON" class="lead-input" onkeydown="if(event.key==='Enter')searchLeads()">
                        </div>
                    </div>
                    <div class="lead-field">
                        <label class="lead-label">Industries</label>
                        <div class="lead-industry-actions">
                            <button class="lead-toggle-btn" onclick="selectAllIndustries()">Select All</button>
                            <button class="lead-toggle-btn" onclick="clearAllIndustries()">Clear</button>
                        </div>
                        <div class="lead-industries" id="leadIndustries">
                            <label class="lead-check"><input type="checkbox" value="Haircut" checked> Haircut</label>
                            <label class="lead-check"><input type="checkbox" value="Barber" checked> Barber</label>
                            <label class="lead-check"><input type="checkbox" value="Cleaning Service" checked> Cleaning Service</label>
                            <label class="lead-check"><input type="checkbox" value="Massage" checked> Massage</label>
                            <label class="lead-check"><input type="checkbox" value="Nail Service" checked> Nail Service</label>
                            <label class="lead-check"><input type="checkbox" value="Spa Treatment" checked> Spa Treatment</label>
                            <label class="lead-check"><input type="checkbox" value="Personal Training" checked> Personal Training</label>
                            <label class="lead-check"><input type="checkbox" value="Dog Walking" checked> Dog Walking</label>
                            <label class="lead-check"><input type="checkbox" value="Tutoring" checked> Tutoring</label>
                            <label class="lead-check"><input type="checkbox" value="Photography" checked> Photography</label>
                            <label class="lead-check"><input type="checkbox" value="Car Detailing" checked> Car Detailing</label>
                            <label class="lead-check"><input type="checkbox" value="Laundry Service" checked> Laundry Service</label>
                        </div>
                    </div>
                    <button class="lead-search-btn" onclick="searchLeads()" id="leadSearchBtn">üîç Find Leads</button>
                </div>

                <div id="leadStatus" class="lead-status" style="display:none;"></div>

                <div id="leadResults" style="display:none;">
                    <div class="lead-results-header">
                        <span id="leadCount" class="lead-count"></span>
                        <div style="display:flex;align-items:center;gap:10px;margin-left:auto;">
                            <button class="lead-save-btn" id="leadSaveBtn" onclick="saveLeadsToDb()">Ôºã Save to My Leads</button>
                            <button class="refresh-btn" id="leadExportBtn" onclick="exportLeadsCSV()">‚Üì CSV</button>
                        </div>
                    </div>
                    <div class="lead-table-wrap">
                        <table class="lead-table" id="leadTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Business Name</th>
                                    <th>Contact Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Website</th>
                                    <th>Service</th>
                                </tr>
                            </thead>
                            <tbody id="leadTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ MY LEADS VIEW ‚îÄ‚îÄ -->
            <div id="leadSavedView" style="display:none;">
                <div class="lead-filter-bar">
                    <select class="lead-filter-select" id="savedFilterStatus" onchange="loadSavedLeads()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="interested">Interested</option>
                        <option value="onboarded">Onboarded</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <input class="lead-filter-input" id="savedFilterCity" placeholder="Filter by city‚Ä¶" onkeydown="if(event.key==='Enter')loadSavedLeads()">
                    <select class="lead-filter-select" id="savedFilterService" onchange="loadSavedLeads()">
                        <option value="">All Services</option>
                        <option>Haircut</option><option>Barber</option>
                        <option>Cleaning Service</option><option>Massage</option>
                        <option>Nail Service</option><option>Spa Treatment</option>
                        <option>Personal Training</option><option>Dog Walking</option>
                        <option>Tutoring</option><option>Photography</option>
                        <option>Car Detailing</option><option>Laundry Service</option>
                    </select>
                    <select class="lead-filter-select" id="savedFilterAssignee" onchange="loadSavedLeads()">
                        <option value="">All People</option>
                    </select>
                    <button class="lead-toggle-btn" onclick="loadSavedLeads()">Apply</button>
                    <span class="lead-saved-count" id="savedLeadsCount"></span>
                    <button class="lead-add-btn" onclick="openAddLeadModal()" title="Add lead manually">Ôºã</button>
                </div>
                <div id="savedLeadsStatus" class="lead-status" style="display:none;"></div>
                <div class="lead-table-wrap">
                    <table class="lead-table" id="savedLeadsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Business Name</th>
                                <th>Contact Name</th>
                                <th>Phone</th>
                                <th>Call</th>
                                <th>Email</th>
                                <th>Send</th>
                                <th>City</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Assignee</th>
                                <th>Price</th>
                                <th>Deal Price</th>
                                <th>Days</th>
                                <th>Description</th>
                                <th>Photos</th>
                                <th>Notes</th>
                                <th>Profile</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="savedLeadsBody">
                            <tr><td colspan="19" style="text-align:center;padding:40px;color:var(--text3);">Click "My Leads" tab to load saved leads.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SUPPORT PAGE -->
        <div class="page" id="page-support">
            <div class="page-header">
                <div>
                    <div class="page-title">Support Tickets</div>
                    <div class="page-sub">Manage customer help requests</div>
                </div>
                <button class="refresh-btn" onclick="loadTickets()">‚Üª Refresh</button>
            </div>
            <div id="supportTicketDetail" style="display:none;"></div>
            <div id="supportTicketList">
                <div class="ticket-filters">
                    <button class="ticket-filter-btn active" onclick="filterTickets('')">All</button>
                    <button class="ticket-filter-btn" onclick="filterTickets('open')">Open</button>
                    <button class="ticket-filter-btn" onclick="filterTickets('in_progress')">In Progress</button>
                    <button class="ticket-filter-btn" onclick="filterTickets('resolved')">Resolved</button>
                </div>
                <div id="ticketsList">
                    <div class="loading"><div class="spinner"></div> Loading tickets...</div>
                </div>
            </div>
        </div>

        <!-- EMPLOYEES PAGE -->
        <div class="page" id="page-employees">
            <div class="page-header">
                <div>
                    <div class="page-title">Team</div>
                    <div class="page-sub">Manage back office employees and roles</div>
                </div>
                <button class="lead-search-btn" onclick="openInviteModal()">+ Invite Employee</button>
            </div>
            <div id="staffList">
                <div class="loading"><div class="spinner"></div> Loading team...</div>
            </div>
        </div>

    </div>
</div>

<!-- INVITE EMPLOYEE MODAL -->
<div class="lead-modal-overlay" id="inviteOverlay" onclick="if(event.target===this)closeInviteModal()">
    <div class="lead-modal" style="width:420px;">
        <div class="lead-modal-header">
            <div class="lead-modal-title">Invite Employee</div>
            <button class="lead-modal-close" onclick="closeInviteModal()">‚úï</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:16px;">
            <div class="lead-modal-field">
                <label class="lead-modal-label">Name</label>
                <input class="lead-modal-input" id="invName" placeholder="Full name">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Email</label>
                <input class="lead-modal-input" id="invEmail" type="email" placeholder="email@example.com">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Role</label>
                <select class="lead-modal-input" id="invRole">
                    <option value="sales">Sales</option>
                    <option value="support">Support</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
        </div>
        <button class="lead-modal-submit" id="invSubmitBtn" onclick="submitInvite()">Send Invite</button>
    </div>
</div>

<!-- ADD LEAD MODAL -->
<div class="lead-modal-overlay" id="addLeadOverlay" onclick="if(event.target===this)closeAddLeadModal()">
    <div class="lead-modal">
        <div class="lead-modal-header">
            <div class="lead-modal-title">Add Lead Manually</div>
            <button class="lead-modal-close" onclick="closeAddLeadModal()">‚úï</button>
        </div>
        <div class="lead-modal-grid">
            <div class="lead-modal-field full">
                <label class="lead-modal-label">Business Name *</label>
                <input class="lead-modal-input" id="mlBusinessName" placeholder="e.g. Tony's Barbershop">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Contact Name</label>
                <input class="lead-modal-input" id="mlContactName" placeholder="e.g. Tony Romano">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Phone</label>
                <input class="lead-modal-input" id="mlPhone" placeholder="e.g. (416) 555-0123">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Email</label>
                <input class="lead-modal-input" id="mlEmail" type="email" placeholder="e.g. tony@example.com">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">City</label>
                <input class="lead-modal-input" id="mlCity" placeholder="e.g. Toronto, ON">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Address</label>
                <input class="lead-modal-input" id="mlAddress" placeholder="e.g. 123 Main St">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Website</label>
                <input class="lead-modal-input" id="mlWebsite" placeholder="e.g. tonysbarbershop.com">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Service Type</label>
                <select class="lead-modal-input" id="mlServiceType">
                    <option value="">‚Äî Select ‚Äî</option>
                    <option>Haircut</option><option>Barber</option>
                    <option>Cleaning Service</option><option>Massage</option>
                    <option>Nail Service</option><option>Spa Treatment</option>
                    <option>Personal Training</option><option>Dog Walking</option>
                    <option>Tutoring</option><option>Photography</option>
                    <option>Car Detailing</option><option>Laundry Service</option>
                </select>
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Status</label>
                <select class="lead-modal-input" id="mlStatus">
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="interested">Interested</option>
                    <option value="onboarded">Onboarded</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Price ($)</label>
                <input class="lead-modal-input" id="mlPrice" type="number" placeholder="0.00">
            </div>
            <div class="lead-modal-field">
                <label class="lead-modal-label">Deal Price ($)</label>
                <input class="lead-modal-input" id="mlDiscountPrice" type="number" placeholder="0.00">
            </div>
            <div class="lead-modal-field full">
                <label class="lead-modal-label">Days Available</label>
                <div class="lead-modal-days" id="mlDays">
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Mon</span>
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Tue</span>
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Wed</span>
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Thu</span>
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Fri</span>
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Sat</span>
                    <span class="lead-day-chip" onclick="this.classList.toggle('active')">Sun</span>
                </div>
            </div>
            <div class="lead-modal-field full">
                <label class="lead-modal-label">Notes</label>
                <input class="lead-modal-input" id="mlNotes" placeholder="Any notes‚Ä¶">
            </div>
        </div>
        <button class="lead-modal-submit" id="mlSubmitBtn" onclick="submitManualLead()">Add Lead</button>
    </div>
</div>

<script>
const API_BASE = 'https://slowday-deals.onrender.com/api';
let authToken = sessionStorage.getItem('staffToken') || '';
let currentStaff = null;
let cachedData = null;
let staffList = []; // cached staff for assignee dropdowns
let ticketFilter = '';
let inviteToken = null;

const CATEGORY_ICONS = {
    'Haircut': '‚úÇÔ∏è', 'Barber': 'üíà', 'Cleaning': 'üßπ', 'Massage': 'üíÜ',
    'Nails': 'üíÖ', 'Spa': 'üõÅ', 'Personal Training': 'üèãÔ∏è', 'Dog Walking': 'üêï',
    'Tutoring': 'üìö', 'Photography': 'üì∑', 'Car Detailing': 'üöó',
    'Laundry Service': 'üëï', 'Other': '‚ú®'
};

// Auth header helper
function authHeaders(extra = {}) {
    const h = { 'Content-Type': 'application/json', ...extra };
    if (authToken) h['Authorization'] = `Bearer ${authToken}`;
    return h;
}

// On page load: check for invite token or restore session
(function init() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('invite')) {
        inviteToken = params.get('invite');
        window.history.replaceState({}, '', window.location.pathname);
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('inviteBox').style.display = 'block';
    } else if (authToken) {
        restoreSession();
    } else {
        checkSetupNeeded();
    }
})();

async function checkSetupNeeded() {
    try {
        const res = await fetch(`${API_BASE}/admin/setup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await res.json();
        if (data.message && data.message.includes('Setup already completed')) {
            document.getElementById('setupLink').style.display = 'none';
        } else {
            document.getElementById('setupLink').style.display = 'block';
        }
    } catch {
        document.getElementById('setupLink').style.display = 'none';
    }
}

function showSetupForm() {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('setupBox').style.display = 'block';
}
function showLoginForm() {
    document.getElementById('setupBox').style.display = 'none';
    document.getElementById('loginBox').style.display = 'block';
}

async function doSetup() {
    const name = document.getElementById('setupName').value.trim();
    const email = document.getElementById('setupEmail').value.trim();
    const password = document.getElementById('setupPass').value;
    if (!name || !email || !password) {
        showError('setupError', 'All fields are required.');
        return;
    }
    try {
        const res = await fetch(`${API_BASE}/admin/setup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
        });
        const data = await res.json();
        if (!data.success) { showError('setupError', data.message); return; }
        authToken = data.token;
        sessionStorage.setItem('staffToken', authToken);
        currentStaff = data.staff;
        enterDashboard();
    } catch (err) {
        showError('setupError', 'Connection error. Try again.');
    }
}

async function doLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPass').value;
    if (!email || !password) { showError('loginError', 'Email and password are required.'); return; }
    const btn = document.getElementById('loginBtn');
    btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
    try {
        const res = await fetch(`${API_BASE}/admin/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!data.success) { showError('loginError', data.message); return; }
        authToken = data.token;
        sessionStorage.setItem('staffToken', authToken);
        currentStaff = data.staff;
        enterDashboard();
    } catch (err) {
        showError('loginError', 'Connection error. Check API URL.');
    } finally {
        btn.disabled = false; btn.textContent = 'Sign In ‚Üí';
    }
}

async function doAcceptInvite() {
    const pass = document.getElementById('invitePass').value;
    const pass2 = document.getElementById('invitePass2').value;
    if (!pass || pass.length < 6) { showError('inviteError', 'Password must be at least 6 characters.'); return; }
    if (pass !== pass2) { showError('inviteError', 'Passwords do not match.'); return; }
    try {
        const res = await fetch(`${API_BASE}/admin/staff/accept-invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: inviteToken, password: pass })
        });
        const data = await res.json();
        if (!data.success) { showError('inviteError', data.message); return; }
        authToken = data.token;
        sessionStorage.setItem('staffToken', authToken);
        currentStaff = data.staff;
        enterDashboard();
    } catch (err) {
        showError('inviteError', 'Connection error. Try again.');
    }
}

async function restoreSession() {
    try {
        const res = await fetch(`${API_BASE}/admin/me`, { headers: authHeaders() });
        if (!res.ok) { doLogout(); return; }
        const data = await res.json();
        if (!data.success) { doLogout(); return; }
        currentStaff = data.staff;
        enterDashboard();
    } catch {
        doLogout();
    }
}

function enterDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    renderSidebar();
    loadData();
    loadStaffList();
    initTwilioDevice();
    // Restore sidebar collapse state
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
    }
}

function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('collapsed');
    localStorage.setItem('sidebarCollapsed', sb.classList.contains('collapsed'));
}

function doLogout() {
    authToken = '';
    currentStaff = null;
    cachedData = null;
    staffList = [];
    sessionStorage.removeItem('staffToken');
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('loginBox').style.display = 'block';
    document.getElementById('setupBox').style.display = 'none';
    document.getElementById('inviteBox').style.display = 'none';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').style.display = 'none';
}

function showError(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.style.display = 'block';
}

// Role-based sidebar
function renderSidebar() {
    if (!currentStaff) return;
    const role = currentStaff.role;
    const tabs = {
        overview: ['super_admin','admin'],
        categories: ['super_admin','admin'],
        users: ['super_admin','admin'],
        bookings: ['super_admin','admin'],
        leads: ['super_admin','admin','sales'],
        support: ['super_admin','admin','support'],
        employees: ['super_admin','admin']
    };
    Object.entries(tabs).forEach(([tab, roles]) => {
        const el = document.getElementById(`nav-${tab}`);
        if (el) el.style.display = roles.includes(role) ? 'flex' : 'none';
    });
    // Show first visible tab
    const firstTab = Object.entries(tabs).find(([t, roles]) => roles.includes(role));
    if (firstTab) showPage(firstTab[0]);
    // Display staff name
    document.getElementById('staffNameDisplay').textContent = currentStaff.name || currentStaff.email || '';
}

async function loadStaffList() {
    try {
        const res = await fetch(`${API_BASE}/admin/staff`, { headers: authHeaders() });
        const data = await res.json();
        if (data.success) {
            staffList = data.staff || [];
            populateAssigneeFilter();
        }
    } catch { /* silent ‚Äî sales users may not have access */ }
}

function populateAssigneeFilter() {
    const sel = document.getElementById('savedFilterAssignee');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">All People</option>' +
        staffList.map(s => `<option value="${s._id}"${s._id === current ? ' selected' : ''}>${esc(s.name)}</option>`).join('');
}

async function loadData(isLogin = false) {
    try {
        const res = await fetch(`${API_BASE}/admin/analytics`, { headers: authHeaders() });
        if (res.status === 401) { doLogout(); return; }
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        cachedData = data;
        renderAll(data);
    } catch (err) {
        console.error(err);
    }
}

function renderAll(data) {
    const time = new Date(data.generatedAt).toLocaleString();
    document.getElementById('lastUpdated').textContent = `Last updated: ${time}`;
    renderOverview(data);
    renderCategories(data);
    renderUsers(data);
    renderBookings(data);
}

function renderOverview(data) {
    const { users, bookings } = data;

    document.getElementById('usageStats').innerHTML = `
        <div class="stat-card purple">
            <div class="stat-label">Daily Active Users</div>
            <div class="stat-value purple">${users.dau}</div>
            <div class="stat-change">last 24 hours</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-label">Weekly Active Users</div>
            <div class="stat-value purple">${users.wau}</div>
            <div class="stat-change">last 7 days</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-label">Monthly Active Users</div>
            <div class="stat-value purple">${users.mau}</div>
            <div class="stat-change">last 30 days</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Bookings Today</div>
            <div class="stat-value green">${bookings.bookingsToday}</div>
            <div class="stat-change">this week: ${bookings.bookingsWeek}</div>
        </div>
    `;

    document.getElementById('userStats').innerHTML = `
        <div class="stat-card purple">
            <div class="stat-label">Total Users</div>
            <div class="stat-value purple">${users.totalUsers}</div>
            <div class="stat-change">+${users.newUsersToday} today</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Total Customers</div>
            <div class="stat-value green">${users.totalCustomers}</div>
            <div class="stat-change">+${users.newUsersWeek} this week</div>
        </div>
        <div class="stat-card pink">
            <div class="stat-label">Total Providers</div>
            <div class="stat-value pink">${users.totalProviders}</div>
            <div class="stat-change">+${users.newUsersMonth} this month</div>
        </div>
    `;

    document.getElementById('bookingStats').innerHTML = `
        <div class="stat-card purple">
            <div class="stat-label">Total Bookings</div>
            <div class="stat-value purple">${bookings.totalBookings}</div>
            <div class="stat-change">all time</div>
        </div>
        <div class="stat-card yellow">
            <div class="stat-label">Pending</div>
            <div class="stat-value yellow">${bookings.pendingBookings}</div>
            <div class="stat-change">awaiting confirmation</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Confirmed</div>
            <div class="stat-value green">${bookings.confirmedBookings}</div>
            <div class="stat-change">+ ${bookings.completedBookings} completed</div>
        </div>
        <div class="stat-card green">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value green">$${bookings.totalRevenue.toLocaleString()}</div>
            <div class="stat-change">$${bookings.totalSaved.toLocaleString()} saved by users</div>
        </div>
    `;
}

function renderCategories(data) {
    const { byCategory } = data.services;
    const cats = Object.keys(byCategory).sort();

    if (cats.length === 0) {
        document.getElementById('categoriesContent').innerHTML = '<div class="loading">No services found</div>';
        return;
    }

    let html = `<p style="font-size:13px;color:var(--text2);margin-bottom:20px;">${data.services.total} active services across ${cats.length} categories. Click a category to expand.</p>`;

    cats.forEach(cat => {
        const providers = byCategory[cat];
        const icon = CATEGORY_ICONS[cat] || '‚ú®';
        const totalSlots = providers.reduce((sum, p) => {
            return sum + p.slots.reduce((s2, sl) => s2 + (typeof sl.totalSlots === 'number' ? sl.totalSlots : 0), 0);
        }, 0);

        html += `
        <div class="category-block" id="cat-${cat.replace(/\s/g,'_')}">
            <div class="category-header" onclick="toggleCat('${cat.replace(/\s/g,'_')}')">
                <div class="category-header-left">
                    <div class="category-icon">${icon}</div>
                    <div>
                        <div class="category-name">${cat}</div>
                        <div class="category-providers">${providers.length} provider${providers.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span class="category-badge">${providers.length} deals</span>
                    <span class="chevron">‚ñº</span>
                </div>
            </div>
            <div class="category-body">`;

        providers.forEach(prov => {
            html += `
                <div class="provider-row">
                    <div class="provider-name">${prov.providerName}</div>
                    <div class="provider-location">üìç ${prov.location}</div>
                    <span class="deal-status ${prov.dealActive ? 'active' : 'inactive'}">
                        ${prov.dealActive ? '‚óè Active Deal' : '‚óã Deal Off'}
                    </span>
                    <table class="slot-table">
                        <thead>
                            <tr>
                                <th>Day / Period</th>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Price</th>
                                <th>Total Slots</th>
                                <th>Booked</th>
                                <th>Remaining</th>
                                <th>Fill Rate</th>
                            </tr>
                        </thead>
                        <tbody>`;
            prov.slots.forEach(slot => {
                const total = typeof slot.totalSlots === 'number' ? slot.totalSlots : null;
                const booked = slot.bookedSlots || 0;
                const remaining = typeof slot.remainingSlots === 'number' ? slot.remainingSlots : '‚àû';
                const pct = total ? Math.round((booked / total) * 100) : 0;
                const fillClass = pct >= 90 ? 'full' : pct >= 50 ? 'half' : 'low';
                const timeStr = slot.startTime !== '-' ? `${slot.startTime} ‚Äì ${slot.endTime}` : '‚Äî';
                const durStr = slot.duration !== '-' ? `${slot.duration}m` : '‚Äî';

                html += `
                            <tr>
                                <td class="bold">${slot.day}</td>
                                <td class="mono">${timeStr}</td>
                                <td class="mono">${durStr}</td>
                                <td class="mono" style="color:var(--green)">$${slot.price}</td>
                                <td class="mono">${slot.totalSlots}</td>
                                <td class="mono">${booked}</td>
                                <td class="mono">${remaining}</td>
                                <td>
                                    ${total ? `<div class="slot-bar">
                                        <div class="slot-bar-track">
                                            <div class="slot-bar-fill ${fillClass}" style="width:${pct}%"></div>
                                        </div>
                                        <span class="mono" style="font-size:10px;color:var(--text3);min-width:28px">${pct}%</span>
                                    </div>` : '<span style="color:var(--text3);font-size:11px">unlimited</span>'}
                                </td>
                            </tr>`;
            });
            html += `</tbody></table></div>`;
        });

        html += `</div></div>`;
    });

    document.getElementById('categoriesContent').innerHTML = html;
}

function renderUsers(data) {
    const { users } = data;
    document.getElementById('usersContent').innerHTML = `
        <div class="two-col">
            <div class="table-wrap">
                <div class="table-header">
                    <div class="table-title">Active Users</div>
                </div>
                <table>
                    <thead><tr><th>Period</th><th>Active Users</th><th>New Sign-ups</th></tr></thead>
                    <tbody>
                        <tr><td class="bold">Today (24h)</td><td class="mono" style="color:var(--accent)">${users.dau}</td><td class="mono" style="color:var(--green)">+${users.newUsersToday}</td></tr>
                        <tr><td class="bold">This Week (7d)</td><td class="mono" style="color:var(--accent)">${users.wau}</td><td class="mono" style="color:var(--green)">+${users.newUsersWeek}</td></tr>
                        <tr><td class="bold">This Month (30d)</td><td class="mono" style="color:var(--accent)">${users.mau}</td><td class="mono" style="color:var(--green)">+${users.newUsersMonth}</td></tr>
                        <tr><td class="bold">All Time</td><td class="mono" style="color:var(--accent)">${users.totalUsers}</td><td class="mono" style="color:var(--text3)">total</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-wrap">
                <div class="table-header">
                    <div class="table-title">User Breakdown</div>
                </div>
                <table>
                    <thead><tr><th>Type</th><th>Count</th><th>Share</th></tr></thead>
                    <tbody>
                        <tr>
                            <td class="bold">üë• Customers</td>
                            <td class="mono" style="color:var(--green)">${users.totalCustomers}</td>
                            <td><div class="slot-bar"><div class="slot-bar-track"><div class="slot-bar-fill low" style="width:${users.totalUsers ? Math.round(users.totalCustomers/users.totalUsers*100) : 0}%"></div></div><span class="mono" style="font-size:10px;color:var(--text3)">${users.totalUsers ? Math.round(users.totalCustomers/users.totalUsers*100) : 0}%</span></div></td>
                        </tr>
                        <tr>
                            <td class="bold">üè™ Providers</td>
                            <td class="mono" style="color:var(--accent2)">${users.totalProviders}</td>
                            <td><div class="slot-bar"><div class="slot-bar-track"><div class="slot-bar-fill" style="background:var(--accent2);width:${users.totalUsers ? Math.round(users.totalProviders/users.totalUsers*100) : 0}%"></div></div><span class="mono" style="font-size:10px;color:var(--text3)">${users.totalUsers ? Math.round(users.totalProviders/users.totalUsers*100) : 0}%</span></div></td>
                        </tr>
                        <tr>
                            <td class="bold">üìä Total</td>
                            <td class="mono" style="color:var(--accent)">${users.totalUsers}</td>
                            <td><span class="pill purple">100%</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderBookings(data) {
    const { bookings } = data;
    const statuses = [
        { label: 'Pending', count: bookings.pendingBookings, color: 'yellow' },
        { label: 'Confirmed', count: bookings.confirmedBookings, color: 'green' },
        { label: 'Completed', count: bookings.completedBookings, color: 'purple' },
        { label: 'Cancelled', count: bookings.cancelledBookings, color: 'red' },
    ];

    document.getElementById('bookingsContent').innerHTML = `
        <div class="two-col">
            <div class="table-wrap">
                <div class="table-header"><div class="table-title">Booking Volume</div></div>
                <table>
                    <thead><tr><th>Period</th><th>Bookings</th></tr></thead>
                    <tbody>
                        <tr><td class="bold">Today</td><td class="mono" style="color:var(--green)">${bookings.bookingsToday}</td></tr>
                        <tr><td class="bold">This Week (7d)</td><td class="mono" style="color:var(--green)">${bookings.bookingsWeek}</td></tr>
                        <tr><td class="bold">All Time</td><td class="mono" style="color:var(--accent)">${bookings.totalBookings}</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-wrap">
                <div class="table-header"><div class="table-title">Revenue</div></div>
                <table>
                    <thead><tr><th>Metric</th><th>Value</th></tr></thead>
                    <tbody>
                        <tr><td class="bold">Total Revenue</td><td class="mono" style="color:var(--green)">$${bookings.totalRevenue.toLocaleString()}</td></tr>
                        <tr><td class="bold">Total Saved by Users</td><td class="mono" style="color:var(--yellow)">$${bookings.totalSaved.toLocaleString()}</td></tr>
                        <tr><td class="bold">Avg per Booking</td><td class="mono" style="color:var(--accent)">$${bookings.totalBookings ? Math.round(bookings.totalRevenue / bookings.totalBookings) : 0}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="table-wrap">
            <div class="table-header">
                <div class="table-title">Status Breakdown</div>
                <span class="table-count">${bookings.totalBookings} total</span>
            </div>
            <table>
                <thead><tr><th>Status</th><th>Count</th><th>Share</th></tr></thead>
                <tbody>
                    ${statuses.map(s => `
                    <tr>
                        <td class="bold">${s.label}</td>
                        <td class="mono">${s.count}</td>
                        <td><div class="slot-bar">
                            <div class="slot-bar-track">
                                <div class="slot-bar-fill ${s.color === 'red' ? 'full' : s.color === 'yellow' ? 'half' : 'low'}" style="width:${bookings.totalBookings ? Math.round(s.count/bookings.totalBookings*100) : 0}%"></div>
                            </div>
                            <span class="pill ${s.color}">${bookings.totalBookings ? Math.round(s.count/bookings.totalBookings*100) : 0}%</span>
                        </div></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function toggleCat(id) {
    const el = document.getElementById(`cat-${id}`);
    el.classList.toggle('open');
}

function showPage(name) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const page = document.getElementById(`page-${name}`);
    const nav = document.getElementById(`nav-${name}`);
    if (page) page.classList.add('active');
    if (nav) nav.classList.add('active');
    if (name === 'leads') refreshSavedBadge();
    if (name === 'support') loadTickets();
    if (name === 'employees') loadEmployees();
}

// ‚îÄ‚îÄ LEAD FINDER / CRM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let leadsData = [];

function selectAllIndustries() {
    document.querySelectorAll('#leadIndustries input[type=checkbox]').forEach(c => c.checked = true);
}
function clearAllIndustries() {
    document.querySelectorAll('#leadIndustries input[type=checkbox]').forEach(c => c.checked = false);
}

function switchLeadTab(tab) {
    const isSearch = tab === 'search';
    document.getElementById('leadSearchView').style.display = isSearch ? 'block' : 'none';
    document.getElementById('leadSavedView').style.display  = isSearch ? 'none'  : 'block';
    document.getElementById('leadTabSearch').classList.toggle('active', isSearch);
    document.getElementById('leadTabSaved').classList.toggle('active', !isSearch);
    if (!isSearch) loadSavedLeads();
}

function setLeadStatus(msg, loading = false) {
    const el = document.getElementById('leadStatus');
    el.style.display = 'flex';
    el.innerHTML = loading
        ? `<div class="spinner" style="width:16px;height:16px;border-width:2px;flex-shrink:0;"></div><span>${msg}</span>`
        : `<span>${msg}</span>`;
}

function setSavedStatus(msg, loading = false) {
    const el = document.getElementById('savedLeadsStatus');
    el.style.display = 'flex';
    el.innerHTML = loading
        ? `<div class="spinner" style="width:16px;height:16px;border-width:2px;flex-shrink:0;"></div><span>${msg}</span>`
        : `<span>${msg}</span>`;
}

async function searchLeads() {
    const city = document.getElementById('leadCity').value.trim();
    if (!city) { setLeadStatus('‚ö†Ô∏è Please enter a town or city.'); return; }

    const checked = [...document.querySelectorAll('#leadIndustries input[type=checkbox]:checked')];
    if (!checked.length) { setLeadStatus('‚ö†Ô∏è Please select at least one industry.'); return; }

    const btn = document.getElementById('leadSearchBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Searching‚Ä¶';
    document.getElementById('leadResults').style.display = 'none';

    const industries = checked.map(c => c.value);
    const total = industries.length;
    setLeadStatus(`Searching ${total} industr${total === 1 ? 'y' : 'ies'} in "${city}" ‚Äî this may take up to ${total} min${total > 1 ? 's' : ''}‚Ä¶`, true);

    try {
        const params = new URLSearchParams({ city });
        industries.forEach(i => params.append('industries', i));

        const res = await fetch(`${API_BASE}/admin/leads?${params}`, {
            headers: authHeaders()
        });
        const data = await res.json();

        if (!data.success) {
            setLeadStatus(`‚ùå ${data.message}`);
            return;
        }

        leadsData = data.leads || [];
        renderLeads(leadsData, city);
        setLeadStatus(`‚úÖ Found ${leadsData.length} business${leadsData.length === 1 ? '' : 'es'} ‚Äî fetching emails‚Ä¶`, true);
        scrapeEmails();
    } catch (err) {
        setLeadStatus(`‚ùå Request failed: ${err.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Find Leads';
    }
}

function renderLeads(leads, city) {
    const tbody = document.getElementById('leadTableBody');
    if (!leads.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text3);">No businesses found for the selected criteria in ${city}.</td></tr>`;
        document.getElementById('leadCount').textContent = '0 results';
        document.getElementById('leadResults').style.display = 'block';
        return;
    }

    tbody.innerHTML = leads.map((l, i) => `
        <tr>
            <td>${i + 1}</td>
            <td class="lead-name">${esc(l.businessName)}</td>
            <td><input class="lead-contact-input" data-idx="${i}" placeholder="Enter name‚Ä¶" value="${esc(l.contactName)}" oninput="leadsData[${i}].contactName=this.value"></td>
            <td class="lead-phone">${l.phone ? esc(l.phone) : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-email"><span class="lead-empty" style="font-style:normal;opacity:0.4;">‚Ä¶</span></td>
            <td class="lead-addr">${esc(l.address)}</td>
            <td class="lead-web">${l.website ? `<a href="${esc(l.website)}" target="_blank" title="${esc(l.website)}">${esc(l.website.replace(/^https?:\/\/(www\.)?/,'').split('/')[0])}</a>` : '<span class="lead-empty">‚Äî</span>'}</td>
            <td class="lead-service"><span class="pill purple">${esc(l.serviceType)}</span></td>
        </tr>
    `).join('');

    document.getElementById('leadCount').textContent = `${leads.length} business${leads.length === 1 ? '' : 'es'} found`;
    document.getElementById('leadResults').style.display = 'block';
}

async function scrapeEmails() {
    const websites = leadsData.map(l => l.website || '');
    try {
        const res = await fetch(`${API_BASE}/admin/leads/scrape-emails`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ websites })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        data.emails.forEach((email, i) => {
            leadsData[i].email = email;
            const cell = document.querySelector(`#leadTableBody tr:nth-child(${i + 1}) td:nth-child(5)`);
            if (cell) cell.innerHTML = email
                ? `<a href="mailto:${esc(email)}" style="color:var(--accent);">${esc(email)}</a>`
                : '<span class="lead-empty">‚Äî</span>';
        });
        const found = data.emails.filter(Boolean).length;
        setLeadStatus(`‚úÖ Done ‚Äî ${leadsData.length} businesses, ${found} email${found === 1 ? '' : 's'} found.`);
    } catch {
        setLeadStatus(`‚úÖ Done ‚Äî ${leadsData.length} businesses found (email scraping failed).`);
    }
}

async function saveLeadsToDb() {
    if (!leadsData.length) return;
    const city = document.getElementById('leadCity').value.trim();
    const btn = document.getElementById('leadSaveBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Saving‚Ä¶';
    try {
        const res = await fetch(`${API_BASE}/admin/leads/save`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ leads: leadsData, city })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        btn.textContent = `‚úÖ ${data.saved} saved!`;
        setTimeout(() => { btn.disabled = false; btn.textContent = 'Ôºã Save to My Leads'; }, 2500);
        // Update badge
        refreshSavedBadge();
    } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Ôºã Save to My Leads';
        setLeadStatus(`‚ùå Save failed: ${err.message}`);
    }
}

async function refreshSavedBadge() {
    try {
        const res = await fetch(`${API_BASE}/admin/leads/saved`, { headers: authHeaders() });
        const data = await res.json();
        if (data.success) {
            const badge = document.getElementById('leadSavedBadge');
            badge.textContent = data.total;
            badge.style.display = data.total ? 'inline-block' : 'none';
        }
    } catch { /* silent */ }
}

async function loadSavedLeads() {
    const status   = document.getElementById('savedFilterStatus').value;
    const city     = document.getElementById('savedFilterCity').value.trim();
    const service  = document.getElementById('savedFilterService').value;
    const assignee = document.getElementById('savedFilterAssignee').value;
    setSavedStatus('Loading‚Ä¶', true);
    try {
        const params = new URLSearchParams();
        if (status)   params.set('status', status);
        if (city)     params.set('city', city);
        if (service)  params.set('serviceType', service);
        if (assignee) params.set('assignee', assignee);
        const res = await fetch(`${API_BASE}/admin/leads/saved?${params}`, {
            headers: authHeaders()
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        document.getElementById('savedLeadsStatus').style.display = 'none';
        renderSavedLeads(data.leads);
        document.getElementById('savedLeadsCount').textContent = `${data.total} lead${data.total === 1 ? '' : 's'}`;
        // Sync badge
        const badge = document.getElementById('leadSavedBadge');
        badge.textContent = data.total;
        badge.style.display = data.total ? 'inline-block' : 'none';
    } catch (err) {
        setSavedStatus(`‚ùå ${err.message}`);
    }
}

const STATUS_LABELS = { new: 'New', contacted: 'Contacted', interested: 'Interested', onboarded: 'Onboarded', rejected: 'Rejected', live: 'Live' };

function renderSavedLeads(leads) {
    const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const tbody = document.getElementById('savedLeadsBody');
    if (!leads.length) {
        tbody.innerHTML = `<tr><td colspan="19" style="text-align:center;padding:40px;color:var(--text3);">No leads found. Use the Search tab to find and save businesses.</td></tr>`;
        return;
    }
    const assigneeOptions = staffList.map(s => `<option value="${s._id}">${esc(s.name)}</option>`).join('');
    tbody.innerHTML = leads.map((l, i) => {
        const activeDays = new Set(l.days || []);
        const dayChips = DAYS.map(d =>
            `<span class="lead-day-chip${activeDays.has(d) ? ' active' : ''}" onclick="toggleLeadDay('${esc(l._id)}',this,'${d}')">${d}</span>`
        ).join('');
        const assigneeId = l.assignee ? (l.assignee._id || l.assignee) : '';
        const cleanPhone = (l.phone || '').replace(/[^+\d]/g, '');
        return `
        <tr id="srow-${esc(l._id)}">
            <td>${i + 1}</td>
            <td class="lead-name">${esc(l.businessName)}</td>
            <td><input class="lead-contact-input" placeholder="Enter name‚Ä¶" value="${esc(l.contactName)}"
                onchange="updateLeadField('${esc(l._id)}','contactName',this.value)"></td>
            <td class="lead-phone"><input class="lead-contact-input" placeholder="Phone‚Ä¶" value="${esc(l.phone || '')}"
                onchange="updateLeadField('${esc(l._id)}','phone',this.value)" style="min-width:120px;"></td>
            <td>${cleanPhone ? `<button class="call-btn" onclick="startBrowserCall('${esc(l._id)}','${esc(l.businessName).replace(/'/g,"\\\\'")}','${cleanPhone}')">üìû Call</button><span class="call-count-badge" id="ccb-${esc(l._id)}" onclick="toggleCallHistory('${esc(l._id)}')" style="display:none">0</span>` : ''}</td>
            <td class="lead-email"><input class="lead-contact-input" placeholder="Enter email‚Ä¶" value="${esc(l.email)}"
                onchange="updateLeadField('${esc(l._id)}','email',this.value)" style="color:var(--accent);min-width:160px;"></td>
            <td>${l.email ? `<button class="email-send-btn" onclick="openEmailCompose('${esc(l._id)}','${esc(l.email)}','${esc(l.businessName).replace(/'/g,"\\\\'")}')">‚úâ Email</button><span class="email-count-badge" id="ecb-${esc(l._id)}" onclick="toggleEmailHistory('${esc(l._id)}')" style="display:none">0</span>` : ''}</td>
            <td class="lead-addr"><input class="lead-contact-input" placeholder="City‚Ä¶" value="${esc(l.city || '')}"
                onchange="updateLeadField('${esc(l._id)}','city',this.value)" style="font-size:12px;min-width:100px;"></td>
            <td class="lead-service">
                <select class="lead-status-select" style="font-size:11px;min-width:120px;" onchange="updateLeadField('${esc(l._id)}','serviceType',this.value)">
                    ${['Haircut','Barber','Cleaning Service','Massage','Nail Service','Spa Treatment','Personal Training','Dog Walking','Tutoring','Photography','Car Detailing','Laundry Service'].map(st => `<option value="${st}"${l.serviceType===st?' selected':''}>${st}</option>`).join('')}
                </select>
            </td>
            <td>
                <select class="lead-status-select s-${esc(l.status)}" onchange="updateLeadField('${esc(l._id)}','status',this.value);this.className='lead-status-select s-'+this.value">
                    ${Object.entries(STATUS_LABELS).map(([v,lab]) => `<option value="${v}"${l.status===v?' selected':''}>${lab}</option>`).join('')}
                </select>
            </td>
            <td>
                <select class="lead-assignee-select" onchange="updateLeadField('${esc(l._id)}','assignee',this.value)">
                    <option value="">Unassigned</option>
                    ${assigneeOptions.replace(`value="${assigneeId}"`, `value="${assigneeId}" selected`)}
                </select>
            </td>
            <td><input class="lead-price-input" type="number" placeholder="0.00" value="${l.price != null ? l.price : ''}"
                onchange="updateLeadField('${esc(l._id)}','price',this.value===''?null:Number(this.value))"></td>
            <td><input class="lead-price-input" type="number" placeholder="0.00" value="${l.discountPrice != null ? l.discountPrice : ''}"
                onchange="updateLeadField('${esc(l._id)}','discountPrice',this.value===''?null:Number(this.value))" style="color:var(--accent2);"></td>
            <td><div class="lead-day-chips" id="daychips-${esc(l._id)}">${dayChips}</div></td>
            <td><textarea class="lead-notes-input" placeholder="Add description‚Ä¶" rows="2" style="min-width:150px;resize:vertical;"
                onchange="updateLeadField('${esc(l._id)}','description',this.value)">${esc(l.description || '')}</textarea></td>
            <td>
                <div class="lead-photos-grid" id="photos-${esc(l._id)}">
                    ${(l.photos || []).map((p, pi) => `<div class="lead-photo-thumb"><img src="${p}" alt=""><button class="lead-photo-remove" onclick="removeLeadPhoto('${esc(l._id)}',${pi})">‚úï</button></div>`).join('')}
                    ${(l.photos || []).length < 6 ? `<label class="lead-photo-add"><input type="file" accept="image/*" multiple hidden onchange="addLeadPhotos('${esc(l._id)}',this.files)">+</label>` : ''}
                </div>
                ${(l.photos || []).length > 0 ? `<span style="font-size:10px;color:var(--text3);margin-top:2px;display:block;">${(l.photos || []).length}/6</span>` : ''}
            </td>
            <td><input class="lead-notes-input" placeholder="Add notes‚Ä¶" value="${esc(l.notes)}"
                onchange="updateLeadField('${esc(l._id)}','notes',this.value)"></td>
            <td>${l.status === 'live'
                ? '<span class="pill" style="background:#00c853;color:#fff;font-size:11px;">Live</span>'
                : `<button class="lead-toggle-btn" style="font-size:11px;white-space:nowrap;" onclick="createProfile('${esc(l._id)}')">Create Profile</button>`}
            </td>
            <td><button class="lead-delete-btn" onclick="deleteLead('${esc(l._id)}',this)" title="Delete lead">‚úï</button></td>
        </tr>`;
    }).join('');
    // Load call + email counts
    leads.forEach(l => { loadCallCount(l._id); loadEmailCount(l._id); });
}

async function updateLeadField(id, field, value) {
    try {
        await fetch(`${API_BASE}/admin/leads/saved/${id}`, {
            method: 'PATCH',
            headers: authHeaders(),
            body: JSON.stringify({ [field]: value })
        });
    } catch { /* silent ‚Äî UI already updated */ }
}

function toggleLeadDay(id, chip, day) {
    chip.classList.toggle('active');
    const container = document.getElementById(`daychips-${id}`);
    const days = [...container.querySelectorAll('.lead-day-chip.active')].map(c => c.textContent);
    updateLeadField(id, 'days', days);
}

async function addLeadPhotos(id, files) {
    const grid = document.getElementById(`photos-${id}`);
    const existing = grid.querySelectorAll('.lead-photo-thumb').length;
    const allowed = Math.min(files.length, 6 - existing);
    if (allowed <= 0) { alert('Maximum 6 photos allowed.'); return; }

    // Show loading feedback
    const addBtn = grid.querySelector('.lead-photo-add');
    if (addBtn) addBtn.innerHTML = '<span style="font-size:11px;">...</span>';

    try {
        const newPhotos = [];
        for (let i = 0; i < allowed; i++) {
            const b64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > 600) { h = Math.round(h * 600 / w); w = 600; }
                        if (h > 600) { w = Math.round(w * 600 / h); h = 600; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = reader.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(files[i]);
            });
            newPhotos.push(b64);
        }

        // Fetch current lead data from server to get existing photos
        const res = await fetch(`${API_BASE}/admin/leads/saved`, { headers: authHeaders() });
        const data = await res.json();
        const lead = data.leads ? data.leads.find(l => l._id === id) : null;
        const currentPhotos = lead ? (lead.photos || []) : [];
        const allPhotos = [...currentPhotos, ...newPhotos].slice(0, 6);

        const patchRes = await fetch(`${API_BASE}/admin/leads/saved/${id}`, {
            method: 'PATCH',
            headers: authHeaders(),
            body: JSON.stringify({ photos: allPhotos })
        });
        const patchData = await patchRes.json();
        if (!patchData.success) throw new Error(patchData.message || 'Failed to save photos');

        loadSavedLeads();
    } catch (err) {
        alert('Error uploading photos: ' + err.message);
        if (addBtn) addBtn.innerHTML = '+';
    }
}

async function removeLeadPhoto(id, photoIdx) {
    try {
        const res = await fetch(`${API_BASE}/admin/leads/saved`, { headers: authHeaders() });
        const data = await res.json();
        const lead = data.leads ? data.leads.find(l => l._id === id) : null;
        const currentPhotos = lead ? [...(lead.photos || [])] : [];
        currentPhotos.splice(photoIdx, 1);

        const patchRes = await fetch(`${API_BASE}/admin/leads/saved/${id}`, {
            method: 'PATCH',
            headers: authHeaders(),
            body: JSON.stringify({ photos: currentPhotos })
        });
        const patchData = await patchRes.json();
        if (!patchData.success) throw new Error(patchData.message);

        loadSavedLeads();
    } catch (err) {
        alert('Error removing photo: ' + err.message);
    }
}

async function createProfile(id) {
    if (!confirm('Create a provider profile from this lead? The provider will receive an email to set up their account.')) return;
    try {
        const res = await fetch(`${API_BASE}/admin/leads/${id}/create-profile`, {
            method: 'POST',
            headers: authHeaders()
        });
        const data = await res.json();
        if (!data.success) {
            alert(data.message || 'Failed to create profile.');
            return;
        }
        alert('Provider profile created! Setup email sent.');
        loadSavedLeads();
    } catch (err) {
        alert('Error creating profile: ' + err.message);
    }
}

function openAddLeadModal() {
    // Reset all fields
    ['mlBusinessName','mlContactName','mlPhone','mlEmail','mlCity',
     'mlAddress','mlWebsite','mlNotes','mlPrice','mlDiscountPrice'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('mlStatus').value = 'new';
    document.getElementById('mlServiceType').value = '';
    document.querySelectorAll('#mlDays .lead-day-chip').forEach(c => c.classList.remove('active'));
    document.getElementById('mlSubmitBtn').disabled = false;
    document.getElementById('mlSubmitBtn').textContent = 'Add Lead';
    document.getElementById('addLeadOverlay').classList.add('open');
}

function closeAddLeadModal() {
    document.getElementById('addLeadOverlay').classList.remove('open');
}

async function submitManualLead() {
    const businessName = document.getElementById('mlBusinessName').value.trim();
    if (!businessName) { alert('Business Name is required.'); return; }

    const days = [...document.querySelectorAll('#mlDays .lead-day-chip.active')].map(c => c.textContent);
    const priceVal = document.getElementById('mlPrice').value;
    const discountVal = document.getElementById('mlDiscountPrice').value;

    const lead = {
        businessName,
        contactName:   document.getElementById('mlContactName').value.trim(),
        phone:         document.getElementById('mlPhone').value.trim(),
        email:         document.getElementById('mlEmail').value.trim(),
        city:          document.getElementById('mlCity').value.trim(),
        address:       document.getElementById('mlAddress').value.trim(),
        website:       document.getElementById('mlWebsite').value.trim(),
        serviceType:   document.getElementById('mlServiceType').value,
        status:        document.getElementById('mlStatus').value,
        price:         priceVal !== '' ? Number(priceVal) : null,
        discountPrice: discountVal !== '' ? Number(discountVal) : null,
        days,
        notes:         document.getElementById('mlNotes').value.trim()
    };

    const btn = document.getElementById('mlSubmitBtn');
    btn.disabled = true;
    btn.textContent = 'Saving‚Ä¶';

    try {
        const res = await fetch(`${API_BASE}/admin/leads/save`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ leads: [lead], city: lead.city })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        closeAddLeadModal();
        loadSavedLeads();
        refreshSavedBadge();
    } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Add Lead';
        alert(`Failed to save: ${err.message}`);
    }
}

async function deleteLead(id, btn) {
    if (!confirm('Delete this lead?')) return;
    try {
        const res = await fetch(`${API_BASE}/admin/leads/saved/${id}`, {
            method: 'DELETE',
            headers: authHeaders()
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        const row = document.getElementById(`srow-${id}`);
        if (row) row.remove();
        // recount
        const rows = document.querySelectorAll('#savedLeadsBody tr[id^="srow-"]');
        document.getElementById('savedLeadsCount').textContent = `${rows.length} lead${rows.length === 1 ? '' : 's'}`;
        const badge = document.getElementById('leadSavedBadge');
        badge.textContent = rows.length;
        badge.style.display = rows.length ? 'inline-block' : 'none';
    } catch (err) {
        alert(`Delete failed: ${err.message}`);
    }
}

function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function exportLeadsCSV() {
    if (!leadsData.length) return;
    const headers = ['#','Business Name','Contact Name','Phone','Email','Address','Website','Service Type'];
    const rows = leadsData.map((l, i) => [
        i + 1, l.businessName, l.contactName, l.phone, l.email, l.address, l.website, l.serviceType
    ]);
    const csv = [headers, ...rows].map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const city = document.getElementById('leadCity').value.trim().replace(/\s+/g, '_') || 'leads';
    a.href = url;
    a.download = `slowday_leads_${city}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ CALL LOGGING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ TWILIO BROWSER CALLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let twilioDevice = null;
let activeCall = null;
let callTimerInterval = null;
let callStartTime = null;
let currentCallLogId = null;
let currentCallLeadId = null;
let isMuted = false;

async function initTwilioDevice() {
    try {
        const res = await fetch(`${API_BASE}/admin/voice/token`, { headers: authHeaders() });
        const data = await res.json();
        if (!data.success) { console.warn('Voice calling not available:', data.message); return; }

        if (typeof Twilio !== 'undefined' && Twilio.Device) {
            twilioDevice = new Twilio.Device(data.token, {
                codecPreferences: ['opus', 'pcmu'],
                enableRingingState: true
            });
            twilioDevice.on('registered', () => console.log('Twilio Device ready'));
            twilioDevice.on('error', (err) => {
                console.error('Twilio Device error:', err);
                updateCallModalStatus('Error: ' + (err.message || 'Connection failed'), 'failed');
            });
            twilioDevice.on('tokenWillExpire', async () => {
                const r = await fetch(`${API_BASE}/admin/voice/token`, { headers: authHeaders() });
                const d = await r.json();
                if (d.success) twilioDevice.updateToken(d.token);
            });
            await twilioDevice.register();
        }
    } catch (err) {
        console.error('Failed to init Twilio Device:', err);
    }
}

async function startBrowserCall(leadId, leadName, phone) {
    if (!twilioDevice) {
        alert('Voice calling is initializing. Please try again in a moment.');
        await initTwilioDevice();
        return;
    }

    const cleanPhone = phone.replace(/[^+\d]/g, '');
    if (!cleanPhone || cleanPhone.length < 10) { alert('Invalid phone number'); return; }
    const fullPhone = cleanPhone.startsWith('+') ? cleanPhone : `+1${cleanPhone.replace(/^1/, '')}`;

    // Show call modal
    currentCallLeadId = leadId;
    isMuted = false;
    document.getElementById('callModalAvatar').textContent = (leadName || '?')[0].toUpperCase();
    document.getElementById('callModalName').textContent = leadName || 'Unknown';
    document.getElementById('callModalPhone').textContent = fullPhone;
    document.getElementById('callModalStatus').textContent = 'Connecting...';
    document.getElementById('callModalTimer').textContent = '00:00';
    document.getElementById('callModalHeader').className = 'call-modal-header';
    document.getElementById('callControls').style.display = 'flex';
    document.getElementById('callNotesArea').classList.remove('show');
    document.getElementById('callNotesInput').value = '';
    document.getElementById('callMuteBtn').classList.remove('active');
    document.getElementById('callMuteBtn').innerHTML = MIC_SVG;
    document.getElementById('callModalOverlay').classList.add('open');

    try {
        activeCall = await twilioDevice.connect({ params: { To: fullPhone } });

        // Create call log immediately
        const logRes = await fetch(`${API_BASE}/admin/call-logs`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({
                leadId,
                startedAt: new Date().toISOString(),
                duration: 0,
                notes: '',
                twilioCallSid: activeCall.parameters?.CallSid || null,
                status: 'in-progress'
            })
        });
        const logData = await logRes.json();
        if (logData.success) currentCallLogId = logData.callLog._id;

        activeCall.on('ringing', () => updateCallModalStatus('Ringing...', null));

        activeCall.on('accept', () => {
            updateCallModalStatus('Connected', null);
            callStartTime = Date.now();
            callTimerInterval = setInterval(updateCallTimer, 1000);
            // Update CallSid if not captured earlier
            if (currentCallLogId && activeCall.parameters?.CallSid) {
                fetch(`${API_BASE}/admin/call-logs/${currentCallLogId}`, {
                    method: 'PATCH',
                    headers: authHeaders(),
                    body: JSON.stringify({ twilioCallSid: activeCall.parameters.CallSid })
                }).catch(() => {});
            }
        });

        activeCall.on('disconnect', () => onCallEnded('completed'));
        activeCall.on('cancel', () => onCallEnded('canceled'));
        activeCall.on('reject', () => onCallEnded('no-answer'));
        activeCall.on('error', (err) => { console.error('Call error:', err); onCallEnded('failed'); });

    } catch (err) {
        console.error('Failed to connect call:', err);
        updateCallModalStatus('Failed to connect', 'failed');
        setTimeout(() => closeCallModal(), 3000);
    }
}

const MIC_SVG = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
const MIC_OFF_SVG = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2c0 .67-.1 1.32-.27 1.93"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';

function toggleMute() {
    if (!activeCall) return;
    isMuted = !isMuted;
    activeCall.mute(isMuted);
    const btn = document.getElementById('callMuteBtn');
    btn.classList.toggle('active', isMuted);
    btn.title = isMuted ? 'Unmute' : 'Mute';
    btn.innerHTML = isMuted ? MIC_OFF_SVG : MIC_SVG;
}

function hangupCall() {
    if (activeCall) { activeCall.disconnect(); } else { closeCallModal(); }
}

function updateCallModalStatus(text, headerState) {
    document.getElementById('callModalStatus').textContent = text;
    if (headerState === 'failed') {
        document.getElementById('callModalHeader').className = 'call-modal-header failed';
    }
}

function updateCallTimer() {
    if (!callStartTime) return;
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const secs = String(elapsed % 60).padStart(2, '0');
    document.getElementById('callModalTimer').textContent = `${mins}:${secs}`;
}

function onCallEnded(status) {
    clearInterval(callTimerInterval);
    activeCall = null;
    const elapsed = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
    callStartTime = null;

    const header = document.getElementById('callModalHeader');
    header.className = (status === 'failed' || status === 'no-answer' || status === 'busy')
        ? 'call-modal-header failed' : 'call-modal-header ended';

    const labels = { completed: 'Call ended', failed: 'Call failed', 'no-answer': 'No answer', busy: 'Line busy', canceled: 'Call cancelled' };
    document.getElementById('callModalStatus').textContent = labels[status] || 'Call ended';
    document.getElementById('callControls').style.display = 'none';
    document.getElementById('callNotesArea').classList.add('show');

    if (currentCallLogId) {
        fetch(`${API_BASE}/admin/call-logs/${currentCallLogId}`, {
            method: 'PATCH',
            headers: authHeaders(),
            body: JSON.stringify({ duration: elapsed, status })
        }).catch(() => {});
    }
}

async function saveCallNotes() {
    const notes = document.getElementById('callNotesInput').value.trim();
    if (currentCallLogId) {
        try {
            await fetch(`${API_BASE}/admin/call-logs/${currentCallLogId}`, {
                method: 'PATCH',
                headers: authHeaders(),
                body: JSON.stringify({ notes })
            });
        } catch (err) { console.error('Failed to save notes:', err); }
    }
    closeCallModal();
}

function closeCallModal() {
    document.getElementById('callModalOverlay').classList.remove('open');
    clearInterval(callTimerInterval);
    activeCall = null;
    callStartTime = null;
    currentCallLogId = null;
    if (currentCallLeadId) {
        loadCallCount(currentCallLeadId);
        currentCallLeadId = null;
    }
}

// ‚îÄ‚îÄ CALL COUNT & HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadCallCount(leadId) {
    try {
        const res = await fetch(`${API_BASE}/admin/call-logs/${leadId}`, { headers: authHeaders() });
        const data = await res.json();
        if (data.success && data.callLogs.length) {
            const badge = document.getElementById(`ccb-${leadId}`);
            if (badge) {
                badge.textContent = data.callLogs.length;
                badge.style.display = 'inline-block';
            }
        }
    } catch {}
}

async function toggleCallHistory(leadId) {
    const existingRow = document.getElementById(`callhist-${leadId}`);
    if (existingRow) { existingRow.remove(); return; }
    try {
        const res = await fetch(`${API_BASE}/admin/call-logs/${leadId}`, { headers: authHeaders() });
        const data = await res.json();
        if (!data.success || !data.callLogs.length) return;
        const row = document.getElementById(`srow-${leadId}`);
        if (!row) return;
        const histRow = document.createElement('tr');
        histRow.id = `callhist-${leadId}`;
        histRow.innerHTML = `<td colspan="19" style="padding:12px 16px;background:var(--surface2);">
            <div class="call-history-panel">
                <div class="call-history-title">Call History (${data.callLogs.length})</div>
                ${data.callLogs.map(c => {
                    const d = new Date(c.startedAt);
                    const mins = Math.floor((c.duration || 0) / 60);
                    const secs = (c.duration || 0) % 60;
                    const statusClass = (c.status === 'failed' || c.status === 'no-answer' || c.status === 'busy') ? 'failed' : 'completed';
                    const statusIcon = statusClass === 'completed' ? '‚úì' : '‚úï';
                    const durationStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                    return `<div class="call-history-item">
                        <div class="call-history-icon ${statusClass}">${statusIcon}</div>
                        <div class="call-history-meta">
                            <div class="call-history-date">${d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})} at ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
                            <div class="call-history-info">
                                <span>${durationStr}</span>
                                <span>by ${esc(c.callerName)}</span>
                            </div>
                            ${c.notes ? `<div class="call-history-notes">"${esc(c.notes)}"</div>` : ''}
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </td>`;
        row.after(histRow);
    } catch {}
}

// ‚îÄ‚îÄ EMAIL COMPOSE + LOGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let currentEmailLeadId = null;

function openEmailCompose(leadId, email, businessName) {
    currentEmailLeadId = leadId;
    document.getElementById('emailComposeTo').value = email;
    document.getElementById('emailComposeSubject').value = '';
    document.getElementById('emailComposeBody').value = '';
    document.getElementById('emailComposeError').style.display = 'none';
    document.getElementById('emailComposeTitle').textContent = `Email ‚Äî ${businessName}`;
    document.getElementById('emailSendBtn').disabled = false;
    document.getElementById('emailSendBtn').textContent = 'Send Email';
    document.getElementById('emailComposeOverlay').classList.add('open');
}

function closeEmailCompose() {
    document.getElementById('emailComposeOverlay').classList.remove('open');
    currentEmailLeadId = null;
}

async function sendLeadEmail() {
    const to = document.getElementById('emailComposeTo').value;
    const subject = document.getElementById('emailComposeSubject').value.trim();
    const body = document.getElementById('emailComposeBody').value.trim();
    const errEl = document.getElementById('emailComposeError');
    const btn = document.getElementById('emailSendBtn');

    if (!subject) { errEl.textContent = 'Subject is required.'; errEl.style.display = 'block'; return; }
    if (!body) { errEl.textContent = 'Message body is required.'; errEl.style.display = 'block'; return; }
    errEl.style.display = 'none';

    btn.disabled = true;
    btn.textContent = 'Sending‚Ä¶';

    try {
        const res = await fetch(`${API_BASE}/admin/email-logs`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ leadId: currentEmailLeadId, to, subject, body })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);

        closeEmailCompose();
        loadEmailCount(currentEmailLeadId);
        alert('Email sent successfully!');
    } catch (err) {
        errEl.textContent = err.message || 'Failed to send email.';
        errEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Send Email';
    }
}

async function loadEmailCount(leadId) {
    try {
        const res = await fetch(`${API_BASE}/admin/email-logs/${leadId}`, { headers: authHeaders() });
        const data = await res.json();
        if (data.success && data.emailLogs.length) {
            const badge = document.getElementById(`ecb-${leadId}`);
            if (badge) {
                badge.textContent = data.emailLogs.length;
                badge.style.display = 'inline-block';
            }
        }
    } catch {}
}

async function toggleEmailHistory(leadId) {
    const existingRow = document.getElementById(`emailhist-${leadId}`);
    if (existingRow) { existingRow.remove(); return; }
    try {
        const res = await fetch(`${API_BASE}/admin/email-logs/${leadId}`, { headers: authHeaders() });
        const data = await res.json();
        if (!data.success || !data.emailLogs.length) return;
        const row = document.getElementById(`srow-${leadId}`);
        if (!row) return;
        const histRow = document.createElement('tr');
        histRow.id = `emailhist-${leadId}`;
        histRow.innerHTML = `<td colspan="19" style="padding:12px 16px;background:var(--surface2);">
            <div class="call-history-panel">
                <div class="call-history-title">‚úâ Email History (${data.emailLogs.length})</div>
                ${data.emailLogs.map(e => {
                    const d = new Date(e.sentAt);
                    const statusClass = e.status === 'failed' ? 'failed' : 'completed';
                    const statusIcon = statusClass === 'completed' ? '‚úì' : '‚úï';
                    const bodyPreview = e.body.length > 200 ? esc(e.body.substring(0, 200)) + '‚Ä¶' : esc(e.body);
                    return `<div class="call-history-item">
                        <div class="call-history-icon ${statusClass}">${statusIcon}</div>
                        <div class="call-history-meta">
                            <div class="call-history-date">${d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})} at ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
                            <div class="call-history-info">
                                <span>by ${esc(e.senderName)}</span>
                                <span>to ${esc(e.to)}</span>
                            </div>
                            <div style="font-size:13px;font-weight:600;color:var(--text);margin-top:4px;">${esc(e.subject)}</div>
                            <div class="call-history-notes" style="font-style:normal;white-space:pre-wrap;">${bodyPreview}</div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </td>`;
        row.after(histRow);
    } catch {}
}

// ‚îÄ‚îÄ SUPPORT TICKETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let allTickets = [];

function filterTickets(status) {
    ticketFilter = status;
    document.querySelectorAll('.ticket-filter-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderTicketList();
}

async function loadTickets() {
    try {
        const res = await fetch(`${API_BASE}/admin/support/tickets`, { headers: authHeaders() });
        const data = await res.json();
        if (data.success) {
            allTickets = data.tickets || [];
            renderTicketList();
            // Update badge
            const openCount = allTickets.filter(t => t.status !== 'resolved').length;
            const badge = document.getElementById('supportBadge');
            badge.textContent = openCount;
            badge.style.display = openCount ? 'inline-block' : 'none';
        }
    } catch (err) {
        document.getElementById('ticketsList').innerHTML = `<div style="color:var(--red);padding:20px;">Failed to load tickets: ${err.message}</div>`;
    }
}

function renderTicketList() {
    const filtered = ticketFilter ? allTickets.filter(t => t.status === ticketFilter) : allTickets;
    const container = document.getElementById('ticketsList');
    if (!filtered.length) {
        container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text3);">No tickets found.</div>`;
        return;
    }
    container.innerHTML = filtered.map(t => {
        const d = new Date(t.createdAt);
        return `
        <div class="ticket-card" onclick="showTicketDetail('${t._id}')">
            <div class="ticket-card-header">
                <div class="ticket-subject">${esc(t.subject)}</div>
                <span class="ticket-status-pill ${t.status}">${t.status === 'in_progress' ? 'In Progress' : t.status.charAt(0).toUpperCase() + t.status.slice(1)}</span>
            </div>
            <div class="ticket-meta">#${t._id.slice(-8).toUpperCase()} &middot; ${esc(t.userName)} &middot; ${esc(t.userEmail)} &middot; ${d.toLocaleDateString()}</div>
            <div class="ticket-preview">${esc(t.message)}</div>
        </div>`;
    }).join('');
}

async function showTicketDetail(id) {
    const ticket = allTickets.find(t => t._id === id);
    if (!ticket) return;
    document.getElementById('supportTicketList').style.display = 'none';
    const detail = document.getElementById('supportTicketDetail');
    detail.style.display = 'block';
    const d = new Date(ticket.createdAt);
    const assigneeOptions = staffList.filter(s => ['super_admin','admin','support'].includes(s.role))
        .map(s => `<option value="${s._id}" ${(ticket.assignedTo && (ticket.assignedTo._id || ticket.assignedTo) === s._id) ? 'selected' : ''}>${esc(s.name)}</option>`).join('');

    detail.innerHTML = `
    <button class="ticket-detail-back" onclick="closeTicketDetail()">‚Üê Back to list</button>
    <div class="ticket-detail" style="margin-top:16px;">
        <div class="ticket-detail-header">
            <div>
                <div style="font-size:20px;font-weight:700;margin-bottom:4px;">${esc(ticket.subject)}</div>
                <div class="ticket-meta">#${ticket._id.slice(-8).toUpperCase()} &middot; ${esc(ticket.userName)} &middot; <a href="mailto:${esc(ticket.userEmail)}" style="color:var(--accent);">${esc(ticket.userEmail)}</a> &middot; ${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
            </div>
            <span class="ticket-status-pill ${ticket.status}">${ticket.status === 'in_progress' ? 'In Progress' : ticket.status.charAt(0).toUpperCase() + ticket.status.slice(1)}</span>
        </div>
        <div class="ticket-detail-controls">
            <select onchange="updateTicket('${ticket._id}','status',this.value)">
                <option value="open" ${ticket.status==='open'?'selected':''}>Open</option>
                <option value="in_progress" ${ticket.status==='in_progress'?'selected':''}>In Progress</option>
                <option value="resolved" ${ticket.status==='resolved'?'selected':''}>Resolved</option>
            </select>
            <select onchange="updateTicket('${ticket._id}','assignedTo',this.value)">
                <option value="">Unassigned</option>
                ${assigneeOptions}
            </select>
        </div>
        <div style="background:var(--surface2);border-radius:12px;padding:16px;margin-bottom:20px;">
            <div style="font-size:12px;font-weight:600;color:var(--yellow);margin-bottom:6px;">Customer Message</div>
            <div style="font-size:14px;color:var(--text);line-height:1.6;white-space:pre-wrap;">${esc(ticket.message)}</div>
        </div>
        ${(ticket.replies || []).map(r => {
            const rd = new Date(r.createdAt);
            return `<div class="ticket-reply">
                <div class="ticket-reply-author">${esc(r.staffName)} <span class="ticket-reply-date">${rd.toLocaleDateString()} ${rd.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span></div>
                <div class="ticket-reply-msg">${esc(r.message)}</div>
            </div>`;
        }).join('')}
        <div class="ticket-reply-form">
            <textarea id="replyMsg" placeholder="Type your reply‚Ä¶"></textarea>
            <button class="ticket-reply-submit" onclick="submitReply('${ticket._id}')">Send Reply</button>
        </div>
    </div>`;
}

function closeTicketDetail() {
    document.getElementById('supportTicketDetail').style.display = 'none';
    document.getElementById('supportTicketList').style.display = 'block';
}

async function updateTicket(id, field, value) {
    try {
        await fetch(`${API_BASE}/admin/support/tickets/${id}`, {
            method: 'PATCH',
            headers: authHeaders(),
            body: JSON.stringify({ [field]: value })
        });
        loadTickets();
    } catch {}
}

async function submitReply(ticketId) {
    const msg = document.getElementById('replyMsg').value.trim();
    if (!msg) return;
    try {
        const res = await fetch(`${API_BASE}/admin/support/tickets/${ticketId}/reply`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        if (data.success) {
            // Update local ticket data
            const idx = allTickets.findIndex(t => t._id === ticketId);
            if (idx >= 0) allTickets[idx] = data.ticket;
            showTicketDetail(ticketId);
        }
    } catch (err) {
        alert('Failed to send reply: ' + err.message);
    }
}

// ‚îÄ‚îÄ EMPLOYEES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadEmployees() {
    try {
        const res = await fetch(`${API_BASE}/admin/staff`, { headers: authHeaders() });
        const data = await res.json();
        if (data.success) {
            staffList = data.staff || [];
            renderEmployees(staffList);
        }
    } catch (err) {
        document.getElementById('staffList').innerHTML = `<div style="color:var(--red);padding:20px;">Failed to load team: ${err.message}</div>`;
    }
}

const ROLE_COLORS = { super_admin: '#fc5c7d', admin: '#7c5cfc', sales: '#22d3a0', support: '#f5c842' };
const ROLE_LABELS = { super_admin: 'Super Admin', admin: 'Admin', sales: 'Sales', support: 'Support' };

function renderEmployees(staff) {
    const container = document.getElementById('staffList');
    if (!staff.length) {
        container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text3);">No team members yet. Invite your first employee.</div>`;
        return;
    }
    container.innerHTML = staff.map(s => {
        const initial = (s.name || s.email || '?')[0].toUpperCase();
        const color = ROLE_COLORS[s.role] || '#7c5cfc';
        const isPending = !!s.inviteExpires && !s.lastLogin;
        const isSuperAdmin = s.role === 'super_admin';
        const canDelete = currentStaff && currentStaff.role === 'super_admin' && !isSuperAdmin;
        const canChangeRole = currentStaff && currentStaff.role === 'super_admin' && !isSuperAdmin;
        const lastLogin = s.lastLogin ? new Date(s.lastLogin).toLocaleDateString() : 'Never';

        return `
        <div class="staff-card">
            <div class="staff-info">
                <div class="staff-avatar" style="background:${color}33;color:${color};">${initial}</div>
                <div>
                    <div class="staff-name">${esc(s.name)} ${isSuperAdmin ? '<span style="font-size:11px;color:var(--accent2);">(Owner)</span>' : ''}</div>
                    <div class="staff-email">${esc(s.email)}</div>
                </div>
            </div>
            <div class="staff-actions">
                ${isPending ? '<span class="staff-invited-pill">Invited</span>' : `<span style="font-size:11px;color:var(--text3);font-family:var(--mono);">Last: ${lastLogin}</span>`}
                ${canChangeRole ? `
                <select class="lead-assignee-select" onchange="changeStaffRole('${s._id}',this.value)" style="width:110px;">
                    ${['admin','sales','support'].map(r => `<option value="${r}" ${s.role===r?'selected':''}>${ROLE_LABELS[r]}</option>`).join('')}
                </select>` : `<span class="staff-role-pill ${s.role}">${ROLE_LABELS[s.role]}</span>`}
                ${canDelete ? `<button class="staff-remove-btn" onclick="removeStaff('${s._id}','${esc(s.name)}')" title="Remove">‚úï</button>` : ''}
            </div>
        </div>`;
    }).join('');
}

function openInviteModal() {
    document.getElementById('invName').value = '';
    document.getElementById('invEmail').value = '';
    document.getElementById('invRole').value = 'sales';
    document.getElementById('invSubmitBtn').disabled = false;
    document.getElementById('invSubmitBtn').textContent = 'Send Invite';
    document.getElementById('inviteOverlay').classList.add('open');
}

function closeInviteModal() {
    document.getElementById('inviteOverlay').classList.remove('open');
}

async function submitInvite() {
    const name = document.getElementById('invName').value.trim();
    const email = document.getElementById('invEmail').value.trim();
    const role = document.getElementById('invRole').value;
    if (!name || !email) { alert('Name and email are required.'); return; }
    const btn = document.getElementById('invSubmitBtn');
    btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
    try {
        const res = await fetch(`${API_BASE}/admin/staff/invite`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ name, email, role })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        closeInviteModal();
        loadEmployees();
    } catch (err) {
        alert('Invite failed: ' + err.message);
        btn.disabled = false; btn.textContent = 'Send Invite';
    }
}

async function changeStaffRole(id, role) {
    try {
        await fetch(`${API_BASE}/admin/staff/${id}`, {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify({ role })
        });
        loadEmployees();
    } catch {}
}

async function removeStaff(id, name) {
    if (!confirm(`Remove ${name} from the team?`)) return;
    try {
        const res = await fetch(`${API_BASE}/admin/staff/${id}`, {
            method: 'DELETE',
            headers: authHeaders()
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        loadEmployees();
    } catch (err) {
        alert('Failed to remove: ' + err.message);
    }
}
</script>

<!-- CALL MODAL -->
<!-- Email Compose Modal -->
<div class="call-modal-overlay" id="emailComposeOverlay" onclick="if(event.target===this)closeEmailCompose()">
    <div class="call-modal" style="max-width:520px;border-radius:16px;overflow:hidden;">
        <div style="padding:20px 24px;border-bottom:1px solid var(--border);">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <h3 id="emailComposeTitle" style="margin:0;font-size:16px;font-weight:600;color:var(--text);">Send Email</h3>
                <button onclick="closeEmailCompose()" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:20px;line-height:1;">‚úï</button>
            </div>
        </div>
        <div style="padding:20px 24px;">
            <div style="margin-bottom:14px;">
                <label style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px;display:block;">To</label>
                <input id="emailComposeTo" readonly style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--surface2);color:var(--text3);box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px;display:block;">Subject</label>
                <input id="emailComposeSubject" placeholder="Enter subject‚Ä¶" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg);color:var(--text);box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px;display:block;">Message</label>
                <textarea id="emailComposeBody" rows="8" placeholder="Write your email‚Ä¶" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--bg);color:var(--text);resize:vertical;font-family:var(--sans);box-sizing:border-box;"></textarea>
            </div>
            <div id="emailComposeError" style="display:none;background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:12px;margin-bottom:14px;color:#991b1b;font-size:14px;text-align:center;"></div>
            <button onclick="sendLeadEmail()" id="emailSendBtn" style="width:100%;padding:12px;border:none;border-radius:10px;background:var(--accent);color:white;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--sans);">Send Email</button>
        </div>
    </div>
</div>

<div class="call-modal-overlay" id="callModalOverlay">
    <div class="call-modal">
        <div class="call-modal-header" id="callModalHeader">
            <div class="call-modal-avatar" id="callModalAvatar">?</div>
            <div class="call-modal-name" id="callModalName">‚Äî</div>
            <div class="call-modal-phone" id="callModalPhone">‚Äî</div>
            <div class="call-modal-status" id="callModalStatus">Connecting...</div>
            <div class="call-modal-timer" id="callModalTimer">00:00</div>
        </div>
        <div class="call-controls" id="callControls">
            <button class="call-control-btn mute" id="callMuteBtn" onclick="toggleMute()" title="Mute"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button>
            <button class="call-control-btn hangup" id="callHangupBtn" onclick="hangupCall()" title="Hang up"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.96.96 0 0 1-.29-.7c0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28a11.27 11.27 0 0 0-2.67-1.85.996.996 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></button>
        </div>
        <div class="call-notes-area" id="callNotesArea">
            <textarea class="call-notes-textarea" id="callNotesInput" placeholder="Call notes... What was discussed?"></textarea>
            <button class="call-notes-save" onclick="saveCallNotes()">Save Notes & Close</button>
        </div>
    </div>
</div>

</body>
</html>
