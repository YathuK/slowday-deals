<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="format-detection" content="telephone=no, address=no, email=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>SlowDay Deals - Service Marketplace</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script src="api.js?v=98"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            overscroll-behavior: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overscroll-behavior: none;
            min-height: 100vh;
            min-height: 100svh;
            touch-action: pan-y;
            -webkit-text-size-adjust: 100%;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            height: 100vh;
            height: 100svh;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0 16px;
            position: fixed;
            top: 0;
            top: env(safe-area-inset-top);
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 58px;
            flex-shrink: 0;
        }

        .header h1 { display: none; }
        .header p  { display: none; }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0;
            flex-shrink: 0;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #666;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Provider View Styles */
        .provider-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .pw-eye {
            position: absolute;
            right: 12px;
            bottom: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .price-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .photo-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .photo-upload input {
            display: none;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .photo-preview img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Customer View Styles */
        .swipe-container {
            position: relative;
            height: 100%;
            min-height: 360px;
            padding: 12px 16px 16px;
            overflow: hidden;
        }

        .card-stack {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .service-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: grab;
            /* none: prevents native browser pan so horizontal card swipe isn't intercepted.
               card-content scroll is handled entirely by JS scrollTop (no UIScrollView). */
            touch-action: none;
            transition: transform 0.3s, box-shadow 0.3s;
            user-select: none;
            -webkit-user-select: none;
        }

        .service-card:active {
            cursor: grabbing;
        }

        .service-card.swiping-right {
            border: 3px solid #4ade80;
        }

        .service-card.swiping-left {
            border: 3px solid #f87171;
        }

        .card-image {
            width: 100%;
            height: 55%;
            object-fit: cover;
            touch-action: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            flex-shrink: 0;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-content {
            padding: 10px 14px 4px;
            height: 45%;
            overflow-y: auto;
            touch-action: pan-y;
            overscroll-behavior-y: contain;
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .service-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        .service-type {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .provider-name {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .service-description {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .price-display {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            align-items: stretch;
        }

        .price-box {
            flex: 1;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .price-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .price-value {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
        }

        /* Deal price badge — animated, eye-catching */
        .deal-price-badge {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
            animation: dealPulse 2s ease-in-out infinite;
        }
        @keyframes dealPulse {
            0%,100% { box-shadow: 0 4px 15px rgba(102,126,234,0.4); transform: scale(1); }
            50%      { box-shadow: 0 6px 25px rgba(102,126,234,0.7); transform: scale(1.02); }
        }
        .deal-price-badge::before {
            content:'';
            position:absolute;
            top:-50%;left:-60%;
            width:40%;height:200%;
            background:rgba(255,255,255,0.15);
            transform:skewX(-15deg);
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%   { left:-60%; }
            100% { left:120%; }
        }
        .deal-price-badge .price-label { color: rgba(255,255,255,0.8); }
        .deal-price-badge .deal-actual  { font-size:22px; font-weight:800; color:white; line-height:1; }
        .deal-price-badge .deal-normal  { font-size:12px; color:rgba(255,255,255,0.7); text-decoration:line-through; margin-top:2px; }
        .deal-price-badge .deal-pct     { position:absolute;top:6px;right:6px;background:#fbbf24;color:#92400e;font-size:10px;font-weight:800;padding:2px 6px;border-radius:20px;line-height:1.4; }

        /* Slots remaining */
        .slots-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #fef3c7;
            color: #92400e;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 8px;
        }
        .slots-badge.low  { background:#fee2e2; color:#991b1b; animation: slotBlink 1s ease-in-out infinite; }
        .slots-badge.gone { background:#e5e7eb; color:#6b7280; }
        @keyframes slotBlink { 0%,100%{opacity:1} 50%{opacity:0.6} }

        /* SlowDay+ card animations */
        @keyframes plusBoltBounce {
            0%,100% { transform: translateY(0) scale(1) rotate(0deg); filter: drop-shadow(0 4px 16px rgba(0,0,0,0.25)); }
            35%     { transform: translateY(-16px) scale(1.18) rotate(-10deg); filter: drop-shadow(0 18px 28px rgba(0,0,0,0.35)); }
            65%     { transform: translateY(-6px) scale(1.06) rotate(5deg); filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); }
        }
        @keyframes plusSignPulse {
            0%,100% { transform: scale(1); text-shadow: none; }
            50%     { transform: scale(1.55); text-shadow: 0 0 22px rgba(255,255,255,0.85); }
        }
        @keyframes plusCardShimmer {
            0%   { transform: translateX(-120%) skewX(-18deg); }
            100% { transform: translateX(280%) skewX(-18deg); }
        }
        @keyframes sparkleFloat {
            0%        { opacity:0; transform: translate(0,0) scale(0) rotate(0deg); }
            30%,70%   { opacity:1; }
            100%      { opacity:0; transform: translate(var(--sx,−20px), var(--sy,−40px)) scale(1.1) rotate(30deg); }
        }

        /* Ended deal card — visible but clearly marked */
        .deal-ended-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 7px 12px;
            z-index: 5;
            border-radius: 0;
        }
        .deal-ended-overlay .ended-text {
            font-size: 11px;
            font-weight: 800;
            color: #fff;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .deal-ended-overlay .ended-sub {
            font-size: 11px;
            color: rgba(255,255,255,0.75);
            font-weight: 500;
        }
        .service-card.deal-ended {
            filter: grayscale(0.2);
            border-color: rgba(220,38,38,0.35) !important;
        }

        .swipe-indicator {
            position: absolute;
            top: 50%;
            font-size: 80px;
            font-weight: 900;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .like-indicator {
            left: 30px;
            color: #4ade80;
            transform: rotate(-20deg);
        }

        .nope-indicator {
            right: 30px;
            color: #f87171;
            transform: rotate(20deg);
        }

        .service-card.swiping-right .like-indicator {
            opacity: 1;
        }

        .service-card.swiping-left .nope-indicator {
            opacity: 1;
        }

        .card-action-row {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 8px 0 2px;
            border-top: 1px solid #f0f0f0;
            margin-top: 4px;
        }

        .card-btn {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 12px rgba(0,0,0,0.12);
        }

        .card-btn:hover { transform: scale(1.1); }
        .card-btn:active { transform: scale(0.95); }

        .card-btn-nope  { background: #fff0f0; color: #f87171; }
        .card-btn-info  { background: #e0f2fe; color: #0284c7; }
        .card-btn-like  { background: #f0fdf4; color: #4ade80; }

        .no-cards {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-emoji {
            font-size: 72px;
            animation: bounce 1.2s infinite;
            margin-bottom: 16px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-16px); }
        }

        .empty-state h3 {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: #888;
            font-size: 14px;
            line-height: 1.6;
            max-width: 240px;
        }

        .empty-dots {
            display: flex;
            gap: 8px;
            margin-top: 24px;
            justify-content: center;
        }

        .empty-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            animation: pulse-dot 1.4s infinite ease-in-out;
        }

        .empty-dots span:nth-child(2) { animation-delay: 0.2s; }
        .empty-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse-dot {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        .no-cards svg {
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            touch-action: none;
        }
        .modal .modal-content {
            touch-action: pan-y;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .gallery img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .book-now-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Booking Form */
        .booking-form .form-group {
            margin-bottom: 15px;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Saved Services */
        .saved-list {
            padding: 20px;
        }

        .saved-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .saved-share-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5ff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
        }

        .saved-card img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
        }

        .saved-card-content {
            flex: 1;
        }

        .saved-card h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .saved-card p {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .saved-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .saved-card-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .book-btn-small {
            background: #667eea;
            color: white;
        }

        .remove-btn {
            background: #fee;
            color: #f87171;
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 20px;
            background: white;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .sso-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #999;
            font-size: 13px;
        }
        .sso-divider::before,
        .sso-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }
        .sso-divider::before { margin-right: 12px; }
        .sso-divider::after { margin-left: 12px; }

        .sso-btn {
            width: 100%;
            padding: 13px 16px;
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            color: #333;
            margin-bottom: 10px;
        }
        .sso-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .sso-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .user-menu {
            position: relative;
            right: auto;
            top: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .user-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.5);
            transition: transform 0.2s;
            user-select: none;
        }

        .user-avatar:hover { transform: scale(1.05); }

        .user-dropdown {
            position: fixed;
            top: 66px;
            right: calc(50% - 240px);
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.18);
            padding: 16px;
            min-width: 240px;
            z-index: 10000;
        }

        @media (max-width: 520px) {
            .user-dropdown { right: 8px; }
        }

        .user-dropdown-name {
            font-weight: 700;
            font-size: 15px;
            color: #333;
        }

        .user-dropdown-email {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
            margin-bottom: 8px;
        }

        .dropdown-btn {
            width: 100%;
            background: #f5f5f5;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            margin-top: 6px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-btn:hover { background: #ede9fe; color: #667eea; }
        .logout-red:hover { background: #fee2e2 !important; color: #e53e3e !important; }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .circle-login-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .circle-login-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .login-prompt {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }

        .login-prompt svg {
            margin-bottom: 20px;
        }

        .login-prompt button {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ---- Provider View ---- */
        #providerView {
            height: 100vh;
            height: 100svh;
            overflow: hidden;
        }

        /* ---- Provider Tabs ---- */
        .provider-tabs {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            background: white;
            position: fixed;
            top: 58px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            z-index: 90;
            box-sizing: border-box;
        }
        #providerView .tab-content,
        #ptabBookingsContent,
        #ptabCalendarContent,
        #ptabAnalyticsContent,
        #ptabProfileContent {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px;
        }

        #customerView .tab-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            padding-top: 58px;
            padding-bottom: 80px;
        }
        /* !important needed: #customerView .tab-content (specificity 1-1-0) beats
           plain #savedTab (1-0-0). padding-top: 45px clears the fixed .saved-subtabs bar
           (same height as .provider-tabs) so content starts below it. */
        #savedTab {
            padding-top: 45px !important;
        }
        #savedListWrap, #myBookingsWrap {
            padding-top: 0;
        }
        #ptabProfileContent,
        #ptabBookingsContent,
        #ptabCalendarContent,
        #ptabAnalyticsContent {
            height: 100vh;
            height: 100svh;
            box-sizing: border-box;
            padding-top: 103px;
            padding-bottom: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
        #customerView #discoverTab {
            overflow: hidden;
            height: calc(100svh - 145px);
            height: calc(100vh - 145px);
            margin-top: 58px;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            /* pan-y: browser handles vertical scroll (card content), JS handles horizontal swipe */
            touch-action: pan-y;
            overscroll-behavior-y: contain;
        }
        #savedTab {
            height: calc(100svh - 145px);
            height: calc(100vh - 145px);
            margin-top: 58px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            box-sizing: border-box;
            padding-bottom: 80px;
        }
        #bookingsTab {
            height: calc(100svh - 145px);
            height: calc(100vh - 145px);
            margin-top: 58px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            box-sizing: border-box;
            padding-bottom: 80px;
        }

        .ptab-btn {
            flex: 1;
            padding: 14px 4px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #aaa;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .ptab-btn.active { color: #667eea; border-bottom-color: #667eea; }
        .badge {
            background: #e53e3e;
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 10px;
            padding: 1px 6px;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* ---- Filter buttons ---- */
        .filter-btn {
            padding: 7px 14px;
            border: 1.5px solid #e0e0e0;
            background: white;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }

        /* ---- Booking cards ---- */
        .booking-card {
            background: white;
            border-radius: 14px;
            border: 1.5px solid #f0f0f0;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .booking-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .booking-card-title { font-size: 16px; font-weight: 700; color: #333; }
        .booking-card-sub { font-size: 13px; color: #888; margin-top: 2px; }
        .status-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-pending   { background: #fef3c7; color: #d97706; }
        .status-confirmed { background: #d1fae5; color: #059669; }
        .status-rejected  { background: #fee2e2; color: #dc2626; }
        .status-cancelled { background: #f3f4f6; color: #6b7280; }
        .status-rescheduled { background: #dbeafe; color: #2563eb; }
        .status-completed { background: #ede9fe; color: #7c3aed; }
        .booking-meta { font-size: 13px; color: #555; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; } .booking-meta a { text-decoration: none !important; color: inherit !important; } .no-link { -webkit-user-select: text; text-decoration: none !important; pointer-events: none; }
        .booking-meta span { color: #888; }
        .booking-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .action-btn {
            flex: 1;
            min-width: 80px;
            padding: 9px 6px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-confirm   { background: #d1fae5; color: #059669; }
        .btn-reject    { background: #fee2e2; color: #dc2626; }
        .btn-reschedule{ background: #dbeafe; color: #2563eb; }
        .btn-cancel    { background: #f3f4f6; color: #6b7280; }

        /* ---- Analytics ---- */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            border: 1.5px solid #f0f0f0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .stat-card .stat-label { font-size: 11px; color: #888; font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
        .stat-card .stat-value { font-size: 26px; font-weight: 800; color: #333; }
        .stat-card .stat-earn  { font-size: 13px; color: #667eea; font-weight: 600; margin-top: 2px; }
        .stat-card.highlight   { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; }
        .stat-card.highlight .stat-label { color: rgba(255,255,255,0.75); }
        .stat-card.highlight .stat-value { color: white; }
        .stat-card.highlight .stat-earn  { color: rgba(255,255,255,0.85); }
        .chart-bar-wrap { margin-bottom: 20px; }
        .chart-bar-wrap h3 { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 12px; }
        .bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .bar-label { font-size: 11px; color: #888; width: 72px; text-align: right; flex-shrink: 0; }
        .bar-track { flex: 1; background: #f0f0f0; border-radius: 6px; height: 20px; overflow: hidden; }
        .bar-fill  { height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 6px; transition: width 0.6s ease; min-width: 2px; }
        .bar-val   { font-size: 12px; font-weight: 600; color: #555; width: 36px; }

        /* ---- Customer bookings ---- */
        .my-bookings-section { padding: 16px; }
        .my-bookings-section h3 { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 12px; }

        /* ---- Saved sub-tabs ---- */
        /* fixed keeps the sub-tab bar pinned to the viewport at top:58px, identical to
           .provider-tabs. This survives iOS rubber-band overscroll because fixed elements
           are not children of any scroll container. JS shows/hides it with savedTab. */
        .saved-subtabs { display: flex; border-bottom: 1.5px solid #f0f0f0; margin-bottom: 0; position: fixed; top: 58px; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; background: white; z-index: 90; box-sizing: border-box; }
        .saved-stab { flex: 1; padding: 12px; border: none; background: transparent; font-size: 13px; font-weight: 600; color: #aaa; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1.5px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .saved-stab.active { color: #667eea; border-bottom-color: #667eea; }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            cursor: pointer;
            padding: 4px 0;
            border-radius: 8px;
            transition: opacity 0.15s;
        }
        .location-header:active { opacity: 0.7; }
        #mapChevron { transition: transform 0.25s ease; flex-shrink: 0; }

        .dir-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 11px 8px;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        .dir-btn:active { opacity: 0.8; }
        .custom-dt-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .dt-date-input {
            width: 100%;
            max-width: 100%;
            padding: 12px 14px;
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            color: #333;
            background: white;
            box-sizing: border-box;
            margin-bottom: 8px;
            display: block;
            -webkit-appearance: none;
            appearance: none;
            min-height: 46px;
        }
        .dt-date-input:focus { border-color: #667eea; outline: none; }
        .dt-time-row {
            display: flex;
            gap: 8px;
            margin-top: 0;
        }
        .dt-select {
            flex: 1;
            padding: 12px 10px;
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #333;
            background: white;
            cursor: pointer;
            text-align: center;
            appearance: none;
            -webkit-appearance: none;
        }
        .dt-select:focus { border-color: #667eea; outline: none; }

        @media (max-width: 600px) {
            .swipe-container { min-height: 320px; }
        }

        .search-bar-wrap {
            padding: 12px 16px 8px;
            background: #f8f9ff;
            border-bottom: 1px solid #eee;
            position: fixed;
            top: 58px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            z-index: 200;
            box-sizing: border-box;
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px 14px 10px 12px;
            overflow: visible;
        }

        .search-bar svg {
            display: block;
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            overflow: visible;
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            color: #333;
            background: transparent;
            min-width: 0;
        }

        .search-bar select {
            border: none;
            outline: none;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            background: transparent;
            cursor: pointer;
            flex-shrink: 0;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            z-index: 200;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            padding-bottom: env(safe-area-inset-bottom, 8px);
            height: calc(65px + env(safe-area-inset-bottom, 0px));
            overflow: hidden;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #bbb;
            font-weight: 600;
            gap: 3px;
            transition: color 0.2s;
            overflow: visible;
            min-width: 60px;
        }

        .nav-btn svg {
            display: block;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            overflow: visible;
        }

        .nav-btn.active { color: #667eea; }
        .nav-btn span { font-size: 10px; white-space: nowrap; }

        /* app-container no longer scrolls — each tab owns its own scroll area */

        #myProfileCard {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .profile-card-img {
            width: 100%;
            height: 220px;
            object-fit: cover;
        }

        .profile-card-img-placeholder {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 72px;
        }

        .profile-card-body {
            padding: 20px;
        }

        .profile-card-body h2 { font-size: 20px; color: #333; margin-bottom: 4px; }
        .profile-card-body .type-badge {
            display: inline-block;
            background: #ede9fe;
            color: #667eea;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .profile-card-body p { color: #555; font-size: 14px; line-height: 1.6; margin-bottom: 12px; }
        .profile-price-row { display: flex; gap: 12px; }
        .profile-price-box { flex: 1; background: #f8f9ff; border-radius: 10px; padding: 10px; text-align: center; }
        .profile-price-box .label { font-size: 11px; color: #888; font-weight: 600; text-transform: uppercase; }
        .profile-price-box .value { font-size: 20px; color: #667eea; font-weight: 700; }

        /* Swipe hint animation */
        @keyframes swipeHintPop {
            0%   { opacity: 0; transform: translateX(-50%) scale(0.75); }
            18%  { opacity: 1; transform: translateX(-50%) scale(1.06); }
            28%  { opacity: 1; transform: translateX(-50%) scale(1); }
            78%  { opacity: 1; transform: translateX(-50%) scale(1); }
            100% { opacity: 0; transform: translateX(-50%) scale(0.9); }
        }
        @keyframes shHandSwipe {
            0%   { transform: translateX(10px) rotate(0deg); }
            40%  { transform: translateX(-12px) rotate(-15deg); }
            55%  { transform: translateX(-12px) rotate(-15deg); }
            100% { transform: translateX(10px) rotate(0deg); }
        }
        @keyframes shPulseL {
            0%, 100% { opacity: 0.35; transform: translateX(0); }
            45%       { opacity: 1;    transform: translateX(-5px); }
        }
        @keyframes shPulseR {
            0%, 100% { opacity: 0.35; transform: translateX(0); }
            45%       { opacity: 1;    transform: translateX(5px); }
        }
        #swipeHint {
            position: absolute;
            bottom: 36px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 6px 28px rgba(102,126,234,0.55), 0 2px 8px rgba(0,0,0,0.18);
            color: white;
            border-radius: 50px;
            padding: 13px 22px;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.2px;
            white-space: nowrap;
            opacity: 0;
            animation: swipeHintPop 3.4s cubic-bezier(.34,1.56,.64,1) forwards;
        }
        #swipeHint .sh-hand {
            display: inline-block;
            font-size: 20px;
            animation: shHandSwipe 1.1s ease-in-out infinite;
        }
        #swipeHint .sh-l { display:inline-block; font-size:16px; animation: shPulseL 1.1s ease-in-out infinite; }
        #swipeHint .sh-r { display:inline-block; font-size:16px; animation: shPulseR 1.1s ease-in-out infinite; }
        .radius-btn { font-size:12px; font-weight:700; padding:6px 12px; border-radius:20px; cursor:pointer; border:1.5px solid #e5e7eb; background:white; color:#666; transition:all 0.2s; }
        .radius-btn.active { background:#667eea; color:white; border-color:#667eea; }
        .city-chip { font-size:12px; font-weight:600; padding:5px 11px; border-radius:20px; cursor:pointer; border:1.5px solid #e5e7eb; background:white; color:#666; transition:all 0.2s; }
        .city-chip.active { background:#ede9fe; color:#667eea; border-color:#667eea; }
        /* Google Places autocomplete dropdown — must sit above everything */
        .pac-container { z-index: 100001 !important; }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzFOIKj0VhPwBjEV2IQljeZ3Yw6l99jWI&libraries=places&callback=initPlaces" async defer></script>
</head>
<body>
    <!-- Floating discover pills — direct body child so position:fixed works on iOS Safari -->
    <div id="discoverPills" style="display:block;position:fixed;top:calc(env(safe-area-inset-top, 0px) + 72px);left:50%;transform:translateX(-50%);width:100%;max-width:500px;z-index:9999;pointer-events:none;box-sizing:border-box;">
        <!-- Search pill (left) -->
        <div id="searchPill" style="position:absolute;left:16px;top:0;pointer-events:auto;">
            <div id="searchPillInner" onclick="toggleSearchPill()" style="background:rgba(255,255,255,0.96);backdrop-filter:blur(8px);border-radius:25px;box-shadow:0 2px 16px rgba(0,0,0,0.14);display:flex;align-items:center;padding:9px 13px;cursor:pointer;transition:all 0.2s ease;">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#667eea" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="searchInput" placeholder="Search..." oninput="searchServices(this.value)" onclick="event.stopPropagation()" onblur="if(!this.value)toggleSearchPill()" style="display:none;width:150px;border:none;outline:none;font-size:14px;background:transparent;margin-left:8px;color:#333;">
            </div>
        </div>
        <!-- Right pills group: location filter + service type filter -->
        <div style="position:absolute;right:16px;top:0;pointer-events:auto;display:flex;gap:6px;align-items:flex-start;">
            <!-- Location pill -->
            <div id="locationPill" style="position:relative;">
                <div id="locationPillInner" onclick="toggleLocationPill()" style="background:rgba(255,255,255,0.96);backdrop-filter:blur(8px);border-radius:25px;box-shadow:0 2px 16px rgba(0,0,0,0.14);display:flex;align-items:center;gap:5px;padding:9px 11px;cursor:pointer;white-space:nowrap;transition:all 0.2s;">
                    <svg viewBox="0 0 24 24" width="15" height="15" fill="#667eea" style="flex-shrink:0;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    <span id="locationPillLabel" style="display:none;font-size:12px;font-weight:600;color:#667eea;max-width:70px;overflow:hidden;text-overflow:ellipsis;"></span>
                    <span id="locationClearBtn" onclick="clearLocationFilter(event)" style="display:none;color:#667eea;font-size:16px;line-height:1;font-weight:700;margin-left:-2px;">×</span>
                </div>
                <!-- Location panel -->
                <div id="locationPanel" style="display:none;position:absolute;top:calc(100% + 6px);right:0;width:290px;background:white;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.2);z-index:10000;padding:16px;pointer-events:auto;box-sizing:border-box;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                        <span style="font-size:14px;font-weight:700;color:#1a1a2e;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Filter by Location</span>
                        <span onclick="toggleLocationPill()" style="font-size:22px;color:#bbb;cursor:pointer;line-height:1;font-weight:300;">×</span>
                    </div>
                    <button onclick="useMyLocation()" style="width:100%;border:1.5px solid #667eea;background:#f5f3ff;color:#667eea;font-size:13px;font-weight:700;padding:9px 14px;border-radius:25px;cursor:pointer;margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:6px;box-sizing:border-box;">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="#667eea"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Use my location
                    </button>
                    <div style="margin-bottom:12px;">
                        <div style="font-size:11px;font-weight:700;color:#aaa;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Cities in Deals</div>
                        <div id="locationCityChips" style="display:flex;flex-wrap:wrap;gap:6px;min-height:26px;"></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;height:1px;background:#eee;"></div>
                        <span style="font-size:11px;color:#bbb;font-weight:600;">or search</span>
                        <div style="flex:1;height:1px;background:#eee;"></div>
                    </div>
                    <div style="margin-bottom:14px;">
                        <input type="text" id="locationSearchInput" placeholder="City or address..." autocomplete="off"
                            style="width:100%;border:1.5px solid #e5e7eb;border-radius:10px;padding:9px 12px;font-size:13px;outline:none;box-sizing:border-box;color:#333;font-family:inherit;"
                            onclick="event.stopPropagation()">

                    </div>
                    <div>
                        <div style="font-size:11px;font-weight:700;color:#aaa;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Radius</div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">
                            <button onclick="selectRadius(5)" data-radius="5" class="radius-btn">5km</button>
                            <button onclick="selectRadius(10)" data-radius="10" class="radius-btn">10km</button>
                            <button onclick="selectRadius(25)" data-radius="25" class="radius-btn">25km</button>
                            <button onclick="selectRadius(50)" data-radius="50" class="radius-btn">50km</button>
                            <button onclick="selectRadius(100)" data-radius="100" class="radius-btn">100km</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Filter pill -->
            <div id="filterPill" style="position:relative;">
                <div onclick="toggleFilterPill()" style="background:rgba(255,255,255,0.96);backdrop-filter:blur(8px);border-radius:25px;box-shadow:0 2px 16px rgba(0,0,0,0.14);display:flex;align-items:center;gap:6px;padding:9px 14px;cursor:pointer;white-space:nowrap;">
                    <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="#667eea" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
                    <span id="filterTypeLabel" style="font-size:13px;font-weight:600;color:#333;">All types</span>
                    <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="#667eea" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
                <div id="filterTypeDropdown" style="display:none;position:absolute;top:calc(100% + 6px);right:0;min-width:180px;max-height:300px;overflow-y:auto;background:white;border-radius:14px;box-shadow:0 8px 40px rgba(0,0,0,0.18);z-index:9999;pointer-events:auto;">
                    <div class="custom-select-opt" onclick="pickFilterType('','All types')">All types</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Haircut','Haircut')">Haircut</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Barber','Barber')">Barber</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Cleaning','Cleaning')">Cleaning</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Massage','Massage')">Massage</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Nails','Nails')">Nails</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Spa','Spa')">Spa</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Personal Training','Personal Training')">Personal Training</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Dog Walking','Dog Walking')">Dog Walking</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Tutoring','Tutoring')">Tutoring</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Photography','Photography')">Photography</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Car Detailing','Car Detailing')">Car Detailing</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Laundry Service','Laundry Service')">Laundry Service</div>
                    <div class="custom-select-opt" onclick="pickFilterType('Other','Other')">Other</div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="filterType" value="">

    <div class="app-container">
        <div class="header" id="mainHeader">
            <!-- Left: Logo directly on gradient -->
            <div class="header-logo" style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="showTab('discover')">
                <!-- Icon: calendar + bolt on gradient -->
                <img src="data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCAEAAQADASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAAAgABAwcIBAUG/8QAUxAAAQMDAQQEBQ0NBgQHAAAAAQACAwQFEQYHEiExCBNBURQiI3GTMjdSVGFydIGxtMLR0hUWJDM2QlVXdZGSlaEXRWJlhcEmQ2SCU3aDw+Hw8f/EABsBAQEAAgMBAAAAAAAAAAAAAAABAgQDBgcF/8QANREAAgEDAAYIBgIBBQAAAAAAAAECAwQRBRITITFxBhYzQVGRobEVIjRSYYFC0TIkweHw8f/aAAwDAQACEQMRAD8AxkkkkgEkkkgEkkvsNCbNtW6xa2qtdskjtgmbHNcagiOniBOC7edje3cHIbkj4wrGLk8JZYPj0+D3LRlk2D6UoJ2vvepKy9GObPVW+AwRSx4HAyP8ZpzniAeGFYA0xoenroqu16C0/RyReo6yJ04zjGS17i0/GF9Sjoa6q73HHMyUWzGeFM2jqnAObTTEHiCIzx/otnPttokdl2ntOD3tmpx9Fe/HqO/xRMiiu9THExoYxjDuta0DAAA5ADhhbi6O1u+a9S6jMJ+BVntWf0Z+pLwKr9qz+jP1LdbtSaiP991vpCm++LUP6brvSlXq5V+9epdmzCvgVX7Vn9GfqS8Cq/as/oz9S3WNRah/Tdd6UohqHUH6brfSlXq5V+9eo2bMJeBVftWf0Z+pLwKr9qz+jP1Ld41DqA/31W+kKMahv/6arfSlOrlX716jZswb4FV+1Z/Rn6kvAqv2rP6M/Ut6DUN//TNb6UpjqDUB/vqt9KU6uVfvXqNmzBngVX7Vn9GfqS8CrPas/oz9S3n98GoP03W+kKf74dQ/put9IU6uVfvXqXZMwX4FWe1Z/Rn6kvAqz2rP6M/Ut5/fBqD9N1vpCn+7+of03W+kKdXKv3r1GyZgp1JVNaXOppg0DJJjOAocLfFRer3U00tNU3SeogmYY5YpvHY9pGC1zTwII4EFeNBabPDxbpzTTvf2anP0Vi+jtbumvUbJmIMHuTLatZpXRFfVTVF10Bp+qkmZuOfBEaYtG7ugtEZDQQO3HPnlVrqLYDYKtssuntR1Func+R8dNc4d6INwSyMSs45zgbzgBjitOvoW7pb9XK/Bi6ckZ0SX1et9nesNGxMqb9ZpoaKV5ZDWRuEsEhBIGHtJAzgkA4JHHC+UXy5RcXhmAkkklAJJJJAJJJJAJHDFJNMyGGN0kj3BrGNGS4ngAB2lC0FxAAJJ5ALT+yDQTdBUMV0uELHapq4945cXNoIHxtIY6NzRifJOTx3cDB5rZtLSpdVFTgVLJ5Gy/Y9RWCT7pa9oGVl2Y9rqe0mVr4Yhu5JqcZ3jkjyYPAtO9kcFas881SIxPJvMiaGRRNaGxxNAwA1owAMAD4lyM5kkkknJJPEnvKkBXeLOwo2kcQW/x7zkSSJG4RhRgosrdKGllDlLKoHToU4KGSCCIIAUQVKSBOCgCIIAwUSjBRAoUIIhjuQZRZQDjCfATBOhR0/DuTBPlALAPYkWgjBGR7qcJKAZ8UMlHLRVFNT1VFMWmakqYxLBLggjeY7IOCAqZ2xbFqavc697PqAwTnrJa20daN0DBdvU2eY4EdXkuzjGRwF0ZSBIILSQQcgg4IPePdWje6Oo3cfmWH4mMoqRg97XMcWuBDgcEHsTLVm2nZvSazs9RdbRS0tPqakj60vHkxXQRtO8wgYb1oHEO5uDQFlM8F0i7tKlrU2c/wD012mmJJJJapBJJJxxKAuHo0aZgqLtVazuMMjqezPYKBpaDHPWE5a12QQ5rG+MQOPqO9XaHSPe+SV7pJZCXPe45LieZK8rRVmGnNn2nrA6ExVDaY11Y10IY/r5uOHY5lrNwAnjjC9ULvOh7VULZSa3y3v/AGM1uDCMFA0ogvqlySNKIFRAogVSkgSQgp8+6hQkkOUsqgIFGCo8pwULklDkQKiBTgoUmBSygDk+QhQwUQco8pwUBKCiyogUYKhQ8p8ocpZQuQspwUGUt5AHlJBvIgVQJrnskbJE8skYQ5jgcFpHIrOvSh0hR2jUVJqi0wCCjvbXOqIIoC2KmqWYD2tI4eOPKY7MnhjC0Uvntq1tde9kuprS2OomkjhZcaeOHGTJC7xic/miMvJ5epXx9N2yrW7muMd/9mFRZRjJJOeaZdHNcS9rQtrrr1rG0Wu20/hFXU1kTI48gAneHMngB3k8AvFVrdFCfwbbZbJs43KOuPP/AKWVZQjrSS8QaBvdZ4ffLhWjG7NUvc3AwN3PBcoK56Y+Rb7uflUwK9MjFRWqu4zySAowVECiBVBICiBUYKIFCkgKWUGUsqlDBRZUeUgULkkCcFAClntQEgKIFTWq33C6ydVbKOaqf/gad0ecr7WzbKNTVrGvrJIKBh7PVkfIuCtdUKHaSSJrI+Fyl1jQeLmj41cFBsVtzSDXXiqnPaGDcC96j2VaTp8b1NLMR/4jsr51TTtnHg2/0TXKCEsfs2/vRCRnYSfMCtI0+htLQHLbPSn3zMrvZpqwMGGWijHmiC1ZdIqPdBjaGYmuB7HfwlGHtHPe/hK079wLKOVrpPRhI2GzHnbKX0YWPWKn9j8y7QzIHNI4E/GMJEq7NrOnrOzSU1VFTQUssBDmPY0An3FSGeAX1rC8jeU9eKxvM4yyg8pZUeUQct4yCRAoAU4KAkBXVapzT3OmkG6cyCMhwyCH+Lx9ziuMFDI8s3ZBzY9rh8RysJRUouL7w+BibUlsmsuoblZqmSKSegq5aWR8ZJY50by0lueOMjgvPX3O3y0xWXbFqWhgnknYaw1G+8AHMrWykcO4vI+JfDLzOS1W0aolZfRqbKNqdPNHFI9sVBWukc1pIYDTSNyT2DJAye0gdqrRWv0X4LtLr6vlt8r2UsFmq33FrZd0PhLN0Aj84da6I47wD2Lmte3hzXuC7YTiNo9xSAqKI+I3zIwV6T3mRICiBUYKIFASAogVECnBQqJcpwVGCnyhQ8pwVEXJb+ByJ9wdqhCYFxIaxrnuccNa0ZJPcFamgNk8tY2K5amcWRHxmUjeB/7ivX2M6BZRwQ6ivDA+rkG9TxEcIW9591WuOC6xpTTMlJ0qD5v+iNnHarXQWunbT0FLFBG0YAa3H9V2pJLrEpOTyzESSSSgEkkkgEmSK+F2n68ptOUbqOjc2a5yjDGA/i/8TlzUKE681CCy2VLJ8tt01HHUTRaeppA4RkSVBB7exqq/eUcs0tRPJUTyGSaVxfI89pKQK7/Z20bWkqce73OZbtxJlLKAFPlbZlkMFECo0QKAkygnOYz5ksoJT4h8xRFKA6XlJR0+1aGopYBE+stFJUVBBJ6yUsLS7jy4Nby4cFTiuPpcO39pFud/kVH9NU4vNrlYrTX5ZrPiJW90VrtTW7Wl7op2ymS52CqpYCwAgPaWSku48BuxO7+OFUKsPo8eufTfAa35tIlr28Oa9yF+wHybfMpAVzwO8m3zKUFekviUlBT5QApwUKGCiBUeU4KAkynBQApZQoRK+y2P6aOotWxvmZmioiJZc8nO7G/7r4p791pcewZWjdgtm+5eiIqiVgE9Y8yuPbjPD+i+bpe6dtbNx4vcjFssFrQ1oa0AAcgE6SS6CQSSjnljghfNM9rI2DLnOOAAqi1ntkip6l9Hp2mFSWHBqJPUZ9wdq2rWzrXUtWkslSyXBlJZon2m6ymkL/uiyLJ9SxpAC9aybXdRUkjRXxQ10Q9VjxXL6cuj90llNP8AYwaCQve1jS5xAA5kr5HTG0TTd7pt/wAMZSTNGXxTkNI/fzVcbWtostxqZLLYapzKNnizVEZwZD3A9y07fRdxWrbJxxjjnuCWWe/tL2pQ0PW2rTxE9XxbJUD1EX1lUs+Waed9RUSumnkO8+RxyXFRjA5cEYK7nZ2NK0hqwW/vficqWCRpRAqMJwVt4KiUFOCowU+VSkgKIFRAogUBJlRzO8m7zFLKind5J3mKq4lKF6V5ztDtp/yKk+mqgVudKk51/bD/AJHSfTVRrze8+onzfua74iVh9Hn1zqb4DW/NpFXisLo9+uZT/Aa35tIsbXt4c17kL3hPk2+ZSgqCE+Tb5lKCvSWUlaUQKiBRAqAlCSEFOqUPKfKAFOgJqSA1VbT0jec0zI/3nC1/ZaVtFaaSkYABFC1mB7gWV9nlMKzXdngIyDOHH4uK1m3kuq9JKnzwh+MmI6Y8AnQSndjcR2An+i6yCktvusJnVn3rUE7mMa0OrHMOCc8mqomAAYHABehrColq9YXepmzvvqnA57gvOC9FsLeNvQjCP75maDCLPFCEvMtwo5AJyRx707QAMDgEPFOCrkpIEQKAJKFJQUSiBRBygJAU+VGCiBQoaWUOUsoMh5UVQfIv96USiqD5F/vT8iq4lKH6U/5e2z9hUn01UitvpT/l7a/2FSfTVSLze8+onzfucD4iVhdHr1zKf4BW/NpFXqsHo+HG0uD4BW/NpFja9vDmvchekJ8k3zKQFQQnybfMpQV6SwSgogVECiBQEoKLKjBTgoXJICizwUYKIHggPs9i0Ql2kW7I9SHH+i1AOSzHsNI/tHoePNrvkWnAum9IX/qY8v7IOmcMtIPanSXwQZW2p2qS0a9uUL2kMmf18R7w7/8AF8y3JIA4k8gtKbXdEN1TafCKJrW3SmBMJ9mPYlZrrG1dvrH09RA6nrad2XRPHEEfKF33RV7G5opfyXEyT3Ht1ektU0lI2rmsdWIHAEPaAeB+NeO7ejOJY5Iz2hzCtFbLtotl1PaYKSpljpblGwMfTyduOGR2FfZ1VntdUcz0MEnnYFoT07VoTcK9PehrGQetZ7I/wlO1wPIOJ9xpWtRpuxDla6b+BTRWS0xeot9O3/sCdZafdTfmNYyVHBVSnEVFUv8AexlNI2SKQxzRSRPHNrxgrYDKSlYMMp4m+ZgVVdIm00LbHS3ZkTI6qOYR7zRjeaexZ2unVcVo03DGfyEylAU+UATgr72TPIYKIFRgogVShgp8oE+UAWVFUHyL/elGSopz5J/vT8iqBRXSl/Ly1/sKk+mqlVsdKLjru1/sOk+mqnXm959RPm/c4mJWD0ffXKg+AVvzaRV8rC6PfrmQfAK75tIsbXt4c17kLtgPk2+ZShQQHybfMpQV6SyZJAUQKAFOChSVpRAqHKMFASAogVGCnygPrNlFbHQ7QrTNK8MY6QsJPLiMBasDhjORjzrE5JBBBLSDkEHBBXvP1zq99G2iN8qBC0boxjex518XSeiZXlSM4ySwsMhraSpgj9XNG3zvChNyoAcGsgz78LG9TcLhUHM9wq5Se10h/wBlzF8p/wCfN6R31rSXRtd9T0/5KbYhqIJhmKaN/vXAr43aRs7tGr6Z0rmmluLR5OpjGDnud3hZltd1ultnbNQ3Kqp5GnILZCflVv6B20GNjKLVjBw4Nq4mnB98O9cNXQ1zaPa28s48OIKj1BZbvpa/vt9wa6CriO9HLGcbzexwKtnYjtMrJrjFprUMwkDxikqXcyfYuXgbfNT2LUNfbmWeRtRJC0ukmaMDB5NVcUU76WvpaiI7r46iNzSPfBfd2HxCzW3jiWPJjuNtJ1zWyV09uppnc3xNcfjC6V0BrDwBKq+ki7/hOkbnnVNVqKnOktUfgNqpd4ZdM5xHmC+homObyHMseJS4PFFlRg8U4K78ZB5TgoQU4KpkGCnygCdCjkqOoPkX+9PyIiVHUHyT/en5FkgUZ0ofy6tf7CpPpqp1bHSh/Lq1/sKk+mqnXm159RPmzhYlYXR69cyn+AV3zaRV6rD6PPrmwfAK75rIsbbtoc17guiA+Tb5lKCuanPkm+ZTAr0p8TDJK0ogowUQKhckgKcFACnyhckgKcOUeU+UKGShygLkg4IA0kdLDPVTCClhknmIyGRtycIJg6CUx1DHwSDm2Rpaf6oms4ATU5TM48uKIjgskCEtA5ADzLv07b5rtqK326Bhc+aoZwHcCCfkXJBHLUzCClifUTOOGsjGSStA7DdnMtixqG8sxcJWYihI/EtP+609IX0LSi5Se/uQLXpYhBTRQt5MYGj4gpUkl5y94GWd+kNcRUa1p6Jrsilgy4Z7TkLQs72xQvkccNaCSVkXWV0detXXO5uPiyzuaz3oPBfe6P0dau5+C9yo83PFOCowiC7iZEoKcFRgpwVQSAosqMFPlC5CKiqPxD/en5EeVFVn8Gl9475Fki9xR3SeOdb2o/5FSfTVUq1ek3+Wto/YNJ9NVUvNrz6ifN+5xCVidHb1z6f4BXfNZFXasXo6+uhT/AK75rIsLbtoc17hlv0p8i3zKcFctMfJN8ynBXpb4nGStKMFRAogUKSAp8qMFPlMFDynyo8p8oVDuKntFvrrxdIbXa4DUVkxw1g/NHee4KbT9muOoLxBabXCZKiY4zjgwdritTbMtBWzRtrbHE1s9c8ZnqXN8YnuHcF8zSOkYWcccZPghxOfZLs/pNG2jMu7PdJxvVE+OR9iPcC9/UGlLBfY3NuVsp53H88sG8PjXtp10id1VnUdVy+ZlKtr9iGlJ5C+nlq6bPY15ICgpNhmm45g+etrZmj83ewrZSWytK3iWNoweBprSGn9PRhtst0MTx/zC0F5+Ne8nSWlUqTqPWm8sCSSXPcKuCho5aqplbFDE0ue5xwAFik28IHxe23UYsGjJmxPAqaw9REM8ePM/Esys4NA/evpdpurpNX6kfVty2hgJjpmZ5j2Xxr5lpXe9FWjtqCUv8nvZSROhBThfUKEEQKjyiBQoQRZUeU+UBJlQ1p/A5j/AID8iIFQXF+7QTn/AAH5FkuJW9xSvSc/LSz/ALAo/keqpVr9J0Y1pZv/AC/R/I9VQvNbvt582cYlY3RzGdqNMP8AoK75rIq5VmdGeMy7WqOMfnUNd81lWNu8VY817hlp0x8k1TNK5qT8S3/72qcL0t8TiJQUYKhBRgqFJAeKWUGU4KZKGCpqKnnrK2CipYzLUVEgjiYO1xOP3LnV19GPScdXUVGraxge2JxgpA4epI5u/r/Ra15dRtaLqP8A6wWVsn0NS6PsTGvayW4zjeqZscc+xHuBfbpJLz2tWnWm5zeWzMSSSS4gJJMlkIB0lwXG8Wu3xOlrK+nha3mXPCrTWW26xWzfp7LFJc6kcA5vBg8+Vs0LStcPFOLYLQudfR22jkq62ojghjGXOe7AWbNrm0ifVszrZbDJBaI3nJzh1Qfsr5bV+sb/AKqqjJdKx/U5yynY4hjfrXhA8MLtejdDRt3tKu+XogTN4ADsRsKhBUjSvt4KiYFPlRgpwVSh5TgoMp8oA8pZQZTZQZJN5cd4d+BuYDzB+RdGV59xfvtk7g3CJ4JJ7iqelJGY9cWdp5/e/RfI9VKrY6VNypq7afFS07JWuttpo6KbfAAMjY94luDyw8c8dqqdea3DzVk/yyCVi9G64vt22nThjp2TmrqHUJa8kACdjoi7h2gPyB2kKul1WqoFJc6aqdv7sMzJDuHDsAg8Pd4Lii8NMGlIWmNpYRgtc4H95UgXdqxtPHqaudSkeDVDxVU+HA+TkAcOI4Hnjh2hec05XptOaqRU13nCSgowogUYKyKGCkmCdCjgq2Njm1S36Q0+6yXakndEyQviliGeB7CFUyYrXubanc09nU4DJpf+3jR+Pxddnu6n/wCVE/b3pUDxaWvd/wCks2fGlk96+ctBWng/MuszRE/SAsbQeotNbIewEYyvKrOkFK7hSacd53zBUbk96cedckdC2cf45/Y1mWrcNumq58iko6SlB5Zw7C+buW0nW9xz1t+mhB/NgJYvjwjatqnY21P/ABgvIZOmtqqqueZK+rqKt57Zn7yhAAGAAB3JgnW0ljci5HCIFAEQVKiQFG0qMFEChSUFECogUWULkkyllRlybeVBLvBNlRFybeVwUKaURxl3b2LjiYZ6iCn7Zp44/wCJwH+6Com62Xh6lvJdFpuFttNTJfLwyeS22uF1XUiFm88gYawAd5eWj3M5XBWmqcHN8EjBvJQO3G5vu21zU1TJTMp3R1z6Xq2OJAEOIQePeI8/Gvi0Uji+Rz3EkuJJJOSUK81by8lEkkkoDQez660V62Y2p8dVUS3SzOdRXBkjcBkLnuNOWnkW43m94I8xPssKprY3qel07qoQXWWOGy3RraS5yGnEr44d8O3mdocC0HI44yrmqaeW31RpJpGTAAOhqInB0dRGRlsjHDgWkY4hd00FeKrR2T4x9jjksMkaUTVEw5PNShfdZiGE6FLKhQkxSymQCSSSQCRBCnBQuQwiCAFECgCCJAnBVKGnCDKfKGRICnBQAp8oMkgKfeUeUiUGQ8pEoMoS7v4BXBQyVx1VRzjYfOU1TU5BZGfOVyE4TJGyTfxzOF4W12+O09szNr6iqjrdTvDmStcGsFHC7xmkczvSY7vUZz2L37bTR1Uk89ZI6C1UMRqblVBpcIIW8+XMnkB3kKhNp2qH6w1pX3oMkhpXuEVFA8/iKdnixs4cMho445uLj2rrun7xQp7CL3vjyIj5lJJJdPMhJJJIBK4djOsbPNZnaO1RWsoOpc+a0XOZx6uBxGXQSd0biMgj1Lic+q4U8kuahXnQqKpB4aI1k01Kyoo6k01TEYZgA4MPEOaeIc08i0jiCOBBUjJgefBVds92oG30NLpzVtK652OHydPNGQ2qoAXAksdjx2gb3k3cO4tVoUrLXdpHO0nfaTUkAD3hlOCyqaxpALnwuAeBxHHC7pY6Xo3KSk8S8P6ONxaJgQeRT5XE1+HFuS1w5hwII/ejErx3FfVyQ6cp8rlM5HMJdeO0JlFOrKYlc4nai65qZQJsogVz9c3vTiZnemUU6QU4K5xNH7JP18fslcoHQCnyoBNH7JP1sfskyUmynDlB10fs0uuj9kmS5OkFOHLm6+P2SXhDOw5TKGTqJCW8uN9SfzQoXSPceJTKGTtknY3tye4Lmmme8cTgdyiyO8BHSQVNdUtpaClnq6hxw2OGMuJUciNkZKmt9KKsmWWrpaGhY8NqK6qlEcEI5nLjzOATujicHguW53XSGnrdUV+o9QUdTUQl7IrNbqgSVMsrSAY5HNBEIyeLj3HAJGFS+0bX921pPDFPFT0NrpHPNFQUzcRwhx5k85H4wC93Hh2DgviX2mqVBatL5peiCWT1drWu4r4G6dsMfUWCkn65rnsb19TNuBjpHvBOW53t0DHA8clV2kkun1as6s3Oby2ZiSSSXGBJJJIBJJJIBKegraygqm1VDVT0tQzIbLDIWPbkYOCOIyCQoEkBadl23akipZabUdvtmqGuHk5bgxwmiwGgBr4y04wORzxJK9zS20/Q9c57NU2e7Wh5Ly2e0zCaMDA3W9VIQc5zk7+OXBUgktyjf3NFYhNkaTNAVOuNl+8TTX3UwHYJLUw/+6vbbW7NpImSt2r2qPfYHbkltqQ5uRnBwwjI5HBKzInye9ba05eL+S8kTURprwvZ1n12LL/Lqr7CJtXs47drNl/l1V9hZjye9LJ71fjt34ryQ1UadNXs2HLazZj/AKdVfYUT67Z6D4u1ayn/AE+q+wsz5Pelk96fHbvxXkhqo0uK/Z927VLJ/L6r7CMV2zz9a1lH+nVX2FmXJ70snvV+O3fivIaqNNit2d/rYsv8uqvsJxXbOu3azZf5dVfYWY8nvSye9Pjt34ryQ1Uad8N2c/rZsv8ALqr7CXh2zn9bFl/l1V9hZiye9LJ71Pjt54ryQ1UacNfs6/WvZf5dVfYTG4bPRy2rWX+X1X2FmTJ70snvV+O3fivJDVRpauvOzqjt81W/aXR1rowMU9FbZzLJkgeLvta3tzxcOAK86j1zsn3x4bfNVubnj1VsjB/rKs85KSxlpy8f8sfpDVRcly2vWClucbrFo7wqkY3xvuvWvkc92TxxHuhoxjhxOc8V81qba9ri90wo2XJloosNzS2qPwaMlpOHHd8YnxsZzxwF8AktKte16/aTbLgSSSS1SiSSSQCSSSQH/9k=" onclick="showTab('discover')" style="width:38px;height:38px;flex-shrink:0;cursor:pointer;mix-blend-mode:screen;" />
                <!-- Wordmark -->
                <div>
                    <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:18px;font-weight:800;color:white;letter-spacing:-0.3px;line-height:1.1;text-shadow:0 1px 4px rgba(0,0,0,0.15);">SlowDay</div>
                    <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:9px;font-weight:700;color:rgba(255,255,255,0.75);letter-spacing:2.5px;text-transform:uppercase;">DEALS</div>
                </div>
            </div>

            <!-- Right: savings badge + avatar / login -->
            <div class="user-menu" id="userMenu" style="display: none;">
                <div id="savingsBadge" onclick="showSavingsCelebration()" style="visibility:hidden;background:rgba(255,255,255,0.2);backdrop-filter:blur(8px);border-radius:16px;padding:4px 10px;margin-right:4px;border:1px solid rgba(255,255,255,0.3);cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size:9px;color:rgba(255,255,255,0.75);font-weight:600;text-transform:uppercase;letter-spacing:0.3px;">Saved</div>
                    <div style="font-size:14px;color:white;font-weight:800;line-height:1;margin-top:1px;" id="savingsAmount">$0</div>
                    <div style="font-size:8px;color:#fbbf24;font-weight:700;margin-top:1px;" id="savingsRank">Top 1%</div>
                </div>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()"></div>
            </div>
            <div class="user-menu" id="guestMenu">
                <button class="circle-login-btn" onclick="showAuthModal()" title="Login / Sign Up">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
            </div>
        </div>

        <!-- User Dropdown — outside header so it's never clipped -->
        <div class="user-dropdown" id="userDropdown" style="display:none;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;cursor:pointer;" onclick="openUserProfile()">
                <div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;" id="dropdownAvatar"></div>
                <div>
                    <div class="user-dropdown-name" id="userDropdownName"></div>
                    <div class="user-dropdown-email" id="userDropdownEmail"></div>
                </div>
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#aaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left:auto;"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </div>
            <hr style="margin:4px 0 10px;border:none;border-top:1px solid #f0f0f0;">
            <button class="dropdown-btn" id="providerDropdownBtn" onclick="document.getElementById('userDropdown').style.display='none'; switchToProvider();"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>My Provider Profile</button>
            <button onclick="document.getElementById('userDropdown').style.display='none'; showSlowDayPlusModal();" style="width:100%;padding:11px 14px;margin-top:8px;margin-bottom:8px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>SlowDay+</button>
            <button class="dropdown-btn logout-red" onclick="logout()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>Logout</button>
        </div>


        <div class="mode-toggle" id="modeToggle" style="display:none;">
            <button class="mode-btn active" onclick="switchMode('customer')"><svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>Find Services</button>
            <button class="mode-btn" onclick="switchMode('provider')"><svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>I'm a Provider</button>
        </div>

        <!-- Customer View -->
        <div id="customerView" class="view active">
            <div id="discoverTab" class="tab-content active">
                <div class="swipe-container">
                    <div class="card-stack" id="cardStack"></div>
                </div>
            </div>
            <div class="saved-subtabs" style="display:none;">
                <button class="saved-stab active" id="stabSaved" onclick="switchSavedTab('saved')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>Saved</button>
                <button class="saved-stab" id="stabMyBookings" onclick="switchSavedTab('mybookings')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path><rect x="9" y="3" width="6" height="4" rx="2"></rect><line x1="9" y1="12" x2="15" y2="12"></line><line x1="9" y1="16" x2="11" y2="16"></line></svg>My Bookings</button>
            </div>
            <div id="savedTab" class="tab-content" style="display:none;">
                <div id="savedListWrap">
                    <div class="saved-list" id="savedList"></div>
                </div>
                <div id="myBookingsWrap" style="display:none;">
                    <div class="my-bookings-section" id="myBookingsList">
                        <div class="empty-state"><div class="empty-emoji">📍</div><h3>No bookings yet</h3><p>Book a service to see your status here</p></div>
                    </div>
                </div>

            </div>
            <div id="bookingsTab" class="tab-content" style="display:none;">
                <div class="my-bookings-section" id="customerBookingsList">
                    <div class="empty-state"><div class="empty-emoji">📍</div><h3>No bookings yet</h3><p>Book a service to see your status here</p></div>
                </div>
            </div>
        </div>

        <!-- Provider View -->
        <div id="providerView" class="view">
            <!-- Provider Sub-tabs -->
            <div class="provider-tabs">
                <button class="ptab-btn active" id="ptabProfile" onclick="switchProviderTab('profile')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>Profile</button>
                <button class="ptab-btn" id="ptabBookings" onclick="switchProviderTab('bookings')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path><rect x="9" y="3" width="6" height="4" rx="2"></rect><line x1="9" y1="12" x2="15" y2="12"></line><line x1="9" y1="16" x2="11" y2="16"></line></svg>Bookings<span class="badge" id="pendingBadge" style="display:none"></span></button>
                <button class="ptab-btn" id="ptabCalendar" onclick="switchProviderTab('calendar')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Calendar</button>
                <button class="ptab-btn" id="ptabAnalytics" onclick="switchProviderTab('analytics')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>Analytics</button>
            </div>

            <!-- PROFILE TAB -->
            <div id="ptabProfileContent">
                <form class="provider-form" onsubmit="submitProvider(event)">
                    <div class="form-group"><label>Your Name/Business Name</label><input type="text" id="providerName" required placeholder="e.g., Sarah's Hair Studio"></div>
                    <div class="form-group"><label>Service Type</label>
                        <select id="serviceType" required>
                            <option value="">Select a service type</option>
                            <option value="Haircut">Haircut</option><option value="Barber">Barber</option>
                            <option value="Cleaning">Cleaning Service</option><option value="Massage">Massage</option>
                            <option value="Nails">Nail Service</option><option value="Spa">Spa Treatment</option>
                            <option value="Personal Training">Personal Training</option><option value="Dog Walking">Dog Walking</option>
                            <option value="Tutoring">Tutoring</option><option value="Photography">Photography</option>
                            <option value="Car Detailing">Car Detailing</option><option value="Laundry Service">Laundry Service</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Service Description</label><textarea id="serviceDesc" required placeholder="Describe what you offer..."></textarea></div>
                    <div class="form-group"><label>Address</label><input type="text" id="location" required placeholder="e.g., Downtown Brooklyn"></div>
                    <div class="form-group"><label>Phone Number <span style="color:#888;font-weight:400;font-size:12px;">(for SMS notifications)</span></label><input type="text" id="providerContact" required placeholder="e.g., 6471234567"></div>
                    <div class="form-group"><label>Email Address <span style="color:#888;font-weight:400;font-size:12px;">(for email notifications)</span></label><input type="email" id="providerEmail" required placeholder="your@email.com"></div>
                    <div class="form-group">
                        <label>Social Media <span style="color:#888;font-weight:400;font-size:12px;">(optional — shown on your deal card)</span></label>
                        <div style="display:flex;flex-direction:column;gap:8px;margin-top:4px;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <svg viewBox="0 0 24 24" width="22" height="22" style="flex-shrink:0;"><defs><linearGradient id="igGrad" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#f09433"/><stop offset="25%" style="stop-color:#e6683c"/><stop offset="50%" style="stop-color:#dc2743"/><stop offset="75%" style="stop-color:#cc2366"/><stop offset="100%" style="stop-color:#bc1888"/></linearGradient></defs><path fill="url(#igGrad)" d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                                <input type="text" id="providerInstagram" placeholder="instagram.com/yourhandle" style="flex:1;padding:10px 12px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;outline:none;">
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <svg viewBox="0 0 24 24" width="22" height="22" style="flex-shrink:0;"><path fill="#010101" d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.75a8.16 8.16 0 004.77 1.52V6.79a4.85 4.85 0 01-1-.1z"/></svg>
                                <input type="text" id="providerTiktok" placeholder="tiktok.com/@yourhandle" style="flex:1;padding:10px 12px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;outline:none;">
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <svg viewBox="0 0 24 24" width="22" height="22" style="flex-shrink:0;"><path fill="#1877F2" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                <input type="text" id="providerFacebook" placeholder="facebook.com/yourpage" style="flex:1;padding:10px 12px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;outline:none;">
                            </div>
                        </div>
                    </div>

                    <!-- PRICING SECTION -->
                    <div class="form-group">
                        <label>Your Normal Price <span style="color:#888;font-weight:400;font-size:12px;">(regular rate, shown as crossed-out)</span></label>
                        <input type="number" id="normalPrice" placeholder="e.g. 80" step="0.01" min="0">
                    </div>
                    <div class="form-group"><label>Special Deal Pricing</label>
                        <div class="price-row">
                            <div><label style="font-size:12px;">Weekday Deal Price</label><input type="number" id="weekdayPrice" required placeholder="$" step="0.01"></div>
                            <div><label style="font-size:12px;">Weekend Deal Price</label><input type="number" id="weekendPrice" required placeholder="$" step="0.01"></div>
                        </div>
                    </div>

                    <!-- SLOTS SECTION -->
                    <div class="form-group">
                        <label>Deal Slots <span style="color:#888;font-weight:400;font-size:12px;">(leave blank for unlimited)</span></label>
                        <div class="price-row">
                            <div><label style="font-size:12px;">Weekday Slots</label><input type="number" id="weekdaySlots" placeholder="Unlimited" min="1" step="1"></div>
                            <div><label style="font-size:12px;">Weekend Slots</label><input type="number" id="weekendSlots" placeholder="Unlimited" min="1" step="1"></div>
                        </div>
                    </div>

                    <!-- DEAL TOGGLE -->
                    <div class="form-group">
                        <label>Deal Status</label>
                        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:#f8f9fa;border-radius:12px;">
                            <div id="dealToggle" onclick="toggleDeal()" style="width:52px;height:28px;border-radius:14px;background:#22c55e;cursor:pointer;position:relative;transition:background 0.3s;flex-shrink:0;">
                                <div id="dealToggleKnob" style="position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:white;transition:left 0.3s;left:27px;box-shadow:0 1px 4px rgba(0,0,0,0.2);"></div>
                            </div>
                            <div>
                                <div id="dealToggleLabel" style="font-weight:600;font-size:14px;color:#22c55e;">Deal is LIVE</div>
                                <div style="font-size:12px;color:#888;">Customers can book this deal</div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="dealActive" value="true">

                    <!-- AVAILABILITY WINDOWS -->
                    <div class="form-group">
                        <label>Availability Windows <span style="color:#888;font-weight:400;font-size:12px;">(optional — restrict to specific days/times)</span></label>
                        <div id="availabilityList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:10px;"></div>
                        <button type="button" onclick="addAvailabilityWindow()" style="width:100%;padding:10px;background:#f0f0ff;color:#667eea;border:2px dashed #667eea;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">+ Add Time Window</button>
                    </div>

                    <div class="form-group"><label>Upload Photos of Your Work</label>
                        <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin:0 auto 10px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            <p style="color:#667eea;font-weight:600;">Click to upload photos</p>
                            <p style="font-size:12px;color:#999;margin-top:5px;">Up to 6 photos</p>
                            <input type="file" id="photoInput" accept="image/*" multiple onchange="previewPhotos(event)">
                        </div>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                    <button type="submit" class="submit-btn" id="providerSubmitBtn">Create My Profile</button>
                </form>
                <div id="myProfileView" style="display:none;padding:20px;">
                    <div id="myProfileCard"></div>
                    <div style="display:flex;gap:10px;margin-top:16px;">
                        <button onclick="editMyProfile()" style="flex:1;padding:14px;background:#667eea;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Edit</button>
                        <button onclick="deleteMyProfile()" style="flex:1;padding:14px;background:#fee2e2;color:#e53e3e;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path></svg>Delete</button>
                    </div>
                </div>
            </div>

            <!-- BOOKINGS TAB -->
            <div id="ptabBookingsContent" style="display:none;">
                <div style="padding:16px;">
                    <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;">
                        <button class="filter-btn active" onclick="filterProviderBookings('all', this)">All</button>
                        <button class="filter-btn" onclick="filterProviderBookings('pending', this)"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Pending</button>
                        <button class="filter-btn" onclick="filterProviderBookings('confirmed', this)"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 15.01 9 12.01"></polyline></svg>Confirmed</button>
                        <button class="filter-btn" onclick="filterProviderBookings('rescheduled', this)"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>Rescheduled</button>
                        <button class="filter-btn" onclick="filterProviderBookings('rejected', this)"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Rejected</button>
                    </div>
                    <div id="providerBookingsList"><div class="empty-state"><div class="empty-emoji">📋</div><h3>No bookings yet</h3><p>Bookings will appear here once customers book your service</p></div></div>
                </div>
            </div>

            <!-- CALENDAR TAB -->
            <div id="ptabCalendarContent" style="display:none;">
                <div style="padding:16px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                        <button onclick="changeCalMonth(-1)" style="width:36px;height:36px;border-radius:50%;border:1.5px solid #e0e0e0;background:white;font-size:18px;cursor:pointer;">‹</button>
                        <div id="calMonthLabel" style="font-size:17px;font-weight:700;color:#333;"></div>
                        <button onclick="changeCalMonth(1)" style="width:36px;height:36px;border-radius:50%;border:1.5px solid #e0e0e0;background:white;font-size:18px;cursor:pointer;">›</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px;">
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">S</div>
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">M</div>
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">T</div>
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">W</div>
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">T</div>
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">F</div>
                        <div style="text-align:center;font-size:11px;font-weight:700;color:#aaa;padding:4px 0;">S</div>
                    </div>
                    <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:16px;"></div>
                    <div id="calDayBookings"></div>
                </div>
            </div>

            <!-- ANALYTICS TAB -->
            <div id="ptabAnalyticsContent" style="display:none;">
                <div style="padding:16px;" id="analyticsContent">
                    <div class="empty-state"><div class="empty-emoji">📊</div><h3>Loading analytics...</h3></div>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div class="modal" id="userProfileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="display:flex;align-items:center;gap:8px;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>My Account</h2>
                    <button class="close-btn" onclick="document.getElementById('userProfileModal').classList.remove('active'); var _p=document.getElementById('discoverPills'); if(_p&&document.getElementById('navDiscover').classList.contains('active'))_p.style.display='block';">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-body" style="padding:20px;">
                    <div id="profileMsg" style="display:none;padding:10px 14px;border-radius:10px;margin-bottom:16px;font-size:14px;font-weight:600;"></div>

                    <!-- Change Name -->
                    <div style="margin-bottom:24px;">
                        <h3 style="font-size:14px;font-weight:700;color:#333;margin-bottom:10px;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Change Name</h3>
                        <input type="text" id="newName" placeholder="New name" style="width:100%;padding:12px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;margin-bottom:10px;">
                        <button onclick="updateName()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">Save Name</button>
                    </div>

                    <hr style="border:none;border-top:1px solid #f0f0f0;margin-bottom:24px;">

                    <!-- SlowDay+ Status -->
                    <div id="slowdayPlusAccountSection" style="margin-bottom:24px;"></div>

                    <!-- Change Password -->
                    <div style="margin-bottom:24px;">
                        <h3 style="font-size:14px;font-weight:700;color:#333;margin-bottom:10px;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>Change Password</h3>
                        <input type="password" id="currentPassword" placeholder="Current password" style="width:100%;padding:12px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;margin-bottom:8px;">
                        <input type="password" id="newPassword" placeholder="New password (min 6 chars)" style="width:100%;padding:12px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;margin-bottom:10px;">
                        <button onclick="updatePassword()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">Change Password</button>
                    </div>

                    <hr style="border:none;border-top:1px solid #f0f0f0;margin-bottom:24px;">

                    <!-- Delete Account -->
                    <div>
                        <h3 style="font-size:14px;font-weight:700;color:#e53e3e;margin-bottom:6px;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Delete Account</h3>
                        <p style="font-size:13px;color:#888;margin-bottom:10px;">This permanently deletes your account and all your data. Cannot be undone.</p>
                        <button onclick="deleteAccount()" style="width:100%;padding:12px;background:#fee2e2;color:#e53e3e;border:1.5px solid #fca5a5;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">Delete My Account</button>
                    </div>

                    <hr style="border:none;border-top:1px solid #f0f0f0;margin:24px 0;">

                    <!-- Support Tickets -->
                    <div>
                        <h3 style="margin:0 0 12px;font-size:15px;color:#1a1a2e;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Support</h3>
                        <div id="accountOpenTickets" style="margin-bottom:12px;"></div>
                        <input type="text" id="ticketSubject" placeholder="Subject" style="width:100%;padding:11px 14px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;box-sizing:border-box;margin-bottom:8px;">
                        <textarea id="ticketMessage" placeholder="Describe your issue..." style="width:100%;padding:11px 14px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;box-sizing:border-box;height:90px;resize:none;font-family:inherit;margin-bottom:8px;"></textarea>
                        <button onclick="submitSupportTicket()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;">Submit Ticket</button>
                    </div>

                    <hr style="border:none;border-top:1px solid #f0f0f0;margin:24px 0;">

                    <!-- Legal Links -->
                    <div style="display:flex;justify-content:center;gap:20px;padding:10px 0;">
                        <a href="#" onclick="showTerms();return false;" style="font-size:13px;color:#667eea;text-decoration:none;font-weight:600;">Terms of Use</a>
                        <span style="color:#ddd;">|</span>
                        <a href="#" onclick="showPrivacy();return false;" style="font-size:13px;color:#667eea;text-decoration:none;font-weight:600;">Privacy Policy</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reschedule Modal -->
        <div class="modal" id="rescheduleModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="display:flex;align-items:center;gap:8px;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>Reschedule Booking</h2>
                    <button class="close-btn" onclick="document.getElementById('rescheduleModal').classList.remove('active')">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-body" style="padding:20px;">
                    <p style="color:#666;margin-bottom:16px;">Select a new date and time for this booking:</p>
                    <div class="custom-dt-picker" style="margin-bottom:16px;">
                        <input type="date" id="rescheduleDate" class="dt-date-input">
                        <div class="dt-time-row">
                            <select id="rescheduleHour" class="dt-select">
                                <option value="07">7 AM</option><option value="08">8 AM</option>
                                <option value="09">9 AM</option><option value="10">10 AM</option>
                                <option value="11">11 AM</option><option value="12">12 PM</option>
                                <option value="13">1 PM</option><option value="14">2 PM</option>
                                <option value="15">3 PM</option><option value="16">4 PM</option>
                                <option value="17">5 PM</option><option value="18">6 PM</option>
                                <option value="19">7 PM</option><option value="20">8 PM</option>
                                <option value="21">9 PM</option>
                            </select>
                            <select id="rescheduleMinute" class="dt-select">
                                <option value="00">:00</option>
                                <option value="15">:15</option>
                                <option value="30">:30</option>
                                <option value="45">:45</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="confirmReschedule()" style="width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;">Confirm New Time</button>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <button class="nav-btn active" id="navDiscover" onclick="showTab('discover')">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <span>Discover</span>
            </button>
            <button class="nav-btn" id="navSaved" onclick="showTab('saved')">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <span>Saved</span>
            </button>
            <button class="nav-btn" id="navProvider" onclick="showTab('provider')">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                <span>My Profile</span>
            </button>
        </div>

        <!-- Detail Modal -->
        <div class="modal" id="detailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Service Details</h2>
                    <button class="close-btn" onclick="closeModal()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div class="modal" id="authModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="authTitle">Welcome to SlowDay Deals</h2>
                    <button class="close-btn" onclick="closeAuthModal()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form" onsubmit="login(event)">
                        <div class="form-group">
                            <label>Email or Phone Number</label>
                            <input type="text" id="loginEmail" required placeholder="email@example.com or +1234567890">
                        </div>
                        <div class="form-group" style="position:relative;">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required style="padding-right:44px;">
                            <button type="button" class="pw-eye" onclick="togglePwVis(this)"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                        </div>
                        <div style="text-align:right;margin-top:-8px;margin-bottom:12px;">
                            <a href="#" onclick="showForgotPassword(); return false;" style="color:#667eea;font-size:13px;font-weight:500;">Forgot password?</a>
                        </div>
                        <button type="submit" class="submit-btn">Log In</button>
                        <p style="text-align: center; margin-top: 15px; color: #666;">
                            Don't have an account?
                            <a href="#" onclick="showSignup(); return false;" style="color: #667eea; font-weight: 600;">Sign Up</a>
                        </p>
                        <div class="sso-divider">or continue with</div>
                        <div id="googleSignInBtn" style="display:flex;justify-content:center;margin-bottom:10px;"></div>
                        <button type="button" class="sso-btn" onclick="handleFacebookSignIn()">
                            <svg viewBox="0 0 24 24" fill="#1877F2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                            Continue with Facebook
                        </button>
                    </form>

                    <!-- Forgot Password Form -->
                    <form id="forgotForm" class="auth-form" style="display:none;" onsubmit="sendResetEmail(event)">
                        <p style="color:#666;font-size:14px;margin-bottom:20px;line-height:1.5;">Enter your email address and we'll send you a link to reset your password.</p>
                        <div class="form-group">
                            <label>Email or Phone Number</label>
                            <input type="text" id="forgotEmail" required placeholder="email@example.com or +1234567890">
                        </div>
                        <div id="forgotSuccess" style="display:none;background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:12px;margin-bottom:16px;color:#166534;font-size:14px;text-align:center;">
                            ✅ Reset link sent! Check your inbox.
                        </div>
                        <button type="submit" class="submit-btn" id="forgotBtn">Send Reset Link</button>
                        <p style="text-align:center;margin-top:15px;color:#666;">
                            Remember your password?
                            <a href="#" onclick="showLogin(); return false;" style="color:#667eea;font-weight:600;">Log In</a>
                        </p>
                    </form>

                    <!-- Reset Password Form (shown when token is in URL) -->
                    <form id="resetForm" class="auth-form" style="display:none;" onsubmit="resetPassword(event)">
                        <p style="color:#666;font-size:14px;margin-bottom:20px;">Enter your new password below.</p>
                        <div class="form-group" style="position:relative;">
                            <label>New Password</label>
                            <input type="password" id="resetPassword" required minlength="6" placeholder="At least 6 characters" style="padding-right:44px;">
                            <button type="button" class="pw-eye" onclick="togglePwVis(this)"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                        </div>
                        <div class="form-group" style="position:relative;">
                            <label>Confirm New Password</label>
                            <input type="password" id="resetPasswordConfirm" required minlength="6" placeholder="Repeat new password" style="padding-right:44px;">
                            <button type="button" class="pw-eye" onclick="togglePwVis(this)"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                        </div>
                        <div id="resetError" style="display:none;background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:12px;margin-bottom:16px;color:#991b1b;font-size:14px;text-align:center;"></div>
                        <button type="submit" class="submit-btn">Reset Password</button>
                    </form>

                    <!-- Signup Form -->
                    <form id="signupForm" class="auth-form" style="display: none;" onsubmit="signup(event)">
                        <div class="form-group">
                            <label>Account Type</label>
                            <input type="hidden" id="signupAccountType" value="customer" required>
                            <div class="custom-select-box" id="accountTypeBox" onclick="toggleCustomSelect('accountTypeBox')">
                                <span id="accountTypeLabel">🛍️ Customer — I want to book services</span>
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#667eea" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                            <div class="custom-select-dropdown" id="accountTypeDropdown" style="display:none;">
                                <div class="custom-select-opt" onclick="pickAccountType('customer','🛍️ Customer — I want to book services')">🛍️ Customer — I want to book services</div>
                                <div class="custom-select-opt" onclick="pickAccountType('provider','🔧 Provider — I offer services')">🔧 Provider — I offer services</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="signupName" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group" style="position:relative;">
                            <label>Password</label>
                            <input type="password" id="signupPassword" required minlength="6" style="padding-right:44px;">
                            <button type="button" class="pw-eye" onclick="togglePwVis(this)"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="signupPhone" required>
                        </div>
                        <button type="submit" class="submit-btn">Create Account</button>
                        <p style="text-align: center; margin-top: 15px; color: #666;">
                            Already have an account?
                            <a href="#" onclick="showLogin(); return false;" style="color: #667eea; font-weight: 600;">Log In</a>
                        </p>
                        <div class="sso-divider">or sign up with</div>
                        <div id="googleSignUpBtn" style="display:flex;justify-content:center;margin-bottom:10px;"></div>
                        <button type="button" class="sso-btn" onclick="handleFacebookSignIn()">
                            <svg viewBox="0 0 24 24" fill="#1877F2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                            Continue with Facebook
                        </button>
                        <div style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid #f0f0f0;">
                            <p style="font-size:11px;color:#999;line-height:1.6;">
                                By creating an account, you agree to our<br>
                                <a href="#" onclick="closeAuthModal();showTerms();return false;" style="color:#667eea;font-weight:600;text-decoration:none;">Terms of Use</a>
                                <span style="color:#ddd;margin:0 4px;">•</span>
                                <a href="#" onclick="closeAuthModal();showPrivacy();return false;" style="color:#667eea;font-weight:600;text-decoration:none;">Privacy Policy</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Booking Modal -->
        <div class="modal" id="bookingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Book This Service</h2>
                    <button class="close-btn" onclick="closeBookingModal()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="bookingSuccess" class="success-message" style="display: none;">
                        ✅ Booking request sent! The provider will contact you soon.
                    </div>
                    <form class="booking-form" onsubmit="submitBooking(event)">
                        <div class="form-group">
                            <label>Your Name</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label>Contact (Phone or Email)</label>
                            <input type="text" id="customerContact" required>
                        </div>
                        <div class="form-group">
                            <label>Preferred Date & Time</label>
                            <!-- Standard picker (shown when no availability windows) -->
                            <div id="standardPicker" class="custom-dt-picker" style="overflow:hidden;max-width:100%;">
                                <input type="hidden" id="preferredDate">
                                <div id="customDatePicker" class="custom-date-picker">
                                    <div class="cdp-header">
                                        <button type="button" class="cdp-nav" onclick="cdpChangeMonth(-1)">&#8249;</button>
                                        <span id="cdpMonthLabel" class="cdp-month-label"></span>
                                        <button type="button" class="cdp-nav" onclick="cdpChangeMonth(1)">&#8250;</button>
                                    </div>
                                    <div class="cdp-weekdays">
                                        <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                                    </div>
                                    <div class="cdp-grid" id="cdpGrid"></div>
                                    <div id="cdpHint" class="cdp-hint"></div>
                                </div>
                                <div class="dt-time-row">
                                    <select id="preferredHour" class="dt-select">
                                        <option value="07">7 AM</option><option value="08">8 AM</option>
                                        <option value="09">9 AM</option><option value="10">10 AM</option>
                                        <option value="11">11 AM</option><option value="12">12 PM</option>
                                        <option value="13">1 PM</option><option value="14">2 PM</option>
                                        <option value="15">3 PM</option><option value="16">4 PM</option>
                                        <option value="17">5 PM</option><option value="18">6 PM</option>
                                        <option value="19">7 PM</option><option value="20">8 PM</option>
                                        <option value="21">9 PM</option>
                                    </select>
                                    <select id="preferredMinute" class="dt-select">
                                        <option value="00">:00</option>
                                        <option value="15">:15</option>
                                        <option value="30">:30</option>
                                        <option value="45">:45</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Slot picker (shown when provider has set availability windows) -->
                            <div id="slotPicker" style="display:none;">
                                <p style="font-size:13px;color:#666;margin-bottom:10px;">Select an available time slot:</p>
                                <div id="slotDayTabs" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;"></div>
                                <div id="slotTimeGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;"></div>
                                <input type="hidden" id="selectedSlotTime">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Additional Notes (Optional)</label>
                            <textarea id="bookingNotes" placeholder="Any special requests or questions..."></textarea>
                        </div>
                        <button type="submit" class="book-now-btn">Confirm Booking</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentUser = null;
        let services = [];
        let currentCardIndex = 0;
        let savedServices = [];
        let currentBookingService = null;
        let myBookings = [];

        // Google Places Autocomplete
        window.initPlaces = function() {
            const locationInput = document.getElementById('location');
            if (locationInput && window.google && google.maps && google.maps.places) {
                try {
                    const autocomplete = new google.maps.places.Autocomplete(locationInput, {
                        types: ['geocode'],
                        componentRestrictions: {country: ['ca', 'us']}
                    });
                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        if (place.formatted_address) {
                            locationInput.value = place.formatted_address;
                        }
                    });
                } catch (err) {
                    console.log('Google Places autocomplete not available, manual entry enabled');
                }
            }
            // Location search pill autocomplete
            const locSearchInput = document.getElementById('locationSearchInput');
            if (locSearchInput && window.google && google.maps && google.maps.places) {
                try {
                    const acLoc = new google.maps.places.Autocomplete(locSearchInput, {
                        types: ['(cities)'],
                        componentRestrictions: { country: ['ca', 'us'] }
                    });
                    acLoc.addListener('place_changed', () => {
                        const place = acLoc.getPlace();
                        if (place.geometry) {
                            const name = place.name || place.formatted_address || locSearchInput.value;
                            setLocationFilter(name, place.geometry.location.lat(), place.geometry.location.lng(), locationFilter.radius);
                        }
                    });
                } catch (err) {}
            }
        };

        // ============================================
        // INIT
        // ============================================
        window.onload = async function() {
            checkResetToken();
            // Restore saved location filter
            try {
                const savedLoc = localStorage.getItem('locationFilter');
                if (savedLoc) {
                    locationFilter = JSON.parse(savedLoc);
                    updateLocationPillLabel();
                    updateRadiusBtns();
                }
            } catch(e) {}
            // Check for deep-link tab param from email/SMS
            const urlParams = new URLSearchParams(window.location.search);
            const deepTab = urlParams.get('tab');
            const subResult = urlParams.get('subscription');
            const dealDeepLink = urlParams.get('deal');
            const pageParam = urlParams.get('page');
            if (pageParam === 'terms' || pageParam === 'privacy' || pageParam === 'delete-account') {
                window.history.replaceState({}, '', window.location.pathname);
                setTimeout(function() {
                    if (pageParam === 'terms') showTerms();
                    else if (pageParam === 'privacy') showPrivacy();
                    else if (pageParam === 'delete-account') {
                        var token = API.getToken();
                        if (token) deleteAccount();
                        else { showToast('Please log in to delete your account.', true); showAuthModal(); }
                    }
                }, 500);
            }
            if (subResult === 'success') {
                sessionStorage.setItem('showPlusSuccess', '1');
                window.history.replaceState({}, '', window.location.pathname);
            }
            if (dealDeepLink) {
                sessionStorage.setItem('dealDeepLink', dealDeepLink);
                window.history.replaceState({}, '', window.location.pathname);
            }
            if (deepTab) {
                sessionStorage.setItem('deepLinkTab', deepTab);
                // Clean URL
                window.history.replaceState({}, '', window.location.pathname);
            }
            showWakingUp();
            await wakeUpServer();

            // Initialize SSO SDKs
            initGoogleSignIn();
            initFacebookSDK();

            const token = API.getToken();
            if (token) {
                try {
                    const response = await API.getCurrentUser();
                    currentUser = response.user;
                    await showAuthenticatedView();
                    // Handle deep link after login
                    handleDeepLink();
                    handleDealDeepLink();
                } catch (error) {
                    API.removeToken();
                    await loadPublicServices();
                    handleDealDeepLink();
                    // If deep link present but not logged in, prompt login
                    if (deepTab || sessionStorage.getItem('deepLinkTab')) {
                        showToast('Please log in to view your bookings', false);
                        showAuthModal();
                    }
                }
            } else {
                await loadPublicServices();
                handleDealDeepLink();
                if (deepTab || sessionStorage.getItem('deepLinkTab')) {
                    showToast('Please log in to view your bookings', false);
                    showAuthModal();
                }
            }
        };

        function showWakingUp() {
            const stack = document.getElementById('cardStack');
            if (stack) {
                stack.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-emoji">⚡</div>
                        <h3>Warming up...</h3>
                        <p>Our free server is waking up.<br>Ready in about 30 seconds!</p>
                        <div style="margin-top:20px;width:200px;height:6px;background:#eee;border-radius:3px;overflow:hidden;">
                            <div id="loadingBar" style="width:0%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:3px;transition:width 0.5s;"></div>
                        </div>
                        <div class="empty-dots" style="margin-top:16px;">
                            <span></span><span></span><span></span>
                        </div>
                    </div>`;
                let pct = 0;
                const interval = setInterval(() => {
                    pct = Math.min(pct + 2, 90);
                    const bar = document.getElementById('loadingBar');
                    if (bar) bar.style.width = pct + '%';
                    else clearInterval(interval);
                }, 600);
            }
        }

        async function wakeUpServer() {
            for (let attempt = 1; attempt <= 10; attempt++) {
                try {
                    const res = await fetch(`${API_CONFIG.BASE_URL.replace('/api','')}/api/health`, { signal: AbortSignal.timeout(8000) });
                    if (res.ok) {
                        const bar = document.getElementById('loadingBar');
                        if (bar) bar.style.width = '100%';
                        return true;
                    }
                } catch (e) { /* still waking */ }
                await new Promise(r => setTimeout(r, 3000));
            }
            return false;
        }

        function dealSortPriority(s) {
            if (!s.dealActive) return 1;
            const wdLeft = s.weekdaySlots != null ? s.weekdaySlots - (s.weekdaySlotsUsed || 0) : Infinity;
            const weLeft = s.weekendSlots != null ? s.weekendSlots - (s.weekendSlotsUsed || 0) : Infinity;
            if (wdLeft <= 0 && weLeft <= 0) return 1;
            return 0;
        }

        async function loadPublicServices() {
            try {
                const response = await API.getServices();
                allServices = response.services || [];

                // Active deals first (newest first), ended/inactive deals last
                allServices.sort((a, b) =>
                    dealSortPriority(a) - dealSortPriority(b) ||
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
            } catch (error) {
                allServices = [];
            }
            await applyCurrentFilters();
        }

        // ============================================
        // AUTH MODAL
        // ============================================
        function togglePwVis(btn) {
            const input = btn.parentElement.querySelector('input');
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            btn.innerHTML = isHidden
                ? '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"></path><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"></path><line x1="1" y1="1" x2="23" y2="23"></line><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"></path></svg>'
                : '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            const p = document.getElementById('discoverPills'); if (p) p.style.display = 'none';
            showLogin();
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            const p = document.getElementById('discoverPills');
            if (p && document.getElementById('navDiscover').classList.contains('active')) p.style.display = 'block';
        }

        function showLogin() {
            document.getElementById('authTitle').textContent = 'Welcome Back!';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('forgotForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'none';
        }

        function showSignup() {
            document.getElementById('authTitle').textContent = 'Create Your Account';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('forgotForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'none';
        }

        function showForgotPassword() {
            document.getElementById('authTitle').textContent = 'Reset Your Password';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('forgotForm').style.display = 'block';
            document.getElementById('resetForm').style.display = 'none';
            document.getElementById('forgotSuccess').style.display = 'none';
        }

        async function sendResetEmail(e) {
            e.preventDefault();
            const emailOrPhone = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                await API.forgotPassword(emailOrPhone);
                document.getElementById('forgotSuccess').style.display = 'block';
                btn.textContent = 'Resend Link';
            } catch (err) {
                // Always show success to prevent email enumeration
                document.getElementById('forgotSuccess').style.display = 'block';
                btn.textContent = 'Resend Link';
            }
            btn.disabled = false;
        }

        async function resetPassword(e) {
            e.preventDefault();
            const password = document.getElementById('resetPassword').value;
            const confirm = document.getElementById('resetPasswordConfirm').value;
            const errorEl = document.getElementById('resetError');
            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match.';
                errorEl.style.display = 'block';
                return;
            }
            // Read token from sessionStorage (set by checkResetToken, works on Safari)
            const token = sessionStorage.getItem('pendingResetToken')
                || new URLSearchParams(window.location.search).get('resetToken');
            if (!token) {
                errorEl.textContent = 'Invalid or expired reset link. Please request a new one.';
                errorEl.style.display = 'block';
                return;
            }
            try {
                const response = await API.resetPassword(token, password);
                console.log('[reset] Response:', JSON.stringify(response));
                sessionStorage.removeItem('pendingResetToken');
                window.history.replaceState({}, '', window.location.pathname);
                // Auto-login with the token returned from reset
                if (response.token && response.user) {
                    API.setToken(response.token);
                    currentUser = response.user;
                    closeAuthModal();
                    try { await showAuthenticatedView(); } catch(e) { console.error('[reset] View error:', e); }
                    showToast('Password reset and logged in!');
                } else {
                    console.warn('[reset] No token/user in response — auto-login skipped');
                    showToast('Password reset successfully! Please log in.');
                    showLogin();
                }
            } catch (err) {
                console.error('[reset] Error:', err.message);
                errorEl.textContent = err.message || 'Reset failed. Link may have expired. Please request a new one.';
                errorEl.style.display = 'block';
            }
        }

        // Check for reset token in URL on page load
        function checkResetToken() {
            // Robust token extraction - handles Safari URL quirks and Cloudflare rewrites
            let token = null;
            try {
                token = new URLSearchParams(window.location.search).get('resetToken');
            } catch(e) {}
            // Fallback: manual parse
            if (!token) {
                const match = window.location.search.match(/[?&]resetToken=([^&]+)/);
                if (match) token = decodeURIComponent(match[1]);
            }
            // Fallback: check hash (some email clients rewrite ? to #)
            if (!token) {
                const hashMatch = window.location.hash.match(/resetToken=([^&]+)/);
                if (hashMatch) token = decodeURIComponent(hashMatch[1]);
            }
            if (token) {
                // Store in sessionStorage so it survives modal open
                sessionStorage.setItem('pendingResetToken', token);
                // Clean URL immediately (Safari sometimes re-reads it)
                window.history.replaceState({}, '', window.location.pathname);
                showAuthModal();
                document.getElementById('authTitle').textContent = 'Set New Password';
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('forgotForm').style.display = 'none';
                document.getElementById('resetForm').style.display = 'block';
            }
        }

        async function login(e) {
            e.preventDefault();
            const emailOrPhone = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = e.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.textContent = 'Logging in...'; }
            try {
                const response = await API.login({ emailOrPhone, password });
                if (response.success) {
                    API.setToken(response.token);
                    currentUser = response.user;
                    closeAuthModal();
                    e.target.reset();
                    try {
                        await showAuthenticatedView();
                    } catch (viewErr) {
                        console.error('Post-login view error:', viewErr);
                    }
                    handleDeepLink();
                    handleDealDeepLink();
                }
            } catch (error) {
                if (error.message === 'Failed to fetch') {
                    showToast('Server is waking up — please wait 30 seconds and try again.', true);
                } else {
                    showToast(error.message || 'Login failed. Please check your credentials.', true);
                }
            }
            if (btn) { btn.disabled = false; btn.textContent = 'Log In'; }
        }

        async function signup(e) {
            e.preventDefault();
            const userData = {
                name: document.getElementById('signupName').value,
                email: document.getElementById('signupEmail').value,
                password: document.getElementById('signupPassword').value,
                phone: document.getElementById('signupPhone').value,
                accountType: document.getElementById('signupAccountType').value
            };
            const btn = e.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.textContent = 'Creating account...'; }
            try {
                const response = await API.signup(userData);
                if (response.success) {
                    API.setToken(response.token);
                    currentUser = response.user;
                    closeAuthModal();
                    e.target.reset();
                    try {
                        await showAuthenticatedView();
                    } catch (viewErr) {
                        console.error('Post-signup view error:', viewErr);
                    }
                    showToast(`Welcome to SlowDay Deals, ${currentUser.name}!`);
                }
            } catch (error) {
                if (error.message === 'Failed to fetch') {
                    showToast('Server is waking up — please wait 30 seconds and try again.', true);
                } else {
                    showToast(error.message || 'Signup failed. Please try again.', true);
                }
            }
            if (btn) { btn.disabled = false; btn.textContent = 'Create Account'; }
        }

        // ============================================
        // SSO HANDLERS (Google & Facebook)
        // ============================================

        function initGoogleSignIn() {
            if (typeof google === 'undefined' || !google.accounts) {
                setTimeout(initGoogleSignIn, 500);
                return;
            }
            google.accounts.id.initialize({
                client_id: '803483521825-s9h4eq6q6c2rjm8tir39kh7ienvjb78m.apps.googleusercontent.com',
                callback: handleGoogleSignIn,
                auto_select: false
            });

            var loginBtn = document.getElementById('googleSignInBtn');
            if (loginBtn) {
                google.accounts.id.renderButton(loginBtn, {
                    type: 'standard',
                    theme: 'outline',
                    size: 'large',
                    text: 'continue_with',
                    width: 320
                });
            }

            var signupBtn = document.getElementById('googleSignUpBtn');
            if (signupBtn) {
                google.accounts.id.renderButton(signupBtn, {
                    type: 'standard',
                    theme: 'outline',
                    size: 'large',
                    text: 'signup_with',
                    width: 320
                });
            }
        }

        async function handleGoogleSignIn(response) {
            try {
                var result = await API.googleAuth(response.credential);
                if (result.success) {
                    API.setToken(result.token);
                    currentUser = result.user;
                    closeAuthModal();
                    await showAuthenticatedView();
                    showToast('Welcome, ' + currentUser.name + '!');
                    handleDeepLink();
                    handleDealDeepLink();
                }
            } catch (error) {
                if (error.message === 'Failed to fetch') {
                    showToast('Server is waking up — please wait 30 seconds and try again.', true);
                } else {
                    showToast(error.message || 'Google sign-in failed. Please try again.', true);
                }
            }
        }

        function initFacebookSDK() {
            if (typeof FB === 'undefined') {
                setTimeout(initFacebookSDK, 500);
                return;
            }
            FB.init({
                appId: '889484890626022',
                cookie: true,
                xfbml: false,
                version: 'v19.0'
            });
        }

        async function handleFacebookSignIn() {
            if (typeof FB === 'undefined') {
                showToast('Facebook is loading. Please try again.', true);
                return;
            }
            FB.login(async function(response) {
                if (response.authResponse) {
                    var accessToken = response.authResponse.accessToken;
                    try {
                        var result = await API.facebookAuth(accessToken);
                        if (result.success) {
                            API.setToken(result.token);
                            currentUser = result.user;
                            closeAuthModal();
                            await showAuthenticatedView();
                            showToast('Welcome, ' + currentUser.name + '!');
                            handleDeepLink();
                            handleDealDeepLink();
                        }
                    } catch (error) {
                        if (error.message === 'Failed to fetch') {
                            showToast('Server is waking up — please wait 30 seconds and try again.', true);
                        } else {
                            showToast(error.message || 'Facebook sign-in failed. Please try again.', true);
                        }
                    }
                }
            }, { scope: 'email,public_profile' });
        }

        function logout() {
            showConfirmModal('Log out of SlowDay?', 'Log Out', function() {
                currentUser = null;
                API.removeToken();
                location.reload();
            });
        }

        function cancelMyBookingConfirm(id) {
            showConfirmModal('Cancel this booking?', 'Cancel Booking', function() {
                API.updateBookingStatus(id, 'cancelled')
                    .then(() => loadMyBookings())
                    .catch(() => showToast('Error cancelling booking', true));
            });
        }

        function showConfirmModal(message, confirmLabel, onConfirm) {
            const old = document.getElementById('confirmModal');
            if (old) old.remove();
            const overlay = document.createElement('div');
            overlay.id = 'confirmModal';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
            overlay.innerHTML = `<div style="background:white;border-radius:20px;padding:28px 24px;width:100%;max-width:320px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                <p style="font-size:17px;font-weight:600;color:#1a1a2e;margin:0 0 24px;">${message}</p>
                <div style="display:flex;gap:10px;">
                    <button onclick="document.getElementById('confirmModal').remove()" style="flex:1;padding:13px;border:1.5px solid #e0e0e0;border-radius:12px;background:white;font-size:15px;font-weight:600;color:#555;cursor:pointer;">Cancel</button>
                    <button id="confirmModalOk" style="flex:1;padding:13px;border:none;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-size:15px;font-weight:600;cursor:pointer;">${confirmLabel}</button>
                </div>
            </div>`;
            document.querySelector('.app-container').appendChild(overlay);
            document.getElementById('confirmModalOk').onclick = function() {
                overlay.remove();
                onConfirm();
            };
        }

        async function showAuthenticatedView() {
            document.querySelector('.app-container').scrollTop = 0;
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('guestMenu').style.display = 'none';
            const firstLetter = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = firstLetter;
            document.getElementById('dropdownAvatar').textContent = firstLetter;
            document.getElementById('userDropdownName').textContent = currentUser.name;
            document.getElementById('userDropdownEmail').textContent = currentUser.email;
            await loadSavedServices();
            await loadPublicServices();
            renderSavedList();
            await loadMyProfile();
            document.getElementById('savingsBadge').style.visibility = 'visible';
            await updateSavingsTracker();
            loadSubscriptionStatus();
            updateNavForUserType();
            // Start real-time polling
            startRealtimePolling();
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const pillsEl = document.getElementById('discoverPills');
            const opening = dropdown.style.display === 'none';
            dropdown.style.display = opening ? 'block' : 'none';
            // Pills live outside .app-container (body direct child) so iOS stacking
            // contexts can put them above the dropdown. Hide them while dropdown is open.
            if (pillsEl) pillsEl.style.display = opening ? 'none' : (document.getElementById('navDiscover').classList.contains('active') ? 'block' : 'none');
        }

        document.addEventListener('click', function(e) {
            const avatar = document.getElementById('userAvatar');
            const dropdown = document.getElementById('userDropdown');
            if (dropdown && avatar && !avatar.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                const pillsEl = document.getElementById('discoverPills');
                const detailModal = document.getElementById('detailModal');
                const bookingModal = document.getElementById('bookingModal');
                if (pillsEl && document.getElementById('navDiscover').classList.contains('active') && !document.querySelector('.modal.active')) {
                    pillsEl.style.display = 'block';
                }
            }
        });

        function switchToProvider() {
            const dd = document.getElementById('userDropdown');
            if (dd) dd.style.display = 'none';
            showTab('provider');
        }

        function becomeProvider() {
            document.getElementById('userDropdown').style.display = 'none';
            switchToProvider();
        }

        function updateNavForUserType() {
            if (!currentUser) return;
            const isProvider = currentUser.accountType === 'provider';
            const navBtn = document.getElementById('navProvider');
            const dropdownBtn = document.getElementById('providerDropdownBtn');
            const stabMyBookings = document.getElementById('stabMyBookings');

            if (isProvider) {
                navBtn.innerHTML = `<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg><span>My Profile</span>`;
                navBtn.onclick = () => showTab('provider');
                if (dropdownBtn) dropdownBtn.style.display = 'none';
                if (stabMyBookings) stabMyBookings.style.display = 'inline-flex';
            } else {
                navBtn.innerHTML = `<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>Bookings</span>`;
                navBtn.onclick = () => showTab('bookings');
                if (dropdownBtn) { dropdownBtn.style.display = 'flex'; dropdownBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" y1="8" x2="19" y2="14"></line><line x1="22" y1="11" x2="16" y2="11"></line></svg>Become a Provider'; dropdownBtn.onclick = () => becomeProvider(); }
                if (stabMyBookings) stabMyBookings.style.display = 'none';
            }
        }

        async function loadCustomerBookingsTab() {
            const el = document.getElementById('customerBookingsList');
            el.innerHTML = `<div class="empty-state"><div class="empty-emoji">⏳</div><h3>Loading...</h3></div>`;
            try {
                const res = await API.getCustomerBookings();
                const bookings = (res.bookings || []).sort((a, b) => new Date(b.preferredTime) - new Date(a.preferredTime));
                window._customerBookings = bookings;
                await updateSavingsTracker();
                if (!bookings.length) {
                    el.innerHTML = `<div class="empty-state"><div class="empty-emoji">📍</div><h3>No bookings yet</h3><p>Book a service to see your status here</p></div>`;
                    return;
                }
                el.innerHTML = bookings.map((b, idx) => {
                    const svc = b.service || {};
                    const date = new Date(b.preferredTime).toLocaleString('en-US', { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
                    return `<div class="booking-card" style="cursor:pointer;" onclick="showBookingDetail(${idx})">
                        <div class="booking-card-header">
                            <div>
                                <div class="booking-card-title">${svc.serviceType || 'Service'}</div>
                                <div class="booking-card-sub">by ${svc.providerName || ''}</div>
                            </div>
                            <span class="status-pill status-${b.status}">${b.status}</span>
                        </div>
                        <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> <span>Date:</span> ${date}</div>
                        <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> <span>Location:</span> <span class="no-link">${svc.location || ''}</span></div>
                        <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> <span>Price:</span> $${b.price}</div>
                        ${b.notes ? `<div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg> <span>Notes:</span> ${b.notes}</div>` : ''}
                    </div>`;
                }).join('');
            } catch(e) {
                el.innerHTML = `<div class="empty-state"><div class="empty-emoji">⚠️</div><h3>Could not load bookings</h3></div>`;
            }
        }

        function showBookingDetail(idx) {
            const b = (window._customerBookings || [])[idx];
            if (!b || !b.service) return;
            const canCancel = ['pending','confirmed','rescheduled'].includes(b.status);
            showDetails(b.service, canCancel ? b._id : null, b.price, b.preferredTime);
        }

        function cancelBookingFromDetail(id, savings) {
            const savingsLine = savings > 0
                ? `<br><span style="color:#ef4444;font-size:13px;font-weight:700;">⚠️ You'll miss out on saving $${savings}!</span>`
                : '';
            showConfirmModal(`Are you sure you want to cancel?${savingsLine}`, 'Yes, Cancel', function() {
                API.updateBookingStatus(id, 'cancelled')
                    .then(() => {
                        closeModal();
                        showToast('Booking cancelled.');
                        loadCustomerBookingsTab();
                        loadMyBookings();
                    })
                    .catch(() => showToast('Error cancelling booking', true));
            });
        }

        // ============================================
        // BOTTOM NAV
        // ============================================
        function showTab(tab) {
            if (!currentUser && tab !== 'discover') {
                showAuthModal();
                return;
            }
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('customerView').style.display = 'none';
            document.getElementById('providerView').style.display = 'none';

            const pillsEl = document.getElementById('discoverPills');
            const savedSubtabs = document.querySelector('.saved-subtabs');
            if (tab === 'discover') {
                document.getElementById('navDiscover').classList.add('active');
                document.getElementById('customerView').style.display = 'block';
                document.getElementById('discoverTab').style.display = 'block';
                document.getElementById('savedTab').style.display = 'none';
                if (savedSubtabs) savedSubtabs.style.display = 'none';
                if (pillsEl) pillsEl.style.display = 'block';
            } else if (tab === 'saved') {
                document.getElementById('navSaved').classList.add('active');
                document.getElementById('customerView').style.display = 'block';
                document.getElementById('discoverTab').style.display = 'none';
                document.getElementById('savedTab').style.display = 'block';
                document.getElementById('bookingsTab').style.display = 'none';
                const isProvider = currentUser && currentUser.accountType === 'provider';
                if (savedSubtabs) savedSubtabs.style.display = isProvider ? 'flex' : 'none';
                document.getElementById('savedTab').style.paddingTop = isProvider ? '45px' : '0';
                if (pillsEl) pillsEl.style.display = 'none';
                renderSavedList();
            } else if (tab === 'bookings') {
                document.getElementById('navProvider').classList.add('active');
                document.getElementById('customerView').style.display = 'block';
                document.getElementById('discoverTab').style.display = 'none';
                document.getElementById('savedTab').style.display = 'none';
                document.getElementById('bookingsTab').style.display = 'block';
                if (savedSubtabs) savedSubtabs.style.display = 'none';
                if (pillsEl) pillsEl.style.display = 'none';
                loadCustomerBookingsTab();
            } else if (tab === 'provider') {
                document.querySelector('.app-container').scrollTop = 0;
                document.getElementById('navProvider').classList.add('active');
                document.getElementById('providerView').style.display = 'block';
                document.getElementById('bookingsTab').style.display = 'none';
                if (savedSubtabs) savedSubtabs.style.display = 'none';
                if (pillsEl) pillsEl.style.display = 'none';
                // Auto-fill email and phone if empty
                const emailField = document.getElementById('providerEmail');
                if (emailField && !emailField.value && currentUser) emailField.value = currentUser.email || '';
                const contactField = document.getElementById('providerContact');
                if (contactField && !contactField.value && currentUser) contactField.value = currentUser.phone || '';
            }
        }

        // ============================================
        // SEARCH
        // ============================================
        let allServices = [];
        let locationFilter = { name: '', lat: null, lng: null, radius: 25 };
        const serviceGeoCache = {};

        function searchServices(query) {
            applyCurrentFilters();
        }

        async function applyCurrentFilters() {
            const type = document.getElementById('filterType').value;
            const q = (document.getElementById('searchInput').value || '').toLowerCase();

            let filtered = allServices.filter(s => {
                if (s._isPlusCard) return true;
                if (myService && myService._id && (s._id || s.id) === myService._id) return false;
                const matchesType = !type || s.serviceType === type;
                const matchesQuery = !q ||
                    (s.providerName || '').toLowerCase().includes(q) ||
                    (s.serviceType || '').toLowerCase().includes(q) ||
                    (s.location || '').toLowerCase().includes(q) ||
                    (s.description || '').toLowerCase().includes(q);
                return matchesType && matchesQuery;
            });

            if (locationFilter.lat !== null) {
                // City name used as text-match fallback when geocoding fails
                const filterCity = locationFilter.name.split(',')[0].toLowerCase().trim();
                const withGeo = await Promise.all(filtered.map(async s => {
                    if (s._isPlusCard) return { s, ok: true };
                    const coords = await geocodeAddress(s.location, s._id || s.id);
                    if (coords) {
                        const dist = haversineKm(locationFilter.lat, locationFilter.lng, coords.lat, coords.lng);
                        return { s, ok: dist <= locationFilter.radius };
                    }
                    // Geocoding failed — fall back to checking if city name appears in the service location
                    const ok = filterCity.length > 0 && (s.location || '').toLowerCase().includes(filterCity);
                    return { s, ok };
                }));
                filtered = withGeo.filter(x => x.ok).map(x => x.s);
            }

            services = filtered;
            injectPlusCard();
            currentCardIndex = 0;
            renderCards();
        }

        function haversineKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        async function geocodeAddress(address, cacheKey) {
            if (!address) return null;
            const key = cacheKey || address;
            if (serviceGeoCache.hasOwnProperty(key)) return serviceGeoCache[key];
            if (!window.google || !google.maps) { serviceGeoCache[key] = null; return null; }

            // Try Geocoder first (requires Geocoding API to be enabled on the key)
            if (google.maps.Geocoder) {
                const r = await new Promise(resolve => {
                    new google.maps.Geocoder().geocode({ address }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const loc = results[0].geometry.location;
                            resolve({ lat: loc.lat(), lng: loc.lng() });
                        } else resolve(null);
                    });
                });
                if (r) { serviceGeoCache[key] = r; return r; }
            }

            // Fallback: Places findPlaceFromQuery (uses Places API, no Geocoding API needed)
            if (google.maps.places && google.maps.places.PlacesService) {
                const r = await new Promise(resolve => {
                    const div = document.createElement('div');
                    new google.maps.places.PlacesService(div).findPlaceFromQuery(
                        { query: address, fields: ['geometry'] },
                        (results, status) => {
                            if (status === 'OK' && results && results[0] && results[0].geometry) {
                                const loc = results[0].geometry.location;
                                resolve({ lat: loc.lat(), lng: loc.lng() });
                            } else resolve(null);
                        }
                    );
                });
                if (r) { serviceGeoCache[key] = r; return r; }
            }

            serviceGeoCache[key] = null;
            return null;
        }

        function injectPlusCard() {
            if (!currentUser || currentUserIsPlus || sessionStorage.getItem('plusCardShown')) return;
            if (services.some(s => s._isPlusCard)) return;
            sessionStorage.setItem('plusCardShown', '1');
            const insertAt = Math.min(3, services.length);
            services.splice(insertAt, 0, { _isPlusCard: true });
        }

        // ============================================
        // MY PROVIDER PROFILE
        // ============================================
        let myService = null;

        async function loadMyProfile() {
            if (!currentUser) return;
            try {
                const response = await API.getMyServices();
                if (response.services && response.services.length > 0) {
                    myService = response.services[0];
                    renderMyProfile();
                }
            } catch (e) { console.log('No profile yet'); }
        }

        function renderMyProfile() {
            if (!myService) return;
            const imgHtml = myService.photos && myService.photos.length > 0
                ? `<img class="profile-card-img" src="${myService.photos[0]}" alt="${myService.serviceType}">`
                : `<div class="profile-card-img-placeholder">${getServiceEmoji(myService.serviceType)}</div>`;
            const emailLine = myService.email ? `<span style="display:inline-flex;align-items:center;gap:4px;"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>${myService.email}</span>` : '';
            const np = myService.normalPrice;
            const wdPct = np && np > myService.weekdayPrice ? Math.round((1 - myService.weekdayPrice / np) * 100) : 0;
            const wePct = np && np > myService.weekendPrice ? Math.round((1 - myService.weekendPrice / np) * 100) : 0;
            const wdDiscountHtml = wdPct > 0 ? `<div style="font-size:11px;color:#999;text-decoration:line-through;">$${np}</div><div style="font-size:11px;font-weight:700;color:#10b981;">${wdPct}% off</div>` : '';
            const weDiscountHtml = wePct > 0 ? `<div style="font-size:11px;color:#999;text-decoration:line-through;">$${np}</div><div style="font-size:11px;font-weight:700;color:#10b981;">${wePct}% off</div>` : '';
            const wdSlots = myService.weekdaySlots ? `${myService.weekdaySlots} slot${myService.weekdaySlots > 1 ? 's' : ''}` : '∞ slots';
            const weSlots = myService.weekendSlots ? `${myService.weekendSlots} slot${myService.weekendSlots > 1 ? 's' : ''}` : '∞ slots';
            document.getElementById('myProfileCard').innerHTML = `
                ${imgHtml}
                <div class="profile-card-body">
                    <h2>${myService.providerName}</h2>
                    <div class="type-badge">${myService.serviceType}</div>
                    <p>${myService.description}</p>
                    <p style="color:#888;font-size:13px;display:flex;flex-wrap:wrap;gap:8px;">
                        <span style="display:inline-flex;align-items:center;gap:4px;"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>${myService.location}</span>
                        <span style="display:inline-flex;align-items:center;gap:4px;"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13 19.79 19.79 0 0 1 1.61 4.27 2 2 0 0 1 3.6 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>${myService.contact}</span>
                        ${emailLine}
                    </p>
                    <div class="profile-price-row">
                        <div class="profile-price-box">
                            <div class="label">Weekdays</div>
                            <div class="value">$${myService.weekdayPrice}</div>
                            ${wdDiscountHtml}
                            <div style="font-size:11px;color:#888;margin-top:4px;display:flex;align-items:center;justify-content:center;gap:3px;"><svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>${wdSlots}</div>
                        </div>
                        <div class="profile-price-box">
                            <div class="label">Weekends</div>
                            <div class="value">$${myService.weekendPrice}</div>
                            ${weDiscountHtml}
                            <div style="font-size:11px;color:#888;margin-top:4px;display:flex;align-items:center;justify-content:center;gap:3px;"><svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>${weSlots}</div>
                        </div>
                    </div>
                    <button onclick="shareDeal('${myService._id || myService.id}')" style="width:100%;margin-top:16px;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 15px rgba(102,126,234,0.3);"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>Share My Deal</button>
                </div>`;
            document.getElementById('myProfileView').style.display = 'block';
            document.querySelector('.provider-form').style.display = 'none';
        }

        function editMyProfile() {
            document.getElementById('myProfileView').style.display = 'none';
            document.querySelector('.provider-form').style.display = 'block';
            document.getElementById('providerSubmitBtn').textContent = 'Save Changes';
            if (myService) {
                document.getElementById('providerName').value = myService.providerName;
                document.getElementById('serviceType').value = myService.serviceType;
                document.getElementById('serviceDesc').value = myService.description;
                document.getElementById('location').value = myService.location;
                document.getElementById('providerContact').value = myService.contact || '';
                document.getElementById('providerEmail').value = myService.email || currentUser?.email || '';
                document.getElementById('providerInstagram').value = myService.instagram || '';
                document.getElementById('providerTiktok').value = myService.tiktok || '';
                document.getElementById('providerFacebook').value = myService.facebook || '';
                document.getElementById('normalPrice').value = myService.normalPrice || '';
                document.getElementById('weekdayPrice').value = myService.weekdayPrice;
                document.getElementById('weekendPrice').value = myService.weekendPrice;
                document.getElementById('weekdaySlots').value = myService.weekdaySlots || '';
                document.getElementById('weekendSlots').value = myService.weekendSlots || '';

                // Restore deal toggle
                dealActiveState = myService.dealActive !== false;
                document.getElementById('dealActive').value = dealActiveState;
                const toggle = document.getElementById('dealToggle');
                const knob = document.getElementById('dealToggleKnob');
                const label = document.getElementById('dealToggleLabel');
                if (dealActiveState) {
                    toggle.style.background = '#22c55e'; knob.style.left = '27px';
                    label.style.color = '#22c55e'; label.textContent = 'Deal is LIVE';
                } else {
                    toggle.style.background = '#d1d5db'; knob.style.left = '3px';
                    label.style.color = '#9ca3af'; label.textContent = 'Deal is OFF';
                }

                // Restore availability windows
                document.getElementById('availabilityList').innerHTML = '';
                if (myService.availabilityWindows && myService.availabilityWindows.length > 0) {
                    myService.availabilityWindows.forEach(w => addAvailabilityWindow(w));
                }

                // Restore existing photos into preview
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = '';
                if (myService.photos && myService.photos.length > 0) {
                    myService.photos.forEach(photoSrc => {
                        const wrap = document.createElement('div');
                        wrap.className = 'photo-thumb';
                        wrap.style.cssText = 'position:relative;display:inline-block;margin:4px;overflow:hidden;border-radius:8px;';
                        const imgEl = document.createElement('img');
                        imgEl.src = photoSrc;
                        imgEl.style.cssText = 'width:80px;height:80px;object-fit:cover;border-radius:8px;display:block;';
                        const xBtn = document.createElement('button');
                        xBtn.type = 'button'; xBtn.textContent = '×';
                        xBtn.style.cssText = 'position:absolute;top:0;right:0;width:22px;height:22px;background:rgba(220,38,38,0.9);color:white;border:none;border-radius:0 0 0 8px;font-size:14px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;';
                        xBtn.onclick = () => wrap.remove();
                        wrap.appendChild(imgEl); wrap.appendChild(xBtn);
                        preview.appendChild(wrap);
                    });
                }
            }
        }

        function deleteMyProfile() {
            showConfirmModal('Are you sure you want to delete your service profile?', 'Delete', async () => {
                try {
                    await API.deleteService(myService._id);
                    myService = null;
                    document.getElementById('myProfileView').style.display = 'none';
                    document.querySelector('.provider-form').style.display = 'block';
                    document.getElementById('providerSubmitBtn').textContent = 'Create My Profile';
                    if (currentUser) currentUser.accountType = 'customer';
                    updateNavForUserType();
                    showToast('Profile deleted.', false);
                    showTab('discover');
                } catch (e) { showToast('Error deleting profile.', true); }
            });
        }

        // ============================================
        // MODE SWITCHING
        // ============================================
        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            if (mode === 'customer') {
                document.querySelectorAll('.mode-btn')[0].classList.add('active');
                document.getElementById('customerView').classList.add('active');
            } else {
                if (!currentUser) {
                    showToast('Please log in to access provider features.', true);
                    showAuthModal();
                    document.querySelectorAll('.mode-btn')[0].classList.add('active');
                    document.getElementById('customerView').classList.add('active');
                    return;
                }
                // Any logged-in user can set up a provider profile
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
                document.getElementById('providerView').classList.add('active');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'discover') {
                document.getElementById('discoverTab').style.display = 'block';
                document.getElementById('savedTab').style.display = 'none';
            } else {
                document.getElementById('discoverTab').style.display = 'none';
                document.getElementById('savedTab').style.display = 'block';
                renderSavedList();
                // Update savings tracker when viewing saved tab
                if (currentUser && currentUser.accountType === 'customer') {
                    updateSavingsTracker();
                }
            }
        }

        // ============================================
        // CARDS & SWIPING
        // ============================================
        function showSwipeHint() {
            if (sessionStorage.getItem('swipeHintShown')) return;
            sessionStorage.setItem('swipeHintShown', '1');
            // Append to .swipe-container (position:relative + min-height:360px) so
            // position:absolute bottom:36px resolves correctly and isn't clipped.
            const container = document.querySelector('.swipe-container');
            if (!container) return;
            const hint = document.createElement('div');
            hint.id = 'swipeHint';
            hint.innerHTML = '<span class="sh-l">←</span><span class="sh-hand">👆</span><span>Swipe to explore</span><span class="sh-r">→</span>';
            container.appendChild(hint);
            setTimeout(() => hint.remove(), 3600);
        }

        function renderCards() {
            const stack = document.getElementById('cardStack');
            stack.innerHTML = '';
            if (services.length === 0) {
                stack.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-emoji">🔍</div>
                        <h3>No results found</h3>
                        <p>Try a different search or category</p>
                        <button onclick="document.getElementById('searchInput').value='';document.getElementById('filterType').value='';searchServices('');" style="margin-top:20px;padding:12px 28px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;">
                            Clear Search
                        </button>
                    </div>`;
                return;
            }
            if (currentCardIndex >= services.length) {
                stack.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-emoji">🎉</div>
                        <h3>You've seen them all!</h3>
                        <p>You've browsed every deal. New services are added regularly — check back soon!</p>
                        <div class="empty-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <button onclick="currentCardIndex=0;renderCards();" style="margin-top:24px;padding:12px 28px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>Start Over
                        </button>
                    </div>`;
                return;
            }
            for (let i = currentCardIndex; i < Math.min(currentCardIndex + 3, services.length); i++) {
                const card = createCard(services[i], i - currentCardIndex);
                stack.appendChild(card);
            }
            if (currentCardIndex === 0) showSwipeHint();
        }

        function createCard(service, stackPosition) {
            if (service._isPlusCard) return createPlusCard(stackPosition);
            const card = document.createElement('div');
            card.className = 'service-card';
            card.style.transform = `scale(${1 - stackPosition * 0.05}) translateY(${stackPosition * 10}px)`;
            card.style.zIndex = 100 - stackPosition;
            const serviceId = service._id || service.id;

            const today = new Date().getDay();
            const isWknd = today === 0 || today === 6;
            const dealPrice = isWknd ? service.weekendPrice : service.weekdayPrice;
            const dealSlots = isWknd ? service.weekendSlots : service.weekdaySlots;
            const slotsUsed = isWknd ? service.weekendSlotsUsed : service.weekdaySlotsUsed;
            const slotsLeft = dealSlots !== null && dealSlots !== undefined ? dealSlots - (slotsUsed || 0) : null;

            const dealEnded = !service.dealActive || (slotsLeft !== null && slotsLeft <= 0);

            if (dealEnded) card.classList.add('deal-ended');

            const imageContent = service.photos && service.photos[0]
                ? `<img src="${service.photos[0]}" alt="${service.serviceType}" style="width:100%;height:100%;object-fit:cover;">`
                : `<div style="font-size:72px;display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);">${getServiceEmoji(service.serviceType)}</div>`;

            // Deal price badge HTML with slots overlaid
            let priceHTML = '';
            let slotsBadge = '';
            
            // Slots badge — overlaid on bottom-right of price card
            if (dealEnded && !service.dealActive) {
                slotsBadge = `<div style="position:absolute;bottom:8px;right:8px;background:rgba(255,255,255,0.95);color:#6b7280;font-size:10px;font-weight:800;padding:4px 8px;border-radius:12px;line-height:1.3;box-shadow:0 2px 6px rgba(0,0,0,0.15);">🚫 OFF</div>`;
            } else if (slotsLeft !== null) {
                if (slotsLeft <= 0) {
                    slotsBadge = `<div style="position:absolute;bottom:8px;right:8px;background:#ef4444;color:white;font-size:10px;font-weight:800;padding:4px 8px;border-radius:12px;line-height:1.3;box-shadow:0 2px 8px rgba(239,68,68,0.4);">0 left</div>`;
                } else if (slotsLeft <= 3) {
                    slotsBadge = `<div style="position:absolute;bottom:8px;right:8px;background:#fbbf24;color:#92400e;font-size:10px;font-weight:800;padding:4px 8px;border-radius:12px;line-height:1.3;animation:slotBlink 1s ease-in-out infinite;box-shadow:0 2px 8px rgba(251,191,36,0.5);">🔥 ${slotsLeft} left</div>`;
                } else {
                    slotsBadge = `<div style="position:absolute;bottom:8px;right:8px;background:rgba(255,255,255,0.95);color:#667eea;font-size:10px;font-weight:800;padding:4px 8px;border-radius:12px;line-height:1.3;box-shadow:0 2px 6px rgba(0,0,0,0.15);">🎟️ ${slotsLeft} left</div>`;
                }
            } else {
                slotsBadge = `<div style="position:absolute;bottom:8px;right:8px;background:rgba(255,255,255,0.9);color:#667eea;font-size:12px;font-weight:800;padding:4px 10px;border-radius:12px;line-height:1.3;box-shadow:0 2px 6px rgba(0,0,0,0.15);">∞</div>`;
            }

            if (service.normalPrice && service.normalPrice > dealPrice) {
                const pct = Math.round((1 - dealPrice / service.normalPrice) * 100);
                priceHTML = `
                    <div class="deal-price-badge">
                        ${slotsBadge}
                        <div class="deal-pct">-${pct}%</div>
                        <div class="price-label">${isWknd ? 'Weekend' : 'Weekday'} Deal</div>
                        <div class="deal-actual">$${dealPrice}</div>
                        <div class="deal-normal">$${service.normalPrice}</div>
                    </div>`;
            } else {
                priceHTML = `
                    <div class="deal-price-badge">
                        ${slotsBadge}
                        <div class="price-label">${isWknd ? 'Weekend' : 'Weekday'} Deal</div>
                        <div class="deal-actual">$${dealPrice}</div>
                    </div>`;
            }

            // Ended banner — card stays visible, banner makes it obvious
            const endedOverlay = dealEnded ? `
                <div class="deal-ended-overlay">
                    <div class="ended-text">Deal Ended</div>
                    <div class="ended-sub">· Stay tuned for the next one</div>
                </div>` : '';


            const igIcon = service.instagram ? `<a href="${service.instagram}" target="_blank" onclick="event.stopPropagation()" style="display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);box-shadow:0 2px 6px rgba(0,0,0,0.3);"><svg viewBox="0 0 24 24" width="13" height="13" fill="white"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg></a>` : '';
            const ttIcon = service.tiktok ? `<a href="${service.tiktok}" target="_blank" onclick="event.stopPropagation()" style="display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#010101;box-shadow:0 2px 6px rgba(0,0,0,0.3);"><svg viewBox="0 0 24 24" width="13" height="13" fill="white"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.75a8.16 8.16 0 004.77 1.52V6.79a4.85 4.85 0 01-1-.1z"/></svg></a>` : '';
            const fbIcon = service.facebook ? `<a href="${service.facebook}" target="_blank" onclick="event.stopPropagation()" style="display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#1877F2;box-shadow:0 2px 6px rgba(0,0,0,0.3);"><svg viewBox="0 0 24 24" width="13" height="13" fill="white"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>` : '';
            const socialOverlay = (igIcon || ttIcon || fbIcon) ? `<div style="position:absolute;bottom:8px;right:8px;display:flex;gap:5px;z-index:6;">${igIcon}${ttIcon}${fbIcon}</div>` : '';

            card.innerHTML = `
                <div class="swipe-indicator like-indicator">LIKE</div>
                <div class="swipe-indicator nope-indicator">NOPE</div>
                <div class="card-image" style="position:relative;">${imageContent}${endedOverlay}${socialOverlay}</div>
                <div class="card-content">
                    <div class="service-header">
                        <div>
                            <div class="service-title">${service.serviceType}</div>
                            <div class="provider-name">by ${service.providerName}</div>
                        </div>
                        <div class="service-type">${service.location}</div>
                    </div>
                    <div class="service-description">${service.description}</div>
                    <div class="price-display">${priceHTML}</div>
                </div>`;

            if (stackPosition !== 0) return card;

            let startX, startY, currentX, isDragging = false, swipeDirection = null;
            card.addEventListener('mousedown', e => { if (e.target.closest('.card-action-row')) return; isDragging = true; currentX = undefined; startX = e.clientX; card.style.transition = 'none'; });
            card.addEventListener('touchstart', e => { if (e.target.closest('.card-action-row')) return; isDragging = true; swipeDirection = null; currentX = undefined; startX = e.touches[0].clientX; startY = e.touches[0].clientY; card.style.transition = 'none'; }, { passive: true });
            document.addEventListener('mousemove', e => { if (!isDragging) return; currentX = e.clientX; const diff = currentX - startX; card.style.transform = `translateX(${diff}px) rotate(${diff/20}deg)`; card.classList.toggle('swiping-right', diff > 50); card.classList.toggle('swiping-left', diff < -50); });
            // touch-action:none on .service-card disables ALL native browser gestures on the card.
            // -webkit-overflow-scrolling:touch is NOT used (would create an iOS UIScrollView that
            // conflicts with JS scrollTop). Instead JS drives card-content scroll via scrollTop so
            // it works identically on Safari, Chrome, and desktop.
            const cardContent = card.querySelector('.card-content');
            let ccDir = null, ccPrevY = null, ccVel = 0, ccRaf = null;
            cardContent.addEventListener('touchstart', () => { ccDir = null; ccPrevY = null; ccVel = 0; if (ccRaf) { cancelAnimationFrame(ccRaf); ccRaf = null; } }, { passive: true });
            cardContent.addEventListener('touchmove', e => { const cy = e.touches[0].clientY, cx = e.touches[0].clientX; if (!ccDir) { const dx = Math.abs(cx - startX), dy = Math.abs(cy - startY); if (dx > 5 || dy > 5) ccDir = dy > dx ? 'vertical' : 'horizontal'; } if (ccDir !== 'vertical') return; if (ccPrevY !== null) { ccVel = ccPrevY - cy; cardContent.scrollTop = Math.max(0, Math.min(cardContent.scrollTop + ccVel, cardContent.scrollHeight - cardContent.clientHeight)); } ccPrevY = cy; }, { passive: true });
            cardContent.addEventListener('touchend', () => { ccPrevY = null; if (Math.abs(ccVel) < 1) return; (function momentum() { ccVel *= 0.92; if (Math.abs(ccVel) < 0.5) { ccVel = 0; ccRaf = null; return; } cardContent.scrollTop = Math.max(0, Math.min(cardContent.scrollTop + ccVel, cardContent.scrollHeight - cardContent.clientHeight)); ccRaf = requestAnimationFrame(momentum); })(); }, { passive: true });
            document.addEventListener('touchmove', e => { if (!isDragging) return; const diffX = e.touches[0].clientX - startX; const diffY = e.touches[0].clientY - startY; if (!swipeDirection && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) { swipeDirection = Math.abs(diffX) > Math.abs(diffY) ? 'horizontal' : 'vertical'; } if (!swipeDirection || swipeDirection === 'vertical') return; currentX = e.touches[0].clientX; card.style.transform = `translateX(${diffX}px) rotate(${diffX/20}deg)`; card.classList.toggle('swiping-right', diffX > 50); card.classList.toggle('swiping-left', diffX < -50); }, { passive: true });
            const endDrag = () => { if (!isDragging) return; isDragging = false; swipeDirection = null; card.style.transition = 'transform 0.3s'; const diff = (currentX || startX) - startX; if (diff > 100) handleSwipeRight(); else if (diff < -100) swipeCard('left'); else { card.style.transform = `scale(${1 - stackPosition * 0.05}) translateY(${stackPosition * 10}px)`; card.classList.remove('swiping-right', 'swiping-left'); } };
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            card.addEventListener('click', e => { if (!isDragging && !e.target.closest('.card-action-row')) showDetails(); });
            return card;
        }

        function swipeLeft() { swipeCard('left'); }

        function handlePlusCardRight() {
            swipeCard('right');
            setTimeout(() => showSlowDayPlusModal(), 350);
        }

        function createPlusCard(stackPosition) {
            const card = document.createElement('div');
            card.className = 'service-card';
            card.style.transform = `scale(${1 - stackPosition * 0.05}) translateY(${stackPosition * 10}px)`;
            card.style.zIndex = 100 - stackPosition;


            card.innerHTML = `
                <div class="swipe-indicator like-indicator" style="color:#d97706;border-color:#d97706;">⚡ UPGRADE</div>
                <div class="swipe-indicator nope-indicator">SKIP</div>
                <div class="card-image" style="position:relative;background:linear-gradient(135deg,#f59e0b 0%,#d97706 60%,#b45309 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;overflow:hidden;">
                    <!-- radial glow -->
                    <div style="position:absolute;inset:0;background:radial-gradient(circle at 60% 30%,rgba(255,255,255,0.2) 0%,transparent 60%);pointer-events:none;"></div>
                    <!-- shimmer sweep -->
                    <div style="position:absolute;top:0;left:0;width:35%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.18),transparent);animation:plusCardShimmer 2.8s ease-in-out infinite;pointer-events:none;"></div>
                    <!-- floating sparkles -->
                    <div style="position:absolute;top:22%;left:18%;font-size:16px;animation:sparkleFloat 2.4s ease-in-out infinite;--sy:-38px;--sx:-18px;">✨</div>
                    <div style="position:absolute;top:18%;right:16%;font-size:13px;animation:sparkleFloat 2.4s ease-in-out infinite 0.8s;--sy:-32px;--sx:16px;">⭐</div>
                    <div style="position:absolute;bottom:28%;left:14%;font-size:11px;animation:sparkleFloat 2.4s ease-in-out infinite 1.5s;--sy:-28px;--sx:-12px;">✨</div>
                    <div style="position:absolute;bottom:25%;right:12%;font-size:14px;animation:sparkleFloat 2.4s ease-in-out infinite 2s;--sy:-30px;--sx:14px;">⭐</div>
                    <!-- MEMBERS ONLY — centred in flow -->
                    <div style="background:rgba(0,0,0,0.28);color:white;font-size:11px;font-weight:800;padding:5px 14px;border-radius:20px;letter-spacing:0.8px;backdrop-filter:blur(6px);">👑 MEMBERS ONLY</div>
                    <!-- animated bolt -->
                    <div style="font-size:72px;line-height:1;animation:plusBoltBounce 1.7s cubic-bezier(.36,.07,.19,.97) infinite;">⚡</div>
                    <!-- SlowDay+ with pulsing + -->
                    <div style="font-size:30px;font-weight:900;color:white;letter-spacing:-0.5px;text-shadow:0 2px 10px rgba(0,0,0,0.2);">SlowDay<span style="color:#fef3c7;display:inline-block;animation:plusSignPulse 1.4s ease-in-out infinite 0.85s;">+</span></div>
                    <div style="font-size:13px;color:rgba(255,255,255,0.88);font-weight:600;">Members-only perks, every day</div>
                </div>
                <div class="card-content">
                    <div class="service-header">
                        <div>
                            <div class="service-title">Get 10% off every deal</div>
                            <div class="provider-name" style="margin-top:4px;">
                                <span style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;font-size:11px;font-weight:800;padding:2px 10px;border-radius:20px;">SlowDay+</span>
                                <span style="color:#888;font-size:12px;margin-left:6px;">cancel anytime</span>
                            </div>
                        </div>
                        <div style="text-align:right;flex-shrink:0;">
                            <div style="font-size:26px;font-weight:900;color:#d97706;line-height:1;">$4.99</div>
                            <div style="font-size:11px;color:#888;">/month</div>
                        </div>
                    </div>
                    <div class="service-description" style="display:flex;flex-wrap:wrap;gap:6px;">
                        <span style="background:#fef3c7;color:#92400e;font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;">👑 Members badge</span>
                        <span style="background:#fef3c7;color:#92400e;font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;">💸 10% off all deals</span>
                        <span style="background:#fef3c7;color:#92400e;font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;">🎟️ First access to slots</span>
                    </div>
                    <div class="price-display">
                        <div style="background:linear-gradient(135deg,#4f46e5,#7c3aed);border-radius:12px;padding:11px 14px;text-align:center;">
                            <div style="font-size:13px;font-weight:700;color:white;">✨ 14-day free trial — no charge now</div>
                        </div>
                    </div>
                </div>`;

            if (stackPosition !== 0) return card;

            let startX, startY, currentX, isDragging = false, swipeDirection = null;
            card.addEventListener('mousedown', e => { if (e.target.closest('.card-action-row')) return; isDragging = true; currentX = undefined; startX = e.clientX; card.style.transition = 'none'; });
            card.addEventListener('touchstart', e => { if (e.target.closest('.card-action-row')) return; isDragging = true; swipeDirection = null; currentX = undefined; startX = e.touches[0].clientX; startY = e.touches[0].clientY; card.style.transition = 'none'; }, { passive: true });
            document.addEventListener('mousemove', e => { if (!isDragging) return; currentX = e.clientX; const diff = currentX - startX; card.style.transform = `translateX(${diff}px) rotate(${diff/20}deg)`; card.classList.toggle('swiping-right', diff > 50); card.classList.toggle('swiping-left', diff < -50); });
            // touch-action:none on .service-card disables ALL native browser gestures on the card.
            // -webkit-overflow-scrolling:touch is NOT used (would create an iOS UIScrollView that
            // conflicts with JS scrollTop). Instead JS drives card-content scroll via scrollTop so
            // it works identically on Safari, Chrome, and desktop.
            const cardContent = card.querySelector('.card-content');
            let ccDir = null, ccPrevY = null, ccVel = 0, ccRaf = null;
            cardContent.addEventListener('touchstart', () => { ccDir = null; ccPrevY = null; ccVel = 0; if (ccRaf) { cancelAnimationFrame(ccRaf); ccRaf = null; } }, { passive: true });
            cardContent.addEventListener('touchmove', e => { const cy = e.touches[0].clientY, cx = e.touches[0].clientX; if (!ccDir) { const dx = Math.abs(cx - startX), dy = Math.abs(cy - startY); if (dx > 5 || dy > 5) ccDir = dy > dx ? 'vertical' : 'horizontal'; } if (ccDir !== 'vertical') return; if (ccPrevY !== null) { ccVel = ccPrevY - cy; cardContent.scrollTop = Math.max(0, Math.min(cardContent.scrollTop + ccVel, cardContent.scrollHeight - cardContent.clientHeight)); } ccPrevY = cy; }, { passive: true });
            cardContent.addEventListener('touchend', () => { ccPrevY = null; if (Math.abs(ccVel) < 1) return; (function momentum() { ccVel *= 0.92; if (Math.abs(ccVel) < 0.5) { ccVel = 0; ccRaf = null; return; } cardContent.scrollTop = Math.max(0, Math.min(cardContent.scrollTop + ccVel, cardContent.scrollHeight - cardContent.clientHeight)); ccRaf = requestAnimationFrame(momentum); })(); }, { passive: true });
            document.addEventListener('touchmove', e => { if (!isDragging) return; const diffX = e.touches[0].clientX - startX; const diffY = e.touches[0].clientY - startY; if (!swipeDirection && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) { swipeDirection = Math.abs(diffX) > Math.abs(diffY) ? 'horizontal' : 'vertical'; } if (!swipeDirection || swipeDirection === 'vertical') return; currentX = e.touches[0].clientX; card.style.transform = `translateX(${diffX}px) rotate(${diffX/20}deg)`; card.classList.toggle('swiping-right', diffX > 50); card.classList.toggle('swiping-left', diffX < -50); }, { passive: true });
            const endDrag = () => { if (!isDragging) return; isDragging = false; swipeDirection = null; card.style.transition = 'transform 0.3s'; const diff = (currentX || startX) - startX; if (diff > 100) handlePlusCardRight(); else if (diff < -100) swipeCard('left'); else { card.style.transform = `scale(${1 - stackPosition * 0.05}) translateY(${stackPosition * 10}px)`; card.classList.remove('swiping-right', 'swiping-left'); } };
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            card.addEventListener('click', e => { if (!isDragging && !e.target.closest('.card-action-row')) showSlowDayPlusModal(); });
            return card;
        }

        async function handleSwipeRight() {
            if (services[currentCardIndex] && services[currentCardIndex]._isPlusCard) {
                handlePlusCardRight();
                return;
            }
            if (!currentUser) {
                showToast('Please log in to save services!', true);
                showAuthModal();
                swipeCard('right');
                return;
            }
            const service = services[currentCardIndex];
            const serviceId = service._id || service.id;
            try {
                if (!savedServices.find(s => (s._id || s.id) === serviceId)) {
                    await API.saveService(serviceId);
                    await loadSavedServices();
                }
            } catch (error) { console.error('Error saving:', error); }
            swipeCard('right');
        }

        function swipeRight() { handleSwipeRight(); }

        function swipeCard(direction) {
            const cards = document.querySelectorAll('.service-card');
            if (!cards.length) return;
            const topCard = cards[0];
            topCard.style.transform = `translateX(${direction === 'right' ? 1000 : -1000}px) rotate(${direction === 'right' ? 30 : -30}deg)`;
            setTimeout(() => { currentCardIndex++; renderCards(); }, 300);
        }

        // ============================================
        // SHARE DEAL
        // ============================================
        async function handleDealDeepLink() {
            const dealId = sessionStorage.getItem('dealDeepLink');
            if (!dealId) return;
            sessionStorage.removeItem('dealDeepLink');
            try {
                const response = await API.getService(dealId);
                if (response.success && response.service) {
                    showDetails(response.service);
                }
            } catch (e) {
                console.log('Deal not found:', dealId);
            }
        }

        function shareDeal(serviceId) {
            const url = window.location.origin + window.location.pathname + '?deal=' + serviceId;
            if (navigator.share) {
                navigator.share({ title: 'Check out this deal on SlowDay!', url: url }).catch(() => {});
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Link copied to clipboard!');
                }).catch(() => {
                    showToast('Could not copy link', true);
                });
            }
        }

        // ============================================
        // DETAILS & BOOKING
        // ============================================
        function showDetails(svcOverride, cancelBookingId, bookingPrice, bookingDate) {
            const service = svcOverride || services[currentCardIndex];
            if (!service) return;
            const serviceId = service._id || service.id;
            const modal = document.getElementById('detailModal');
            // Photo slideshow (multiple photos) or single image
            let imageContent;
            if (service.photos && service.photos.length > 1) {
                window._slidePhotos = service.photos;
                window._slideIdx = 0;
                const pct = (100 / service.photos.length);
                const slides = service.photos.map(p =>
                    `<img src="${p}" alt="" style="width:${pct}%;height:100%;object-fit:cover;flex-shrink:0;">`
                ).join('');
                const dots = service.photos.map((_, i) =>
                    `<div id="slideDot${i}" onclick="event.stopPropagation();goToSlide(${i})" style="width:${i===0?'18px':'7px'};height:7px;border-radius:4px;background:${i===0?'white':'rgba(255,255,255,0.5)'};cursor:pointer;transition:all 0.25s;"></div>`
                ).join('');
                imageContent = `<div id="slideContainer" style="position:relative;overflow:hidden;border-radius:15px;margin-bottom:20px;height:250px;background:#000;">
                    <div id="slideTrack" style="display:flex;height:100%;width:${service.photos.length*100}%;transition:transform 0.35s ease;">${slides}</div>
                    <button onclick="event.stopPropagation();goToSlide(window._slideIdx-1)" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:50%;border:none;background:rgba(0,0,0,0.45);color:white;font-size:20px;cursor:pointer;line-height:1;">‹</button>
                    <button onclick="event.stopPropagation();goToSlide(window._slideIdx+1)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:50%;border:none;background:rgba(0,0,0,0.45);color:white;font-size:20px;cursor:pointer;line-height:1;">›</button>
                    <div style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px;align-items:center;">${dots}</div>
                    <div id="slideCounter" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.5);color:white;font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px;">1 / ${service.photos.length}</div>
                </div>`;
            } else if (service.photos && service.photos.length === 1) {
                imageContent = `<img src="${service.photos[0]}" alt="${service.serviceType}" class="detail-image">`;
            } else {
                imageContent = `<div class="detail-image" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-size:80px;">${getServiceEmoji(service.serviceType)}</div>`;
            }
            const encodedLocation = encodeURIComponent(service.location);
            const mapsUrl = `https://maps.apple.com/?q=${encodedLocation}`;
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
            document.getElementById('modalBody').innerHTML = `
                ${imageContent}
                <div class="detail-section"><h3 style="display:flex;align-items:center;justify-content:space-between;">${service.serviceType}<button onclick="event.stopPropagation();shareDeal('${serviceId}')" style="background:none;border:1.5px solid #e0e0e0;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;" title="Share deal"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button></h3><p style="color:#666;font-size:14px;margin-bottom:10px;">by ${service.providerName}</p><p style="color:#555;line-height:1.6;">${service.description}</p></div>
                <div class="detail-section">
                    <div class="location-header" onclick="toggleMap('${encodedLocation}')">
                        <h3 style="margin:0;white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>Location</h3>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="color:#555;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;">${service.location}</span>
                            <svg viewBox="0 0 24 24" width="18" height="18" id="mapChevron" fill="none" stroke="#667eea" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                    </div>
                    <div id="mapExpand" style="display:none;margin-top:12px;">
                        <div style="border-radius:14px;overflow:hidden;border:1.5px solid #e0e0e0;">
                            <iframe id="mapIframe" width="100%" height="200" frameborder="0" style="border:0;display:block;" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" src=""></iframe>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <a href="${mapsUrl}" target="_blank" class="dir-btn" style="background:#000;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                                Apple Maps
                            </a>
                            <a href="${googleMapsUrl}" target="_blank" class="dir-btn" style="background:#4285f4;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                                Google Maps
                            </a>
                        </div>
                    </div>
                </div>
                <div class="detail-section"><h3 style="display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>${cancelBookingId ? 'Your Booking' : 'Pricing'}</h3>
                    ${(() => {
                        if (cancelBookingId && bookingPrice != null) {
                            const np = service.normalPrice;
                            const paid = parseFloat(bookingPrice);
                            const savings = np && np > paid ? (np - paid).toFixed(2) : null;
                            const discountPct = savings ? Math.round((1 - paid / np) * 100) : 0;
                            const dateStr = bookingDate ? new Date(bookingDate).toLocaleString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' }) : null;
                            return `
                            <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:14px;padding:20px;color:white;">
                                ${dateStr ? `
                                <div style="margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,0.25);">
                                    <div style="font-size:11px;font-weight:700;text-transform:uppercase;opacity:0.7;margin-bottom:4px;display:flex;align-items:center;gap:5px;"><svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Your Appointment</div>
                                    <div style="font-size:16px;font-weight:700;">${dateStr}</div>
                                </div>` : ''}
                                <div style="font-size:12px;font-weight:700;text-transform:uppercase;opacity:0.8;margin-bottom:6px;">Price you're paying</div>
                                <div style="font-size:36px;font-weight:800;line-height:1;">$${paid}</div>
                                ${savings ? `
                                <div style="display:flex;align-items:center;gap:8px;margin-top:10px;">
                                    <div style="font-size:13px;opacity:0.65;text-decoration:line-through;">was $${np}</div>
                                    <div style="background:#fbbf24;color:#92400e;font-size:12px;font-weight:800;padding:3px 10px;border-radius:20px;">-${discountPct}% OFF</div>
                                </div>
                                <div style="margin-top:8px;font-size:14px;font-weight:600;opacity:0.9;">🎉 You're saving $${savings}!</div>
                                ` : ''}
                            </div>`;
                        }
                        const wdSlots = service.weekdaySlots;
                        const weSlots = service.weekendSlots;
                        const wdUsed  = service.weekdaySlotsUsed || 0;
                        const weUsed  = service.weekendSlotsUsed || 0;
                        const wdLeft  = wdSlots != null ? wdSlots - wdUsed : null;
                        const weLeft  = weSlots != null ? weSlots - weUsed : null;
                        const dealOff = !service.dealActive;

                        function pctBadge(normal, deal) {
                            if (!normal || normal <= deal) return '';
                            const pct = Math.round((1 - deal/normal)*100);
                            return `<span style="background:#fbbf24;color:#92400e;font-size:10px;font-weight:800;padding:2px 7px;border-radius:20px;margin-left:6px;vertical-align:middle;">-${pct}%</span>`;
                        }

                        function slotLine(left) {
                            return ''; // Moved to top-right badge
                        }

                        function slotBadge(left) {
                            if (dealOff) return `<div style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.25);color:white;font-size:10px;font-weight:700;padding:4px 8px;border-radius:20px;backdrop-filter:blur(4px);">🚫 OFF</div>`;
                            if (left === null) return `<div style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.25);color:white;font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;backdrop-filter:blur(4px);">∞</div>`;
                            if (left <= 0)  return `<div style="position:absolute;top:10px;right:10px;background:#ef4444;color:white;font-size:10px;font-weight:700;padding:4px 8px;border-radius:20px;box-shadow:0 2px 8px rgba(239,68,68,0.4);">SOLD OUT</div>`;
                            if (left <= 3)  return `<div style="position:absolute;top:10px;right:10px;background:#ef4444;color:white;font-size:10px;font-weight:700;padding:4px 8px;border-radius:20px;animation:slotBlink 1s ease-in-out infinite;box-shadow:0 2px 8px rgba(239,68,68,0.4);">🔥 ${left} LEFT</div>`;
                            return `<div style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.25);color:white;font-size:10px;font-weight:700;padding:4px 8px;border-radius:20px;backdrop-filter:blur(4px);">🎟️ ${left}</div>`;
                        }

                        function normalLine(normal, deal) {
                            if (!normal || normal <= deal) return '';
                            return `<div style="font-size:12px;color:rgba(255,255,255,0.6);text-decoration:line-through;margin-top:2px;">was $${normal}</div>`;
                        }

                        const dealStatusBanner = dealOff
                            ? `<div style="background:#fee2e2;border:1px solid #fca5a5;border-radius:10px;padding:10px 14px;margin-bottom:14px;color:#991b1b;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;">🚫 This deal is currently turned off</div>`
                            : '';

                        const wdDisabled = dealOff || (wdLeft !== null && wdLeft <= 0);
                        const weDisabled = dealOff || (weLeft !== null && weLeft <= 0);

                        return `
                        ${dealStatusBanner}
                        <div style="display:flex;gap:10px;">
                            <div onclick="${wdDisabled ? '' : `openBookingModal('${serviceId}', 'weekday')`}" style="position:relative;flex:1;background:${dealOff?'#f3f4f6':'linear-gradient(135deg,#667eea,#764ba2)'};border-radius:12px;padding:14px;text-align:center;${dealOff?'filter:grayscale(1);opacity:0.6;':'box-shadow:0 4px 15px rgba(102,126,234,0.3);animation:dealPulse 2s ease-in-out infinite;'}${wdDisabled?'':'cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;'}" ${wdDisabled?'':'onmouseenter="this.style.transform=\'scale(1.03)\';this.style.boxShadow=\'0 6px 25px rgba(102,126,234,0.5)\';" onmouseleave="this.style.transform=\'scale(1)\';this.style.boxShadow=\'0 4px 15px rgba(102,126,234,0.3)\';"'}>
                                ${slotBadge(wdLeft)}
                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:${dealOff?'#9ca3af':'rgba(255,255,255,0.8)'};margin-bottom:4px;padding-top:22px;">WEEKDAYS</div>
                                <div style="font-size:26px;font-weight:800;color:${dealOff?'#6b7280':'white'};line-height:1;">$${currentUserIsPlus ? getPlusDiscount(service.weekdayPrice) : service.weekdayPrice}${pctBadge(service.normalPrice, service.weekdayPrice)}${currentUserIsPlus ? '<span style="display:block;font-size:11px;font-weight:700;color:rgba(255,255,255,0.8);margin-top:2px;">👑 Members price</span>' : ''}</div>
                                ${normalLine(service.normalPrice, service.weekdayPrice)}
                            </div>
                            <div onclick="${weDisabled ? '' : `openBookingModal('${serviceId}', 'weekend')`}" style="position:relative;flex:1;background:${dealOff?'#f3f4f6':'linear-gradient(135deg,#764ba2,#f093fb)'};border-radius:12px;padding:14px;text-align:center;${dealOff?'filter:grayscale(1);opacity:0.6;':'box-shadow:0 4px 15px rgba(118,75,162,0.3);animation:dealPulse 2s ease-in-out infinite;'}${weDisabled?'':'cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;'}" ${weDisabled?'':'onmouseenter="this.style.transform=\'scale(1.03)\';this.style.boxShadow=\'0 6px 25px rgba(118,75,162,0.5)\';" onmouseleave="this.style.transform=\'scale(1)\';this.style.boxShadow=\'0 4px 15px rgba(118,75,162,0.3)\';"'}>
                                ${slotBadge(weLeft)}
                                <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:${dealOff?'#9ca3af':'rgba(255,255,255,0.8)'};margin-bottom:4px;padding-top:22px;">WEEKENDS</div>
                                <div style="font-size:26px;font-weight:800;color:${dealOff?'#6b7280':'white'};line-height:1;">$${currentUserIsPlus ? getPlusDiscount(service.weekendPrice) : service.weekendPrice}${pctBadge(service.normalPrice, service.weekendPrice)}${currentUserIsPlus ? '<span style="display:block;font-size:11px;font-weight:700;color:rgba(255,255,255,0.8);margin-top:2px;">👑 Members price</span>' : ''}</div>
                                ${normalLine(service.normalPrice, service.weekendPrice)}
                            </div>
                        </div>`;
                    })()}
                </div>
                ${(service.contact || service.instagram || service.tiktok || service.facebook) ? `
                <div class="detail-section">
                    <h3 style="display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13 19.79 19.79 0 0 1 1.61 4.27 2 2 0 0 1 3.6 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>Contact & Socials</h3>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                        ${service.contact ? `<a href="tel:${service.contact}" style="display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:25px;background:#22c55e;color:white;text-decoration:none;font-size:13px;font-weight:700;box-shadow:0 3px 12px rgba(34,197,94,0.35);"><svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>${service.contact}</a>` : ''}
                        ${service.instagram ? `<a href="${service.instagram}" target="_blank" style="display:flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);box-shadow:0 3px 10px rgba(220,39,67,0.35);text-decoration:none;"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg></a>` : ''}
                        ${service.tiktok ? `<a href="${service.tiktok}" target="_blank" style="display:flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:50%;background:#010101;box-shadow:0 3px 10px rgba(0,0,0,0.25);text-decoration:none;"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.75a8.16 8.16 0 004.77 1.52V6.79a4.85 4.85 0 01-1-.1z"/></svg></a>` : ''}
                        ${service.facebook ? `<a href="${service.facebook}" target="_blank" style="display:flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:50%;background:#1877F2;box-shadow:0 3px 10px rgba(24,119,242,0.35);text-decoration:none;"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>` : ''}
                    </div>
                </div>` : ''}
                ${(() => {
                    if (cancelBookingId) {
                        const np = service.normalPrice;
                        const savings = (np && bookingPrice != null && np > bookingPrice) ? (np - bookingPrice).toFixed(2) : 0;
                        return `<button onclick="cancelBookingFromDetail('${cancelBookingId}',${savings})" style="width:100%;padding:12px;border:1.5px solid #d1d5db;border-radius:12px;background:white;color:#9ca3af;font-size:14px;font-weight:600;cursor:pointer;margin-top:4px;">Cancel Booking</button>`;
                    }
                    const today = new Date().getDay();
                    const isWknd = today === 0 || today === 6;
                    const slots = isWknd ? service.weekendSlots : service.weekdaySlots;
                    const used = isWknd ? (service.weekendSlotsUsed || 0) : (service.weekdaySlotsUsed || 0);
                    const slotsLeft = slots != null ? slots - used : null;
                    const unavailable = !service.dealActive || (slotsLeft !== null && slotsLeft <= 0);
                    return unavailable
                        ? `<button class="book-now-btn" disabled style="opacity:0.45;cursor:not-allowed;background:#9ca3af;box-shadow:none;">Deal Unavailable</button>`
                        : `<button class="book-now-btn" onclick="openBookingModal('${serviceId}')">Book Now</button>`;
                })()}`;
            modal.classList.add('active');
            const p = document.getElementById('discoverPills'); if (p) p.style.display = 'none';
            document.getElementById('filterTypeDropdown').style.display = 'none';
            initSlideTouch();
        }

        function toggleMap(encodedLocation) {
            const expand = document.getElementById('mapExpand');
            const chevron = document.getElementById('mapChevron');
            const iframe = document.getElementById('mapIframe');
            const isOpen = expand.style.display !== 'none';
            if (isOpen) {
                expand.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                expand.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                // Load map only when opened (lazy)
                if (!iframe.src || iframe.src === window.location.href) {
                    iframe.src = `https://maps.google.com/maps?q=${encodedLocation}&output=embed&z=15`;
                }
            }
        }

        function closeModal() { document.getElementById('detailModal').classList.remove('active'); const p = document.getElementById('discoverPills'); if (p && document.getElementById('navDiscover').classList.contains('active')) p.style.display = 'block'; }

        async function openBookingModal(serviceId, dayType) {
            if (!currentUser) { showToast('Please log in to book services', true); showAuthModal(); return; }
            window._lastDetailDayType = dayType;
            currentBookingService = services.find(s => (s._id || s.id) === serviceId) || savedServices.find(s => (s._id || s.id) === serviceId);
            if (currentBookingService && !currentBookingService.dealActive) { showToast('This deal is currently unavailable.', true); return; }
            document.getElementById('detailModal').classList.remove('active');
            document.getElementById('bookingModal').classList.add('active');
            const _p = document.getElementById('discoverPills'); if (_p) _p.style.display = 'none';
            document.getElementById('bookingSuccess').style.display = 'none';
            document.getElementById('customerName').value = currentUser.name;
            document.getElementById('customerContact').value = currentUser.email || '';

            const windows = currentBookingService.availabilityWindows;
            if (windows && windows.length > 0) {
                // Show slot picker
                document.getElementById('standardPicker').style.display = 'none';
                document.getElementById('slotPicker').style.display = 'block';
                document.getElementById('selectedSlotTime').value = '';
                buildSlotPicker(windows, dayType);
            } else {
                // Show standard picker
                document.getElementById('standardPicker').style.display = 'block';
                document.getElementById('slotPicker').style.display = 'none';
                // Pre-select the first valid date
                const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                let firstValid = new Date(tomorrow);
                if (dayType === 'weekend' || dayType === 'weekday') {
                    for (let i = 0; i < 14; i++) {
                        const dow = firstValid.getDay();
                        const isWknd = dow === 0 || dow === 6;
                        if ((dayType === 'weekend' && isWknd) || (dayType === 'weekday' && !isWknd)) break;
                        firstValid.setDate(firstValid.getDate() + 1);
                    }
                }
                document.getElementById('preferredDate').value = firstValid.toISOString().split('T')[0];
                document.getElementById('preferredHour').value = '09';
                document.getElementById('preferredMinute').value = '00';
                // Init custom calendar with day type restriction
                cdpInit(dayType);
            }
        }

        function validateBookingDate(input) {
            const dayType = window._bookingDayType;
            if (!dayType || (!input.value)) return;
            const d = new Date(input.value + 'T12:00:00');
            const dow = d.getDay(); // 0=Sun, 6=Sat
            const isWknd = dow === 0 || dow === 6;
            if (dayType === 'weekend' && !isWknd) {
                // Jump to next weekend day
                let next = new Date(d);
                for (let i = 1; i <= 7; i++) {
                    next.setDate(next.getDate() + 1);
                    if (next.getDay() === 0 || next.getDay() === 6) break;
                }
                input.value = next.toISOString().split('T')[0];
                showToast('Weekend bookings only: Sat & Sun', false);
            } else if (dayType === 'weekday' && isWknd) {
                // Jump to next weekday
                let next = new Date(d);
                for (let i = 1; i <= 7; i++) {
                    next.setDate(next.getDate() + 1);
                    if (next.getDay() !== 0 && next.getDay() !== 6) break;
                }
                input.value = next.toISOString().split('T')[0];
                showToast('Weekday bookings only: Mon–Fri', false);
            }
        }

        function buildSlotPicker(windows, dayType) {
            const DAY_ORDER = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
            const dayTabsEl = document.getElementById('slotDayTabs');
            const timeGridEl = document.getElementById('slotTimeGrid');
            dayTabsEl.innerHTML = ''; timeGridEl.innerHTML = '';

            // Get next 14 days that match any window day
            const daySlots = {}; // {dateStr: [{time, label}]}
            const today = new Date();
            for (let i = 1; i <= 14; i++) {
                const d = new Date(today); d.setDate(today.getDate() + i);
                const dayName = DAY_ORDER[d.getDay() === 0 ? 6 : d.getDay() - 1];
                
                // Filter dates by dayType
                const dow = d.getDay();
                const isWknd = dow === 0 || dow === 6;
                if (dayType === 'weekday' && isWknd) continue;
                if (dayType === 'weekend' && !isWknd) continue;

                // Also filter windows: weekday booking only uses Mon-Fri windows, weekend only Sat-Sun
                const WEEKEND_DAYS = ['Saturday','Sunday'];
                const WEEKDAY_DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
                const matchingWindows = windows.filter(w => {
                    if (w.day !== dayName) return false;
                    if (dayType === 'weekday' && !WEEKDAY_DAYS.includes(w.day)) return false;
                    if (dayType === 'weekend' && !WEEKEND_DAYS.includes(w.day)) return false;
                    return true;
                });
                if (matchingWindows.length === 0) continue;
                const dateStr = d.toISOString().split('T')[0];
                daySlots[dateStr] = daySlots[dateStr] || [];
                matchingWindows.forEach(w => {
                    // Generate time slots
                    const [sh, sm] = w.startTime.split(':').map(Number);
                    const [eh, em] = w.endTime.split(':').map(Number);
                    let cur = sh * 60 + sm;
                    const end = eh * 60 + em;
                    while (cur + w.sessionDuration <= end) {
                        const hh = Math.floor(cur/60);
                        const mm = cur % 60;
                        const ampm = hh >= 12 ? 'PM' : 'AM';
                        const h12 = hh > 12 ? hh - 12 : hh === 0 ? 12 : hh;
                        const label = `${h12}:${mm.toString().padStart(2,'0')} ${ampm}`;
                        const iso = `${dateStr}T${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}:00`;
                        daySlots[dateStr].push({ iso, label });
                        cur += w.sessionDuration;
                    }
                });
            }

            const dates = Object.keys(daySlots).sort();
            if (dates.length === 0) {
                timeGridEl.innerHTML = '<p style="color:#999;font-size:13px;grid-column:1/-1;">No available slots in the next 2 weeks.</p>';
                return;
            }

            let selectedDate = dates[0];
            function renderTabs() {
                dayTabsEl.innerHTML = '';
                dates.forEach(dateStr => {
                    const d = new Date(dateStr + 'T12:00:00');
                    const label = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = label;
                    btn.style.cssText = `padding:8px 12px;border-radius:20px;border:2px solid ${dateStr===selectedDate?'#667eea':'#e2e8f0'};background:${dateStr===selectedDate?'#667eea':'white'};color:${dateStr===selectedDate?'white':'#444'};font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;`;
                    btn.onclick = () => { selectedDate = dateStr; renderTabs(); renderSlots(); };
                    dayTabsEl.appendChild(btn);
                });
            }

            function renderSlots() {
                timeGridEl.innerHTML = '';
                document.getElementById('selectedSlotTime').value = '';
                (daySlots[selectedDate] || []).forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = slot.label;
                    btn.style.cssText = 'padding:10px 6px;border-radius:10px;border:2px solid #e2e8f0;background:white;color:#444;font-size:13px;font-weight:600;cursor:pointer;text-align:center;';
                    btn.onclick = () => {
                        document.querySelectorAll('#slotTimeGrid button').forEach(b => {
                            b.style.border = '2px solid #e2e8f0';
                            b.style.background = 'white';
                            b.style.color = '#444';
                        });
                        btn.style.border = '2px solid #667eea';
                        btn.style.background = '#667eea';
                        btn.style.color = 'white';
                        document.getElementById('selectedSlotTime').value = slot.iso;
                    };
                    timeGridEl.appendChild(btn);
                });
            }

            renderTabs();
            renderSlots();
        }

        function closeBookingModal() { document.getElementById('bookingModal').classList.remove('active'); const p = document.getElementById('discoverPills'); if (p && document.getElementById('navDiscover').classList.contains('active')) p.style.display = 'block'; }

        async function submitBooking(e) {
            e.preventDefault();
            if (!currentUser) { showToast('Please log in', true); showAuthModal(); return; }
            try {
                const serviceId = currentBookingService._id || currentBookingService.id;
                let preferredTime;

                const windows = currentBookingService.availabilityWindows;
                if (windows && windows.length > 0) {
                    // Slot picker mode
                    preferredTime = document.getElementById('selectedSlotTime').value;
                    if (!preferredTime) { showToast('Please select a time slot', true); return; }
                    preferredTime = new Date(preferredTime).toISOString();
                } else {
                    // Standard picker mode
                    const date = document.getElementById('preferredDate').value;
                    const hour = document.getElementById('preferredHour').value;
                    const minute = document.getElementById('preferredMinute').value;
                    if (!date) { showToast('Please select a date', true); return; }
                    preferredTime = new Date(`${date}T${hour}:${minute}:00`).toISOString();
                }

                const response = await API.createBooking({
                    serviceId,
                    customerContact: document.getElementById('customerContact').value,
                    preferredTime,
                    notes: document.getElementById('bookingNotes').value
                });
                if (response.success) {
                    e.target.reset();
                    try {
                        await API.removeSavedService(serviceId);
                        await loadSavedServices();
                        renderSavedList();
                    } catch(err) { /* already not saved, no problem */ }
                    closeBookingModal();
                    showToast('🎉 Booking request sent! The provider will confirm soon.');
                    showTab('bookings');
                    loadPublicServices(); // Refresh slot counts in the background
                }
            } catch (error) { showToast(error.message || 'Error creating booking.', true); }
        }

        // ============================================
        // SAVED SERVICES
        // ============================================
        async function loadSavedServices() {
            if (!currentUser) { savedServices = []; return; }
            try {
                const response = await API.getSavedServices();
                savedServices = response.services || [];
            } catch (error) { savedServices = []; }
        }

        function renderSavedList() {
            const savedList = document.getElementById('savedList');
            if (!savedServices.length) {
                savedList.innerHTML = `
                    <div class="empty-state" style="padding-top:40px;">
                        <div class="empty-emoji">💝</div>
                        <h3>Nothing saved yet!</h3>
                        <p>Swipe right on services you love and they'll appear here</p>
                        <button onclick="showTab('discover')" style="margin-top:20px;padding:12px 28px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;">
                            🔍 Browse Services
                        </button>
                        <div class="empty-dots" style="margin-top:20px;"><span></span><span></span><span></span></div>
                    </div>`;
                return;
            }
            savedList.innerHTML = savedServices.map(service => {
                const serviceId = service._id || service.id;
                const img = service.photos && service.photos[0]
                    ? `<img src="${service.photos[0]}" alt="${service.serviceType}">`
                    : `<div style="width:80px;height:80px;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:32px;">${getServiceEmoji(service.serviceType)}</div>`;
                const today2 = new Date().getDay();
                const isWknd2 = today2 === 0 || today2 === 6;
                const dealPrice2 = isWknd2 ? service.weekendPrice : service.weekdayPrice;
                const dealSlots2 = isWknd2 ? service.weekendSlots : service.weekdaySlots;
                const slotsUsed2 = isWknd2 ? service.weekendSlotsUsed : service.weekdaySlotsUsed;
                const slotsLeft2 = dealSlots2 != null ? dealSlots2 - (slotsUsed2 || 0) : null;
                const dealEnded2 = !service.dealActive || (slotsLeft2 !== null && slotsLeft2 <= 0);
                const endedStyle = dealEnded2 ? 'filter:grayscale(0.2);border-color:rgba(220,38,38,0.35);' : '';
                const endedBadge = dealEnded2 ? `<div style="display:inline-block;background:#dc2626;color:#fff;font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;margin-bottom:4px;letter-spacing:0.5px;text-transform:uppercase;">Deal Ended</div>` : '';
                const bookBtn = dealEnded2 ? `<button class="book-btn-small" disabled style="opacity:0.4;cursor:not-allowed;">Unavailable</button>` : `<button class="book-btn-small" onclick="openBookingModal('${serviceId}')">Book</button>`;
                const normalPriceStr = service.normalPrice ? `<span style="text-decoration:line-through;color:#aaa;margin-right:4px;">$${service.normalPrice}</span>` : '';
                return `<div class="saved-card" style="${endedStyle}cursor:pointer;" onclick="showDetailFromSaved('${serviceId}')">${img}<div class="saved-card-content"><h3>${service.serviceType}</h3>${endedBadge}<p>${service.providerName} • ${service.location}</p><p style="color:#667eea;font-weight:600;">${normalPriceStr}$${dealPrice2} deal</p><div class="saved-card-actions" onclick="event.stopPropagation();">${bookBtn}<button class="remove-btn" onclick="removeSaved('${serviceId}')">Remove</button></div></div><button class="saved-share-icon" onclick="event.stopPropagation();shareDeal('${serviceId}')" title="Share"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="#667eea" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button></div>`;
            }).join('');
        }

        async function removeSaved(serviceId) {
            try {
                await API.removeSavedService(serviceId);
                await loadSavedServices();
                renderSavedList();
            } catch (error) { showToast('Error removing service.', true); }
        }

        // ============================================
        // PROVIDER
        // ============================================
        // Deal toggle
        let dealActiveState = true;
        function toggleDeal() {
            dealActiveState = !dealActiveState;
            const toggle = document.getElementById('dealToggle');
            const knob = document.getElementById('dealToggleKnob');
            const label = document.getElementById('dealToggleLabel');
            document.getElementById('dealActive').value = dealActiveState;
            if (dealActiveState) {
                toggle.style.background = '#22c55e';
                knob.style.left = '27px';
                label.style.color = '#22c55e';
                label.textContent = 'Deal is LIVE';
            } else {
                toggle.style.background = '#d1d5db';
                knob.style.left = '3px';
                label.style.color = '#9ca3af';
                label.textContent = 'Deal is OFF';
            }
        }

        // Availability windows
        const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        const DURATIONS = [{v:15,l:'15 min'},{v:30,l:'30 min'},{v:45,l:'45 min'},{v:60,l:'1 hour'},{v:90,l:'1 hr 30 min'},{v:120,l:'2 hours'}];

        function addAvailabilityWindow(existing) {
            const list = document.getElementById('availabilityList');
            const idx = list.children.length;
            const div = document.createElement('div');
            div.style.cssText = 'background:#f8f9fa;border-radius:12px;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px 18px;position:relative;';
            div.innerHTML = `
                <div style="position:absolute;top:8px;right:8px;display:flex;gap:4px;">
                    <button type="button" onclick="duplicateAvWindow(this)" title="Duplicate" style="background:#667eea;border:none;color:white;width:28px;height:28px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    </button>
                    <button type="button" onclick="this.closest('[style*=grid]').remove()" title="Remove" style="background:#ef4444;border:none;color:white;width:28px;height:28px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                    </button>
                </div>
                <div style="grid-column:1/-1;">
                    <label style="font-size:12px;font-weight:600;color:#444;">Day</label>
                    <select class="av-day" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-top:4px;">
                        ${DAYS.map(d=>`<option value="${d}" ${existing&&existing.day===d?'selected':''}>${d}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label style="font-size:12px;font-weight:600;color:#444;">Start Time</label>
                    <input type="time" class="av-start" value="${existing?existing.startTime:'09:00'}" style="width:100%;box-sizing:border-box;padding:8px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-top:4px;">
                </div>
                <div>
                    <label style="font-size:12px;font-weight:600;color:#444;">End Time</label>
                    <input type="time" class="av-end" value="${existing?existing.endTime:'17:00'}" style="width:100%;box-sizing:border-box;padding:8px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-top:4px;">
                </div>
                <div style="grid-column:1/-1;">
                    <label style="font-size:12px;font-weight:600;color:#444;">Session Duration</label>
                    <select class="av-dur" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;margin-top:4px;">
                        ${DURATIONS.map(d=>`<option value="${d.v}" ${existing&&existing.sessionDuration===d.v?'selected':''}>${d.l}</option>`).join('')}
                    </select>
                </div>`;
            list.appendChild(div);
        }

        function duplicateAvWindow(btn) {
            const parent = btn.closest('[style*="grid"]');
            const data = {
                day: parent.querySelector('.av-day').value,
                startTime: parent.querySelector('.av-start').value,
                endTime: parent.querySelector('.av-end').value,
                sessionDuration: parseInt(parent.querySelector('.av-dur').value)
            };
            addAvailabilityWindow(data);
        }

        function getAvailabilityWindows() {
            return Array.from(document.getElementById('availabilityList').children).map(div => ({
                day: div.querySelector('.av-day').value,
                startTime: div.querySelector('.av-start').value,
                endTime: div.querySelector('.av-end').value,
                sessionDuration: parseInt(div.querySelector('.av-dur').value)
            }));
        }

        function toUrl(val) {
            if (!val) return '';
            if (/^https?:\/\//i.test(val)) return val;
            return 'https://' + val;
        }

        async function submitProvider(e) {
            e.preventDefault();
            if (!currentUser) { showToast('Please log in', true); return; }
            
            const photoImgs = document.querySelectorAll('#photoPreview .photo-thumb img');
            const photos = Array.from(photoImgs).map(img => img.src);
            const normalPriceVal = document.getElementById('normalPrice').value;

            const serviceData = {
                providerName: document.getElementById('providerName').value,
                serviceType: document.getElementById('serviceType').value,
                description: document.getElementById('serviceDesc').value,
                location: document.getElementById('location').value,
                contact: document.getElementById('providerContact').value,
                email: document.getElementById('providerEmail').value || currentUser.email,
                instagram: toUrl(document.getElementById('providerInstagram').value.trim()),
                tiktok: toUrl(document.getElementById('providerTiktok').value.trim()),
                facebook: toUrl(document.getElementById('providerFacebook').value.trim()),
                normalPrice: normalPriceVal ? parseFloat(normalPriceVal) : null,
                weekdayPrice: parseFloat(document.getElementById('weekdayPrice').value),
                weekendPrice: parseFloat(document.getElementById('weekendPrice').value),
                weekdaySlots: document.getElementById('weekdaySlots').value ? parseInt(document.getElementById('weekdaySlots').value) : null,
                weekendSlots: document.getElementById('weekendSlots').value ? parseInt(document.getElementById('weekendSlots').value) : null,
                dealActive: document.getElementById('dealActive').value === 'true',
                availabilityWindows: getAvailabilityWindows(),
                photos
            };

            try {
                let response;
                if (myService) {
                    response = await API.updateService(myService._id, serviceData);
                    myService = response.service;
                } else {
                    response = await API.createService(serviceData);
                    myService = response.service;
                }
                document.getElementById('providerSubmitBtn').textContent = 'Save Changes';
                renderMyProfile();
                await loadPublicServices();
                currentCardIndex = 0;
                if (currentUser && currentUser.accountType !== 'provider') {
                    currentUser.accountType = 'provider';
                    updateNavForUserType();
                }
                showToast('✅ Profile saved successfully!', false);
            } catch (error) { showToast(error.message || 'Error saving profile.', true); }
        }

        function previewPhotos(e) {
            const preview = document.getElementById('photoPreview');
            const existing = preview.querySelectorAll('.photo-thumb').length;
            const remaining = 6 - existing;
            Array.from(e.target.files).slice(0, remaining).forEach(file => {
                const reader = new FileReader();
                reader.onload = ev => {
                    // Resize to max 600px to keep size small enough for MongoDB
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX = 600;
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX) { h = h * MAX / w; w = MAX; } }
                        else { if (h > MAX) { w = w * MAX / h; h = MAX; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        const resized = canvas.toDataURL('image/jpeg', 0.7);

                        const wrap = document.createElement('div');
                        wrap.className = 'photo-thumb';
                        wrap.style.cssText = 'position:relative;display:inline-block;margin:4px;';

                        const imgEl = document.createElement('img');
                        imgEl.src = resized;
                        imgEl.style.cssText = 'width:80px;height:80px;object-fit:cover;border-radius:8px;display:block;';

                        const xBtn = document.createElement('button');
                        xBtn.type = 'button';
                        xBtn.textContent = '×';
                        xBtn.style.cssText = 'position:absolute;top:-6px;right:-6px;width:20px;height:20px;background:#e53e3e;color:white;border:none;border-radius:50%;font-size:14px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;';
                        xBtn.onclick = () => wrap.remove();

                        wrap.appendChild(imgEl);
                        wrap.appendChild(xBtn);
                        preview.appendChild(wrap);
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            });
            // Reset input so same file can be re-added
            e.target.value = '';
        }

        function openUserProfile() {
            document.getElementById('userDropdown').style.display = 'none';
            document.getElementById('newName').value = currentUser.name || '';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('profileMsg').style.display = 'none';
            document.getElementById('userProfileModal').classList.add('active');
            const p = document.getElementById('discoverPills'); if (p) p.style.display = 'none';
            loadMyTickets();
            loadSubscriptionStatus();
        }

        function showProfileMsg(msg, isError) {
            const el = document.getElementById('profileMsg');
            el.textContent = msg;
            el.style.display = 'block';
            el.style.background = isError ? '#fee2e2' : '#d1fae5';
            el.style.color = isError ? '#e53e3e' : '#059669';
        }

        async function updateName() {
            const name = document.getElementById('newName').value.trim();
            if (!name) { showProfileMsg('Please enter a name', true); return; }
            try {
                const res = await API.updateProfile({ name });
                currentUser.name = name;
                const firstLetter = name.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;
                document.getElementById('dropdownAvatar').textContent = firstLetter;
                document.getElementById('userDropdownName').textContent = name;
                showProfileMsg('✅ Name updated!', false);
            } catch(e) { showProfileMsg(e.message || 'Error updating name', true); }
        }

        async function updatePassword() {
            const current = document.getElementById('currentPassword').value;
            const next = document.getElementById('newPassword').value;
            if (!current || !next) { showProfileMsg('Please fill in both password fields', true); return; }
            if (next.length < 6) { showProfileMsg('New password must be at least 6 characters', true); return; }
            try {
                await API.changePassword(current, next);
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                showProfileMsg('✅ Password changed!', false);
            } catch(e) { showProfileMsg(e.message || 'Current password incorrect', true); }
        }

        function deleteAccount() {
            showConfirmModal('Delete your account? This cannot be undone. All your data will be permanently removed.', 'Delete Account', () => {
                showConfirmModal('Are you absolutely sure? This is irreversible.', 'Yes, Delete Forever', async () => {
                    try {
                        await API.deleteAccount();
                        logout();
                        showToast('Your account has been deleted.', false);
                    } catch(e) { showProfileMsg(e.message || 'Error deleting account', true); }
                });
            });
        }

        // ============================================
        // CALENDAR VIEW
        // ============================================
        let calCurrentDate = new Date();

        function changeCalMonth(delta) {
            calCurrentDate = new Date(calCurrentDate.getFullYear(), calCurrentDate.getMonth() + delta, 1);
            renderCalendar();
        }

        async function loadCalendar() {
            calCurrentDate = new Date(calCurrentDate.getFullYear(), calCurrentDate.getMonth(), 1);
            if (!allProviderBookings.length) await loadProviderBookings();
            renderCalendar();
        }

        function renderCalendar() {
            const year = calCurrentDate.getFullYear();
            const month = calCurrentDate.getMonth();
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            document.getElementById('calMonthLabel').textContent = monthNames[month] + ' ' + year;

            const bookingsByDate = {};
            allProviderBookings.forEach(b => {
                const d = new Date(b.preferredTime);
                const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                if (!bookingsByDate[key]) bookingsByDate[key] = [];
                bookingsByDate[key].push(b);
            });

            const todayStr = new Date().toISOString().split('T')[0];
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calGrid');
            let html = '';

            for (let i = 0; i < firstDay; i++) html += '<div></div>';

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = year + '-' + String(month+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
                const bks = bookingsByDate[dateStr] || [];
                const isToday = dateStr === todayStr;
                const hasPending = bks.some(b => b.status === 'pending');
                const hasConfirmed = bks.some(b => b.status === 'confirmed');
                const dotColor = hasPending ? '#f59e0b' : hasConfirmed ? '#22c55e' : bks.length ? '#667eea' : 'transparent';
                const bgStyle = isToday ? 'background:linear-gradient(135deg,#667eea,#764ba2);' : bks.length ? 'background:rgba(102,126,234,0.1);' : '';
                const textColor = isToday ? 'color:white;' : 'color:#333;';
                const dot = bks.length ? '<div style="width:5px;height:5px;border-radius:50%;background:' + dotColor + ';margin:1px auto 0;"></div>' : '';
                html += '<div onclick="showCalDay(&quot;' + dateStr + '&quot;)" style="text-align:center;padding:6px 2px;border-radius:10px;cursor:' + (bks.length?'pointer':'default') + ';' + bgStyle + '">' +
                    '<div style="font-size:13px;font-weight:' + (isToday?700:400) + ';' + textColor + 'line-height:1.2;">' + d + '</div>' + dot + '</div>';
            }

            grid.innerHTML = html;
            document.getElementById('calDayBookings').innerHTML = '';
        }

        function showCalDay(dateStr) {
            const bks = allProviderBookings.filter(function(b) {
                const d = new Date(b.preferredTime);
                const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                return key === dateStr;
            });
            if (!bks.length) return;
            const el = document.getElementById('calDayBookings');
            const label = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
            let html = '<div style="font-size:14px;font-weight:700;color:#333;margin-bottom:10px;padding:10px 0 8px;border-bottom:1.5px solid #f0f0f0;display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' + label + '</div>';
            bks.sort(function(a,b){ return new Date(a.preferredTime)-new Date(b.preferredTime); }).forEach(function(b) {
                const svc = b.service || {};
                const time = new Date(b.preferredTime).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
                const bid = b._id;
                let actions = '';
                if (b.status === 'pending') {
                    actions = '<div style="display:flex;gap:6px;margin-top:8px;">'
                        + '<button class="action-btn btn-confirm" onclick="updateBooking(\''+bid+'\',\'confirmed\')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 15.01 9 12.01"></polyline></svg>Confirm</button>'
                        + '<button class="action-btn btn-reject" onclick="updateBooking(\''+bid+'\',\'rejected\')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Reject</button>'
                        + '</div>';
                } else if (b.status === 'confirmed') {
                    actions = '<div style="margin-top:8px;">'
                        + '<button class="action-btn btn-reject" onclick="updateBooking(\''+bid+'\',\'cancelled\')">Cancel</button>'
                        + '</div>';
                }
                html += '<div class="booking-card" style="margin-bottom:8px;">'
                    + '<div style="display:flex;justify-content:space-between;align-items:center;">'
                    + '<div>'
                    + '<div style="font-size:15px;font-weight:700;color:#333;">' + time + ' — ' + (svc.serviceType||'Service') + '</div>'
                    + '<div style="font-size:13px;color:#888;margin-top:2px;">' + (b.customerName||'') + ' · ' + (b.customerContact||'') + '</div>'
                    + '</div>'
                    + '<span class="status-pill status-' + b.status + '">' + b.status + '</span>'
                    + '</div>'
                    + (b.notes ? '<div style="font-size:12px;color:#666;margin-top:6px;display:flex;align-items:center;gap:4px;"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>' + b.notes + '</div>' : '')
                    + actions
                    + '</div>';
            });
            el.innerHTML = html;
        }

        // ============================================
        // REAL-TIME POLLING
        // ============================================
        let realtimeInterval = null;

        function startRealtimePolling() {
            if (realtimeInterval) return;
            realtimeInterval = setInterval(async () => {
                if (!currentUser) return;
                const activeBtn = document.querySelector('#providerView .ptab-btn.active');
                if (!activeBtn) return;
                const tabId = activeBtn.id;
                if (tabId !== 'ptabBookings' && tabId !== 'ptabCalendar') return;
                try {
                    const res = await API.getProviderBookings();
                    const fresh = res.bookings || [];
                    const prevSig = allProviderBookings.map(b => b._id + b.status).join();
                    const newSig  = fresh.map(b => b._id + b.status).join();
                    if (newSig === prevSig) return;
                    const prevPending = allProviderBookings.filter(b => b.status === 'pending').length;
                    const newPending  = fresh.filter(b => b.status === 'pending').length;
                    allProviderBookings = fresh;
                    if (tabId === 'ptabBookings') {
                        const activeFilter = document.querySelector('.filter-btn.active');
                        const status = activeFilter ? activeFilter.textContent.trim().replace(/[^a-zA-Z]/g,'').toLowerCase() : 'all';
                        const filtered = status === 'all' ? allProviderBookings : allProviderBookings.filter(b => b.status === status);
                        renderProviderBookings(filtered);
                    } else {
                        renderCalendar();
                    }
                    const badge = document.getElementById('pendingBadge');
                    if (newPending > 0) { badge.textContent = newPending; badge.style.display = 'inline'; }
                    else badge.style.display = 'none';
                    if (newPending > prevPending) showRealtimeToast('🔔 New booking request!');
                } catch(e) {}
            }, 15000);
        }

        function showRealtimeToast(msg) {
            const old = document.getElementById('realtimeToast');
            if (old) old.remove();
            const t = document.createElement('div');
            t.id = 'realtimeToast';
            t.textContent = msg;
            t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px 20px;border-radius:25px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(102,126,234,0.5);';
            document.querySelector('.app-container').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        // ============================================
        // PROVIDER TABS
        // ============================================
        function switchProviderTab(tab) {
            ['profile','bookings','calendar','analytics'].forEach(t => {
                const btn = document.getElementById(`ptab${t.charAt(0).toUpperCase()+t.slice(1)}`);
                const cnt = document.getElementById(`ptab${t.charAt(0).toUpperCase()+t.slice(1)}Content`);
                if (btn) btn.classList.toggle('active', t === tab);
                if (cnt) cnt.style.display = t === tab ? 'block' : 'none';
            });
            if (tab === 'bookings') loadProviderBookings();
            if (tab === 'calendar') loadCalendar();
            if (tab === 'analytics') loadAnalytics();
        }

        // ============================================
        // SAVED SUB-TABS
        // ============================================
        function switchSavedTab(tab) {
            document.getElementById('stabSaved').classList.toggle('active', tab === 'saved');
            document.getElementById('stabMyBookings').classList.toggle('active', tab === 'mybookings');
            document.getElementById('savedListWrap').style.display = tab === 'saved' ? 'block' : 'none';
            document.getElementById('myBookingsWrap').style.display = tab === 'mybookings' ? 'block' : 'none';
            if (tab === 'mybookings') loadMyBookings();
        }

        // ============================================
        // PROVIDER BOOKINGS MANAGEMENT
        // ============================================
        let allProviderBookings = [];
        let rescheduleBookingId = null;

        async function loadProviderBookings() {
            document.getElementById('providerBookingsList').innerHTML = `<div class="empty-state"><div class="empty-emoji">⏳</div><h3>Loading...</h3></div>`;
            try {
                const res = await API.getProviderBookings();
                allProviderBookings = res.bookings || [];
                renderProviderBookings(allProviderBookings);
                // Update pending badge
                const pending = allProviderBookings.filter(b => b.status === 'pending').length;
                const badge = document.getElementById('pendingBadge');
                if (pending > 0) { badge.textContent = pending; badge.style.display = 'inline'; }
                else badge.style.display = 'none';
            } catch(e) {
                document.getElementById('providerBookingsList').innerHTML = `<div class="empty-state"><div class="empty-emoji">⚠️</div><h3>Could not load bookings</h3></div>`;
            }
        }

        function filterProviderBookings(status, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filtered = status === 'all' ? allProviderBookings : allProviderBookings.filter(b => b.status === status);
            renderProviderBookings(filtered);
        }

        function renderProviderBookings(bookings) {
            bookings = [...bookings].sort((a, b) => new Date(b.preferredTime) - new Date(a.preferredTime));
            const el = document.getElementById('providerBookingsList');
            if (!bookings.length) {
                el.innerHTML = `<div class="empty-state"><div class="empty-emoji">📋</div><h3>No bookings here</h3></div>`;
                return;
            }
            el.innerHTML = bookings.map(b => {
                const svc = b.service || {};
                const cust = b.customer || {};
                const date = new Date(b.preferredTime).toLocaleString('en-US', { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
                const actions = b.status === 'pending' ? `
                    <button class="action-btn btn-confirm" onclick="updateBooking('${b._id}','confirmed')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 15.01 9 12.01"></polyline></svg>Confirm</button>
                    <button class="action-btn btn-reschedule" onclick="openReschedule('${b._id}')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>Reschedule</button>
                    <button class="action-btn btn-reject" onclick="updateBooking('${b._id}','rejected')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Reject</button>` :
                b.status === 'confirmed' ? `
                    <button class="action-btn btn-reschedule" onclick="openReschedule('${b._id}')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>Reschedule</button>
                    <button class="action-btn btn-reject" onclick="updateBooking('${b._id}','cancelled')">Cancel</button>` : '';
                return `<div class="booking-card">
                    <div class="booking-card-header">
                        <div>
                            <div class="booking-card-title">${svc.serviceType || 'Service'}</div>
                            <div class="booking-card-sub">${cust.name || b.customerName}</div>
                        </div>
                        <span class="status-pill status-${b.status}">${b.status}</span>
                    </div>
                    <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> <span>Date:</span> ${date}</div>
                    <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13 19.79 19.79 0 0 1 1.61 4.27 2 2 0 0 1 3.6 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg> <span>Contact:</span> ${b.customerContact}</div>
                    <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> <span>Price:</span> $${b.price}</div>
                    ${b.notes ? `<div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg> <span>Notes:</span> ${b.notes}</div>` : ''}
                    ${actions ? `<div class="booking-actions">${actions}</div>` : ''}
                </div>`;
            }).join('');
        }

        async function updateBooking(id, status) {
            try {
                await API.updateBookingStatus(id, status);
                await loadProviderBookings();
            } catch(e) { showToast('Error updating booking', true); }
        }

        function openReschedule(id) {
            rescheduleBookingId = id;
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            const tStr = tomorrow.toISOString().split('T')[0];
            document.getElementById('rescheduleDate').min = tStr;
            document.getElementById('rescheduleDate').value = tStr;
            document.getElementById('rescheduleHour').value = '09';
            document.getElementById('rescheduleMinute').value = '00';
            document.getElementById('rescheduleModal').classList.add('active');
        }

        async function confirmReschedule() {
            const date = document.getElementById('rescheduleDate').value;
            const hour = document.getElementById('rescheduleHour').value;
            const minute = document.getElementById('rescheduleMinute').value;
            if (!date) { showToast('Please select a date', true); return; }
            const newTime = new Date(`${date}T${hour}:${minute}:00`).toISOString();
            try {
                await API.updateBookingStatus(rescheduleBookingId, 'rescheduled', newTime);
                document.getElementById('rescheduleModal').classList.remove('active');
                await loadProviderBookings();
                showToast('✅ Booking rescheduled! Customer has been notified.', false);
            } catch(e) {
                console.error('Reschedule error:', e);
                showToast('Error rescheduling: ' + (e.message || 'Please try again'), true);
            }
        }

        // ============================================
        // ANALYTICS
        // ============================================
        async function loadAnalytics() {
            document.getElementById('analyticsContent').innerHTML = `<div class="empty-state"><div class="empty-emoji">📊</div><h3>Loading analytics...</h3></div>`;
            try {
                const res = await API.getAnalytics();
                const a = res.analytics;

                // Calculate potential earnings from unsold slots
                let potentialEarnings = 0;
                if (myService) {
                    const wdLeft = myService.weekdaySlots != null ? Math.max(0, myService.weekdaySlots - (myService.weekdaySlotsUsed || 0)) : 0;
                    const weLeft = myService.weekendSlots != null ? Math.max(0, myService.weekendSlots - (myService.weekendSlotsUsed || 0)) : 0;
                    potentialEarnings = (wdLeft * myService.weekdayPrice) + (weLeft * myService.weekendPrice);
                }

                const maxBookings = Math.max(...a.last7Days.map(d => d.bookings), 1);
                const maxEarnings = Math.max(...a.last7Days.map(d => d.earnings), 1);

                document.getElementById('analyticsContent').innerHTML = `
                    ${potentialEarnings > 0 ? `
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:14px;padding:16px;margin-bottom:16px;color:white;text-align:center;">
                        <div style="font-size:12px;font-weight:700;opacity:0.85;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;align-items:center;justify-content:center;gap:5px;"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>Potential Revenue</div>
                        <div style="font-size:32px;font-weight:900;line-height:1;margin-bottom:4px;">$${potentialEarnings.toFixed(2)}</div>
                        <div style="font-size:13px;opacity:0.75;">If all remaining slots sell</div>
                    </div>` : ''}
                    <div class="analytics-grid">
                        <div class="stat-card"><div class="stat-label">Today</div><div class="stat-value">${a.daily.count}</div><div class="stat-earn">$${a.daily.earnings.toFixed(2)}</div></div>
                        <div class="stat-card"><div class="stat-label">This Week</div><div class="stat-value">${a.weekly.count}</div><div class="stat-earn">$${a.weekly.earnings.toFixed(2)}</div></div>
                        <div class="stat-card"><div class="stat-label">This Month</div><div class="stat-value">${a.monthly.count}</div><div class="stat-earn">$${a.monthly.earnings.toFixed(2)}</div></div>
                        <div class="stat-card highlight"><div class="stat-label">All Time</div><div class="stat-value">${a.allTime.count}</div><div class="stat-earn">$${a.allTime.earnings.toFixed(2)}</div></div>
                    </div>
                    <div class="stat-card" style="margin-bottom:16px;display:flex;justify-content:space-around;">
                        <div style="text-align:center;"><div style="font-size:22px;font-weight:800;color:#d97706;">${a.byStatus.pending||0}</div><div style="font-size:11px;color:#888;">Pending</div></div>
                        <div style="text-align:center;"><div style="font-size:22px;font-weight:800;color:#059669;">${a.byStatus.confirmed||0}</div><div style="font-size:11px;color:#888;">Confirmed</div></div>
                        <div style="text-align:center;"><div style="font-size:22px;font-weight:800;color:#7c3aed;">${a.byStatus.completed||0}</div><div style="font-size:11px;color:#888;">Completed</div></div>
                        <div style="text-align:center;"><div style="font-size:22px;font-weight:800;color:#dc2626;">${a.byStatus.rejected||0}</div><div style="font-size:11px;color:#888;">Rejected</div></div>
                    </div>
                    <div class="chart-bar-wrap">
                        <h3 style="display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Bookings – Last 7 Days</h3>
                        ${a.last7Days.map(d => `
                        <div class="bar-row">
                            <div class="bar-label">${d.date.split(',')[0]}</div>
                            <div class="bar-track"><div class="bar-fill" style="width:${Math.round((d.bookings/maxBookings)*100)}%"></div></div>
                            <div class="bar-val">${d.bookings}</div>
                        </div>`).join('')}
                    </div>
                    <div class="chart-bar-wrap">
                        <h3 style="display:flex;align-items:center;gap:6px;"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>Earnings – Last 7 Days</h3>
                        ${a.last7Days.map(d => `
                        <div class="bar-row">
                            <div class="bar-label">${d.date.split(',')[0]}</div>
                            <div class="bar-track"><div class="bar-fill" style="width:${Math.round((d.earnings/maxEarnings)*100)}%;background:linear-gradient(135deg,#f093fb,#f5576c)"></div></div>
                            <div class="bar-val">$${d.earnings.toFixed(0)}</div>
                        </div>`).join('')}
                    </div>`;
            } catch(e) {
                document.getElementById('analyticsContent').innerHTML = `<div class="empty-state"><div class="empty-emoji">⚠️</div><h3>Could not load analytics</h3></div>`;
            }
        }

        // ============================================
        // CUSTOMER MY BOOKINGS
        // ============================================
        async function updateSavingsTracker() {
            try {
                const res = await API.getSavingsLeaderboard();
                const totalSaved = res.totalSaved || 0;
                const percentile = res.percentile || 0;
                
                document.getElementById('savingsAmount').textContent = `$${Math.round(totalSaved)}`;
                
                // Show rank based on actual percentile among all customers
                let rank = '';
                if (percentile >= 99) rank = 'Top 1% 🏆';
                else if (percentile >= 90) rank = 'Top 10% 🌟';
                else if (percentile >= 75) rank = 'Top 25% ⭐';
                else if (percentile >= 50) rank = 'Top 50% ✨';
                else if (totalSaved > 0) rank = 'Keep saving!';
                else rank = 'Start saving!';
                
                document.getElementById('savingsRank').textContent = rank;
                
                // Always show badge for customers
                document.getElementById('savingsBadge').style.visibility = 'visible';
                
                // Store for celebration modal
                savingsCelebrationData = { totalSaved, rank, percentile };
            } catch (err) {
                console.error('Error loading savings tracker:', err);
                // Still show badge even on error, just with $0
                document.getElementById('savingsAmount').textContent = '$0';
                document.getElementById('savingsRank').textContent = 'Start saving!';
                document.getElementById('savingsBadge').style.visibility = 'visible';
            }
        }

        async function loadMyBookings() {
            document.getElementById('myBookingsList').innerHTML = `<div class="empty-state"><div class="empty-emoji">⏳</div><h3>Loading...</h3></div>`;
            try {
                const res = await API.getCustomerBookings();
                const bookings = (res.bookings || []).sort((a, b) => new Date(b.preferredTime) - new Date(a.preferredTime));
                
                // Update savings tracker
                await updateSavingsTracker();
                
                if (!bookings.length) {
                    document.getElementById('myBookingsList').innerHTML = `<div class="empty-state"><div class="empty-emoji">📍</div><h3>No bookings yet</h3><p>Book a service to see your status here</p></div>`;
                    return;
                }
                window._customerBookings = bookings;
                document.getElementById('myBookingsList').innerHTML = bookings.map((b, idx) => {
                    const svc = b.service || {};
                    const date = new Date(b.preferredTime).toLocaleString('en-US', { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
                    return `<div class="booking-card" style="cursor:pointer;" onclick="showBookingDetail(${idx})">
                        <div class="booking-card-header">
                            <div>
                                <div class="booking-card-title">${svc.serviceType || 'Service'}</div>
                                <div class="booking-card-sub">by ${svc.providerName || ''}</div>
                            </div>
                            <span class="status-pill status-${b.status}">${b.status}</span>
                        </div>
                        <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> <span>Date:</span> ${date}</div>
                        <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> <span>Location:</span> <span class="no-link">${svc.location || ''}</span></div>
                        <div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> <span>Price:</span> $${b.price}</div>
                        ${b.notes ? `<div class="booking-meta"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg> <span>Notes:</span> ${b.notes}</div>` : ''}
                    </div>`;
                }).join('');
            } catch(e) {
                document.getElementById('myBookingsList').innerHTML = `<div class="empty-state"><div class="empty-emoji">⚠️</div><h3>Could not load bookings</h3></div>`;
            }
        }

        async function cancelMyBooking(id) {
            cancelMyBookingConfirm(id);
        }

        // ============================================
        // UTILS
        // ============================================
        // ============================================
        // TOAST — replaces all alert() calls
        // ============================================
        function showToast(msg, isError) {
            const old = document.getElementById('appToast');
            if (old) old.remove();
            const t = document.createElement('div');
            t.id = 'appToast';
            t.textContent = msg;
            const bg = isError
                ? 'linear-gradient(135deg,#ef4444,#dc2626)'
                : 'linear-gradient(135deg,#667eea,#764ba2)';
            t.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:' + bg + ';color:white;padding:13px 22px;border-radius:25px;font-size:14px;font-weight:600;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.25);max-width:320px;text-align:center;line-height:1.4;';
            document.querySelector('.app-container').appendChild(t);
            setTimeout(() => { if (t.parentNode) t.remove(); }, 3500);
        }


        // ============================================
        // CUSTOM SELECT DROPDOWNS
        // ============================================
        const _blockFilterScroll = e => e.preventDefault();

        function toggleSearchPill() {
            const input = document.getElementById('searchInput');
            const isExpanded = input.style.display !== 'none';
            if (isExpanded) {
                input.style.display = 'none';
                input.value = '';
                searchServices('');
            } else {
                input.style.display = 'block';
                input.focus();
            }
        }

        function toggleFilterPill() {
            const drop = document.getElementById('filterTypeDropdown');
            const isOpen = drop.style.display !== 'none';
            document.querySelectorAll('.custom-select-dropdown').forEach(d => d.style.display = 'none');
            drop.style.display = 'none';
            document.removeEventListener('touchmove', _blockFilterScroll);
            // Close location panel if open
            const locPanel = document.getElementById('locationPanel');
            if (locPanel) locPanel.style.display = 'none';
            if (!isOpen) {
                drop.style.display = 'block';
                document.addEventListener('touchmove', _blockFilterScroll, { passive: false });
            }
        }

        function toggleCustomSelect(boxId) {
            const dropId = boxId.replace('Box', 'Dropdown');
            const drop = document.getElementById(dropId);
            const box = document.getElementById(boxId);
            const isOpen = drop.style.display !== 'none';
            document.querySelectorAll('.custom-select-dropdown').forEach(d => d.style.display = 'none');
            if (!isOpen) {
                drop.style.display = 'block';
                const topPos = box.offsetTop + box.offsetHeight + 2;
                drop.style.top = topPos + 'px';
                drop.style.left = box.offsetLeft + 'px';
                drop.style.right = 'auto';
                drop.style.width = box.offsetWidth + 'px';
            }
        }

        function pickAccountType(value, label) {
            document.getElementById('signupAccountType').value = value;
            document.getElementById('accountTypeLabel').textContent = label;
            document.getElementById('accountTypeDropdown').style.display = 'none';
        }

        function pickFilterType(value, label) {
            document.getElementById('filterType').value = value;
            document.getElementById('filterTypeLabel').textContent = label || 'All types';
            document.getElementById('filterTypeDropdown').style.display = 'none';
            document.removeEventListener('touchmove', _blockFilterScroll);
            applyCurrentFilters();
        }

        // Close custom dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-select-box') && !e.target.closest('.custom-select-dropdown')) {
                document.querySelectorAll('.custom-select-dropdown').forEach(d => d.style.display = 'none');
                document.removeEventListener('touchmove', _blockFilterScroll);
            }
            if (!e.target.closest('#locationPill')) {
                const locPanel = document.getElementById('locationPanel');
                if (locPanel) locPanel.style.display = 'none';
            }
        });

        // ============================================
        // LOCATION FILTER
        // ============================================
        function toggleLocationPill() {
            const panel = document.getElementById('locationPanel');
            const isOpen = panel.style.display !== 'none';
            // Close filter dropdown if open
            document.getElementById('filterTypeDropdown').style.display = 'none';
            document.removeEventListener('touchmove', _blockFilterScroll);
            if (isOpen) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                populateCityChips();
                updateRadiusBtns();
                // Focus search input
                setTimeout(() => {
                    const inp = document.getElementById('locationSearchInput');
                    if (inp && locationFilter.name) inp.value = locationFilter.name;
                }, 50);
            }
        }

        function extractCityFromAddress(location) {
            if (!location) return null;
            const parts = location.split(',').map(p => p.trim()).filter(Boolean);
            // Find the province/state: a part that starts with exactly 2 uppercase letters (e.g. "ON", "ON M5V 1A1", "BC V6B 1A1")
            const provinceIdx = parts.findIndex(p => /^[A-Z]{2}(\s|$)/.test(p));
            if (provinceIdx > 0) {
                const candidate = parts[provinceIdx - 1];
                // Make sure we didn't accidentally grab a street address (contains digits)
                if (!/\d/.test(candidate)) return candidate;
            }
            // Fallback: find the first part that has no digits and is not a country name
            const skip = new Set(['canada', 'united states', 'usa', 'us']);
            for (let i = 1; i < parts.length; i++) {
                const p = parts[i];
                if (!/\d/.test(p) && !skip.has(p.toLowerCase()) && !/^[A-Z]{2}(\s|$)/.test(p)) return p;
            }
            return parts[0];
        }

        function populateCityChips() {
            const container = document.getElementById('locationCityChips');
            if (!container) return;
            const seen = new Set();
            const cities = [];
            allServices.filter(s => !s._isPlusCard && s.location).forEach(s => {
                const city = extractCityFromAddress(s.location);
                if (city && !seen.has(city)) { seen.add(city); cities.push(city); }
            });
            if (cities.length === 0) {
                container.innerHTML = '<span style="font-size:12px;color:#bbb;">No cities yet</span>';
                return;
            }
            container.innerHTML = cities.slice(0, 8).map(city => `
                <button onclick="selectCity('${city.replace(/'/g, "\\'")}', event)"
                    class="city-chip ${locationFilter.name === city ? 'active' : ''}">${city}</button>
            `).join('');
        }

        async function selectCity(city, e) {
            if (e) e.stopPropagation();
            // Append province hint for better geocoding accuracy
            const coords = await geocodeAddress(city + ', Canada', 'city_' + city);
            if (coords) {
                await setLocationFilter(city, coords.lat, coords.lng, locationFilter.radius);
            } else {
                showToast('Could not locate ' + city + ' — try the search box', false);
            }
        }

        function selectRadius(km) {
            locationFilter.radius = km;
            updateRadiusBtns();
            if (locationFilter.lat !== null) {
                localStorage.setItem('locationFilter', JSON.stringify(locationFilter));
                applyCurrentFilters();
            }
        }

        function updateRadiusBtns() {
            document.querySelectorAll('.radius-btn').forEach(btn => {
                const r = parseInt(btn.dataset.radius);
                btn.classList.toggle('active', r === locationFilter.radius);
            });
        }

        async function setLocationFilter(name, lat, lng, radius) {
            locationFilter = { name, lat, lng, radius: radius || locationFilter.radius };
            localStorage.setItem('locationFilter', JSON.stringify(locationFilter));
            updateLocationPillLabel();
            document.getElementById('locationPanel').style.display = 'none';
            await applyCurrentFilters();
            const count = services.filter(s => !s._isPlusCard).length;
            if (count === 0) {
                showToast('No deals found within ' + locationFilter.radius + 'km', false);
            } else {
                showToast('📍 ' + count + ' deal' + (count === 1 ? '' : 's') + ' within ' + locationFilter.radius + 'km of ' + name.split(',')[0], true);
            }
        }

        function clearLocationFilter(e) {
            if (e) e.stopPropagation();
            locationFilter = { name: '', lat: null, lng: null, radius: locationFilter.radius };
            localStorage.removeItem('locationFilter');
            const inp = document.getElementById('locationSearchInput');
            if (inp) inp.value = '';
            updateLocationPillLabel();
            applyCurrentFilters();
        }

        function updateLocationPillLabel() {
            const label = document.getElementById('locationPillLabel');
            const clearBtn = document.getElementById('locationClearBtn');
            const pillInner = document.getElementById('locationPillInner');
            if (!label || !clearBtn || !pillInner) return;
            if (locationFilter.lat !== null && locationFilter.name) {
                const shortName = locationFilter.name.split(',')[0].trim();
                label.textContent = shortName;
                label.style.display = 'inline';
                clearBtn.style.display = 'inline';
                pillInner.style.background = 'rgba(102,126,234,0.12)';
                pillInner.style.boxShadow = '0 2px 16px rgba(102,126,234,0.25)';
            } else {
                label.style.display = 'none';
                clearBtn.style.display = 'none';
                pillInner.style.background = 'rgba(255,255,255,0.96)';
                pillInner.style.boxShadow = '0 2px 16px rgba(0,0,0,0.14)';
            }
        }

        async function applyLocationFromInput() {
            const input = document.getElementById('locationSearchInput');
            const query = input ? input.value.trim() : '';
            if (!query) return;
            const coords = await geocodeAddress(query, 'custom_' + query);
            if (coords) {
                await setLocationFilter(query, coords.lat, coords.lng, locationFilter.radius);
            } else {
                showToast('Location not found — try a city name', false);
            }
        }

        async function useMyLocation() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported', false);
                return;
            }
            showToast('Getting your location...', true);
            navigator.geolocation.getCurrentPosition(
                async pos => {
                    try {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        let name = 'My Location';
                        if (window.google && google.maps && google.maps.Geocoder) {
                            await new Promise(resolve => {
                                new google.maps.Geocoder().geocode({ location: { lat, lng } }, (results, status) => {
                                    if (status === 'OK' && results[0]) {
                                        const cityComp = results[0].address_components.find(c => c.types.includes('locality'));
                                        const sublocal = results[0].address_components.find(c => c.types.includes('sublocality'));
                                        name = (cityComp || sublocal)
                                            ? (cityComp || sublocal).long_name
                                            : results[0].formatted_address.split(',')[0];
                                    }
                                    resolve();
                                });
                            });
                        }
                        await setLocationFilter(name, lat, lng, locationFilter.radius);
                    } catch(e) {
                        showToast('Could not apply location filter', false);
                    }
                },
                err => {
                    const msg = err.code === 1 ? 'Location permission denied'
                              : err.code === 2 ? 'Location unavailable'
                              : 'Location request timed out';
                    showToast(msg, false);
                },
                { timeout: 10000, maximumAge: 60000 }
            );
        }

        // ============================================
        // SHOW DETAIL FROM SAVED LIST
        // ============================================
        function showDetailFromSaved(serviceId) {
            const service = allServices.find(s => (s._id || s.id) === serviceId)
                || savedServices.find(s => (s._id || s.id) === serviceId);
            if (!service) return;
            // Temporarily set as current service for showDetails
            const prevIdx = currentCardIndex;
            const prevServices = services;
            services = [service];
            currentCardIndex = 0;
            showDetails();
            // Restore after modal is shown
            services = prevServices;
            currentCardIndex = prevIdx;
        }


        // ============================================
        // CUSTOM DATE PICKER
        // ============================================
        let _cdpYear, _cdpMonth, _cdpDayType;

        function cdpInit(dayType) {
            _cdpDayType = dayType; // 'weekday', 'weekend', or null
            const now = new Date();
            _cdpYear = now.getFullYear();
            _cdpMonth = now.getMonth();
            // Advance to next month if we're near the end and it helps show valid dates
            cdpRender();
            // Set hint
            const hint = document.getElementById('cdpHint');
            if (dayType === 'weekend') hint.textContent = 'Weekends only — Sat & Sun';
            else if (dayType === 'weekday') hint.textContent = 'Weekdays only — Mon to Fri';
            else hint.textContent = '';
        }

        function cdpChangeMonth(dir) {
            _cdpMonth += dir;
            if (_cdpMonth > 11) { _cdpMonth = 0; _cdpYear++; }
            if (_cdpMonth < 0)  { _cdpMonth = 11; _cdpYear--; }
            cdpRender();
        }

        function cdpRender() {
            const months = ['January','February','March','April','May','June',
                            'July','August','September','October','November','December'];
            document.getElementById('cdpMonthLabel').textContent = months[_cdpMonth] + ' ' + _cdpYear;
            const grid = document.getElementById('cdpGrid');
            grid.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            const firstDay = new Date(_cdpYear, _cdpMonth, 1).getDay(); // 0=Sun
            const daysInMonth = new Date(_cdpYear, _cdpMonth + 1, 0).getDate();
            const selectedVal = document.getElementById('preferredDate').value;

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const blank = document.createElement('div');
                blank.className = 'cdp-day cdp-empty';
                grid.appendChild(blank);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(_cdpYear, _cdpMonth, d);
                const dow = date.getDay(); // 0=Sun, 6=Sat
                const isWknd = dow === 0 || dow === 6;
                const isPast = date < tomorrow;
                const dateStr = date.toISOString().split('T')[0];

                let disabled = false;
                if (_cdpDayType === 'weekend' && !isWknd) disabled = true;
                if (_cdpDayType === 'weekday' && isWknd) disabled = true;

                const el = document.createElement('div');
                el.textContent = d;
                el.className = 'cdp-day';
                if (isPast || disabled) {
                    el.classList.add(isPast ? 'cdp-past' : 'cdp-disabled');
                } else {
                    el.onclick = () => cdpSelect(dateStr, el);
                }
                if (dateStr === selectedVal) el.classList.add('cdp-selected');
                grid.appendChild(el);
            }
        }

        function cdpSelect(dateStr, el) {
            document.getElementById('preferredDate').value = dateStr;
            document.querySelectorAll('.cdp-day.cdp-selected').forEach(d => d.classList.remove('cdp-selected'));
            el.classList.add('cdp-selected');
        }

        // ============================================
        // DEEP LINK HANDLER — email/SMS redirect to tab
        // ============================================
        function handleDeepLink() {
            if (sessionStorage.getItem('showPlusSuccess')) {
                sessionStorage.removeItem('showPlusSuccess');
                showToast('🎉 Welcome to SlowDay+! Enjoy your 14-day free trial.', false);
                loadSubscriptionStatus();
            }
            const tab = sessionStorage.getItem('deepLinkTab');
            if (!tab || !currentUser) return;
            sessionStorage.removeItem('deepLinkTab');
            if (tab === 'bookings') {
                showTab('saved');
                // Switch to My Bookings subtab
                setTimeout(() => {
                    const mybookingsBtn = document.getElementById('stabMyBookings');
                    if (mybookingsBtn) mybookingsBtn.click();
                }, 200);
            } else if (tab === 'provider') {
                showTab('provider');
                // Switch to Bookings subtab inside provider view
                setTimeout(() => {
                    const provBookingsBtn = document.querySelector('.ptab-btn[onclick*="bookings"]');
                    if (provBookingsBtn) provBookingsBtn.click();
                }, 200);
            }
        }


        // ============================================
        // SUPPORT TICKETS
        // ============================================
        async function loadMyTickets() {
            const list = document.getElementById('accountOpenTickets');
            if (!list) return;
            try {
                const res = await API.call('/support/my');
                if (!res.tickets || res.tickets.length === 0) {
                    list.innerHTML = '';
                    return;
                }
                list.innerHTML = res.tickets.map(t => `
                    <div style="background:white;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:12px;border-left:4px solid #f59e0b;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                            <div>
                                <div style="font-weight:700;font-size:15px;color:#1a1a2e;">${t.subject}</div>
                                <div style="font-size:11px;color:#aaa;margin-top:2px;">Ticket #${t._id.slice(-8).toUpperCase()} • ${new Date(t.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>
                            </div>
                            <span style="background:#fef3c7;color:#d97706;font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;">OPEN</span>
                        </div>
                        <div style="font-size:13px;color:#555;line-height:1.5;">${t.message}</div>
                    </div>`).join('');
            } catch(e) {
                list.innerHTML = '';
            }
        }

        async function submitSupportTicket() {
            const subject = document.getElementById('ticketSubject').value.trim();
            const message = document.getElementById('ticketMessage').value.trim();
            if (!subject) { showToast('Please enter a subject', true); return; }
            if (!message) { showToast('Please describe your issue', true); return; }
            try {
                await API.call('/support', 'POST', { subject, message });
                showToast('✅ Ticket submitted! We will get back to you soon.', false);
                document.getElementById('ticketSubject').value = '';
                document.getElementById('ticketMessage').value = '';
                loadMyTickets();
            } catch(e) {
                showToast(e.message || 'Failed to submit ticket', true);
            }
        }


        // ============================================
        // SLOWDAY+ SUBSCRIPTION
        // ============================================
        let currentUserIsPlus = false;
        let plusStatus = null;

        async function loadSubscriptionStatus() {
            try {
                const res = await API.getSubscriptionStatus();
                plusStatus = res;
                currentUserIsPlus = res.isPlus || false;
                renderPlusAccountSection();
                updateCardBadges();
            } catch(e) {
                // Subscription service not available yet
                currentUserIsPlus = false;
                plusStatus = null;
            }
        }

        function renderPlusAccountSection() {
            const el = document.getElementById('slowdayPlusAccountSection');
            if (!el) return;
            if (!plusStatus || !plusStatus.isPlus) {
                el.innerHTML = `
                    <div onclick="showSlowDayPlusModal()" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:14px;padding:16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                        <div>
                            <div style="font-weight:800;font-size:15px;color:#92400e;">⚡ SlowDay<span style="color:#d97706;">+</span></div>
                            <div style="font-size:12px;color:#a16207;margin-top:2px;">14-day free trial • $4.99/mo after</div>
                        </div>
                        <div style="background:#d97706;color:white;font-size:12px;font-weight:700;padding:6px 14px;border-radius:20px;">Upgrade →</div>
                    </div>`;
            } else {
                const isTrial = plusStatus.status === 'trialing';
                const endDate = isTrial
                    ? new Date(plusStatus.trialEnds).toLocaleDateString('en-US',{month:'short',day:'numeric'})
                    : new Date(plusStatus.currentPeriodEnd).toLocaleDateString('en-US',{month:'short',day:'numeric'});
                const cancelText = plusStatus.cancelAtPeriodEnd
                    ? `<div style="font-size:11px;color:#e53e3e;margin-top:4px;">Cancels ${endDate}</div>`
                    : `<button onclick="cancelSlowDayPlus()" style="font-size:11px;color:#aaa;background:none;border:none;cursor:pointer;padding:0;margin-top:4px;text-decoration:underline;">Cancel subscription</button>`;
                el.innerHTML = `
                    <div style="background:linear-gradient(135deg,#1a1a2e,#2d2d5e);border-radius:14px;padding:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
                            <div style="font-weight:800;font-size:15px;color:white;">⚡ SlowDay<span style="color:#fbbf24;">+</span> Active</div>
                            <div style="background:#fbbf24;color:#1a1a2e;font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;">${isTrial ? 'FREE TRIAL' : 'ACTIVE'}</div>
                        </div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.7);">${isTrial ? 'Trial ends' : 'Renews'} ${endDate} • 10% off all bookings</div>
                        ${cancelText}
                    </div>`;
            }
        }

        function showSlowDayPlusModal() {
            // Update modal CTA based on status
            const action = document.getElementById('plusModalAction');
            if (action && plusStatus && plusStatus.isPlus) {
                action.innerHTML = `<div style="text-align:center;padding:8px;background:#d1fae5;border-radius:12px;color:#065f46;font-weight:700;">✅ You are already a SlowDay+ member!</div>`;
            }
            document.getElementById('slowdayPlusModal').classList.add('active');
        }

        async function startSlowDayPlus() {
            const btn = document.querySelector('#plusModalAction button');
            if (btn) { btn.textContent = 'Redirecting to payment...'; btn.disabled = true; }
            try {
                const res = await API.startSubscription();
                if (res.url) {
                    window.location.href = res.url;
                } else {
                    showToast(res.message || 'Could not start subscription', true);
                    if (btn) { btn.textContent = 'Start Free Trial →'; btn.disabled = false; }
                }
            } catch(e) {
                const msg = e.message || '';
                if (msg.includes('not found') || msg.includes('404')) {
                    showToast('Subscription service is still deploying. Try again in 1 minute.', true);
                } else {
                    showToast(msg || 'Payment system not ready yet', true);
                }
                if (btn) { btn.textContent = 'Start Free Trial →'; btn.disabled = false; }
            }
        }

        async function cancelSlowDayPlus() {
            showConfirmModal('Cancel your SlowDay+ subscription?\nYou keep access until the end of your billing period.', 'Yes, Cancel', async () => {
                try {
                    await API.cancelSubscription();
                    showToast('Subscription cancelled. You keep access until period end.', false);
                    await loadSubscriptionStatus();
                    renderPlusAccountSection();
                } catch(e) {
                    showToast(e.message || 'Failed to cancel', true);
                }
            });
        }

        function updateCardBadges() {
            // Re-render cards to show/hide member badge - triggers on next render cycle
            if (typeof renderSavedList === 'function') renderSavedList();
        }

        function getPlusBadge() {
            if (!currentUserIsPlus) return '';
            return '<span style="display:inline-flex;align-items:center;gap:3px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px;margin-left:6px;vertical-align:middle;">👑 PLUS</span>';
        }

        function getPlusDiscount(price) {
            if (!currentUserIsPlus) return price;
            return Math.round(price * 0.9 * 100) / 100; // 10% off, rounded to cents
        }

        function getPlusDiscountLabel(price) {
            if (!currentUserIsPlus) return '';
            const discounted = getPlusDiscount(price);
            return `<span style="background:#fef3c7;color:#92400e;font-size:10px;font-weight:800;padding:2px 7px;border-radius:20px;margin-left:4px;">👑 $${discounted}</span>`;
        }

        // Prevent iOS pull-to-expand on bottom nav only
        document.addEventListener('DOMContentLoaded', function() {
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) {
                bottomNav.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                }, { passive: false });
            }
        });

        // Prevent iOS overscroll/bounce on discover tab only
        document.addEventListener('DOMContentLoaded', function() {
            const discoverTab = document.getElementById('discoverTab');
            if (!discoverTab) return;
            let startY = 0;
            discoverTab.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            }, { passive: true });
            discoverTab.addEventListener('touchmove', function(e) {
                // card-content handles its own native scroll — never preventDefault here
                if (e.target.closest('.card-content')) return;
                // Find scrollable parent
                let el = e.target;
                let scrollable = null;
                while (el && el !== discoverTab) {
                    if (el.scrollHeight > el.clientHeight + 2) {
                        scrollable = el;
                        break;
                    }
                    el = el.parentElement;
                }
                if (!scrollable) {
                    e.preventDefault();
                    return;
                }
                const deltaY = e.touches[0].clientY - startY;
                const atTop = scrollable.scrollTop <= 0;
                const atBottom = scrollable.scrollTop + scrollable.clientHeight >= scrollable.scrollHeight - 2;
                // Block if trying to scroll past top or bottom boundary
                if ((atTop && deltaY > 0) || (atBottom && deltaY < 0)) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        // Lock background scroll whenever any modal is open (iOS-safe)
        document.addEventListener('DOMContentLoaded', function() {
            const appContainer = document.querySelector('.app-container');

            let lockedScrollTop = 0;

            function lockScroll() {
                lockedScrollTop = appContainer.scrollTop;
                appContainer.style.overflowY = 'hidden';
                const swipeContainer = document.querySelector('.swipe-container');
                if (swipeContainer) swipeContainer.style.height = swipeContainer.offsetHeight + 'px';
            }

            function unlockScroll() {
                appContainer.style.overflowY = 'auto';
                const swipeContainer = document.querySelector('.swipe-container');
                if (swipeContainer) swipeContainer.style.height = '';
            }

            // When the browser scrolls app-container (e.g. to show password manager input),
            // snap it back to the locked position while any modal is open.
            appContainer.addEventListener('scroll', function() {
                if (document.querySelector('.modal.active')) {
                    appContainer.scrollTop = lockedScrollTop;
                }
            });

            // Also handle visual viewport resize (keyboard / password manager shrinking viewport).
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', function() {
                    if (document.querySelector('.modal.active')) {
                        appContainer.scrollTop = lockedScrollTop;
                    }
                });
            }

            const observer = new MutationObserver(() => {
                const anyActive = document.querySelector('.modal.active');
                if (anyActive) lockScroll(); else unlockScroll();
            });
            document.querySelectorAll('.modal').forEach(modal => {
                observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
            });

            // touchmove prevention for iOS — blocks touch-scroll on backdrop,
            // but allows scroll inside .modal-content (e.g. long auth/booking forms)
            document.addEventListener('touchmove', function(e) {
                if (!document.querySelector('.modal.active')) return;
                const insideModalContent = e.target.closest('.modal-content');
                if (!insideModalContent) {
                    e.preventDefault();
                }
            }, { passive: false });
        });

        function initSlideTouch() {
            const container = document.getElementById('slideContainer');
            if (!container) return;
            let startX = 0, startY = 0, swipeDir = null;

            container.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                swipeDir = null;
                const track = document.getElementById('slideTrack');
                if (track) track.style.transition = 'none';
            }, { passive: true });

            container.addEventListener('touchmove', function(e) {
                const diffX = e.touches[0].clientX - startX;
                const diffY = e.touches[0].clientY - startY;
                if (!swipeDir && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
                    swipeDir = Math.abs(diffX) > Math.abs(diffY) ? 'h' : 'v';
                }
                if (swipeDir === 'h') {
                    e.preventDefault();
                    const track = document.getElementById('slideTrack');
                    if (track && window._slidePhotos) {
                        const baseOffset = window._slideIdx * (100 / window._slidePhotos.length);
                        track.style.transform = `translateX(calc(-${baseOffset}% + ${diffX}px))`;
                    }
                }
            }, { passive: false });

            container.addEventListener('touchend', function(e) {
                const diffX = e.changedTouches[0].clientX - startX;
                const track = document.getElementById('slideTrack');
                if (track) track.style.transition = 'transform 0.35s ease';
                if (swipeDir === 'h') {
                    if (diffX < -40) goToSlide(window._slideIdx + 1);
                    else if (diffX > 40) goToSlide(window._slideIdx - 1);
                    else goToSlide(window._slideIdx);
                }
            });
        }

        function goToSlide(idx) {
            const photos = window._slidePhotos;
            if (!photos) return;
            window._slideIdx = ((idx % photos.length) + photos.length) % photos.length;
            const track = document.getElementById('slideTrack');
            if (track) track.style.transform = 'translateX(-' + (window._slideIdx * (100/photos.length)) + '%)';
            const counter = document.getElementById('slideCounter');
            if (counter) counter.textContent = (window._slideIdx+1) + ' / ' + photos.length;
            photos.forEach((_, i) => {
                const dot = document.getElementById('slideDot' + i);
                if (!dot) return;
                dot.style.width = i === window._slideIdx ? '18px' : '7px';
                dot.style.background = i === window._slideIdx ? 'white' : 'rgba(255,255,255,0.5)';
            });
        }

        function getServiceEmoji(serviceType) {
            const emojis = { 'Haircut':'✂️','Barber':'💈','Cleaning':'🧹','Massage':'💆','Nails':'💅','Spa':'🧖','Personal Training':'💪','Dog Walking':'🐕','Tutoring':'📚','Photography':'📸','Car Detailing':'🚗','Laundry Service':'🧺','Other':'⭐' };
            return emojis[serviceType] || '⭐';
        }

        function showTerms() {
            document.getElementById('userProfileModal').classList.remove('active');
            document.getElementById('termsModal').classList.add('active');
        }
        function showPrivacy() {
            document.getElementById('userProfileModal').classList.remove('active');
            document.getElementById('privacyModal').classList.add('active');
        }

        // Savings celebration
        let savingsCelebrationData = { totalSaved: 0, rank: '', percentile: 0 };
        function showSavingsCelebration() {
            document.getElementById('celebrationModal').classList.add('active');
            document.getElementById('celebrationAmount').textContent = `$${Math.round(savingsCelebrationData.totalSaved)}`;
            document.getElementById('celebrationRank').textContent = savingsCelebrationData.rank;
            
            // Calculate top percentage (minimum 1%)
            const topPercent = Math.max(1, 100 - savingsCelebrationData.percentile);
            document.getElementById('celebrationPercentile').textContent = `You're in the top ${topPercent}% of all SlowDay savers!`;
            
            // Trigger confetti
            createConfetti();
        }

        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            container.innerHTML = '';
            const colors = ['#667eea', '#764ba2', '#fbbf24', '#f093fb', '#4ade80', '#f87171'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position:absolute;
                    width:10px;
                    height:10px;
                    background:${colors[Math.floor(Math.random()*colors.length)]};
                    top:-10px;
                    left:${Math.random()*100}%;
                    opacity:${0.5 + Math.random()*0.5};
                    transform:rotate(${Math.random()*360}deg);
                    animation:confettiFall ${2 + Math.random()*2}s linear forwards;
                `;
                container.appendChild(confetti);
            }
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>

    <style>

        /* Custom Select Dropdowns */
        .custom-select-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 14px;
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            user-select: none;
            position: relative;
        }
        .custom-select-box:active { background: #f8f9ff; }
        .filter-select-box {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            border: none;
            background: transparent;
        }
        #filterTypeDropdown {
            right: 0 !important;
            left: auto !important;
            width: 180px !important;
            max-height: 70vh;
            overflow-y: auto;
        }
        .custom-select-dropdown {
            position: absolute;
            background: white;
            border-radius: 14px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.18);
            z-index: 9999;
            overflow: hidden;
            min-width: 100%;
        }
        .custom-select-opt {
            padding: 13px 16px;
            font-size: 15px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .custom-select-opt:last-child { border-bottom: none; }
        .custom-select-opt:active, .custom-select-opt:hover { background: #f0f4ff; color: #667eea; }
        .form-group { position: relative; }
        .search-bar { position: relative; }

        /* Custom Date Picker */
        .custom-date-picker {
            border: 1.5px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            user-select: none;
        }
        .cdp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .cdp-nav {
            background: none;
            border: none;
            font-size: 24px;
            color: #667eea;
            cursor: pointer;
            padding: 0 8px;
            line-height: 1;
        }
        .cdp-month-label {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a2e;
        }
        .cdp-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: #aaa;
            margin-bottom: 4px;
        }
        .cdp-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .cdp-day {
            text-align: center;
            padding: 8px 2px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            color: #333;
            transition: background 0.15s;
        }
        .cdp-day:hover:not(.cdp-disabled):not(.cdp-past) {
            background: #f0f4ff;
            color: #667eea;
        }
        .cdp-day.cdp-selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 700;
        }
        .cdp-day.cdp-disabled {
            color: #ddd;
            cursor: not-allowed;
            background: none;
        }
        .cdp-day.cdp-past {
            color: #ddd;
            cursor: not-allowed;
        }
        .cdp-day.cdp-empty { background: none; cursor: default; }
        .cdp-hint {
            text-align: center;
            font-size: 11px;
            color: #667eea;
            font-weight: 600;
            margin-top: 6px;
            min-height: 16px;
        }
        @keyframes confettiFall {
            to {
                top: 100%;
                transform: translateY(100vh) rotate(${Math.random()*720}deg);
            }
        }
    </style>

    <!-- Savings Celebration Modal -->
    <div class="modal" id="celebrationModal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:16px 16px 0 0;">
                <h2>🎉 Congratulations!</h2>
                <button class="close-btn" onclick="document.getElementById('celebrationModal').classList.remove('active')" style="color:white;">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body" style="padding:40px 20px;text-align:center;position:relative;overflow:hidden;">
                <div id="confettiContainer" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;"></div>
                <div style="position:relative;z-index:2;">
                    <div style="font-size:18px;color:#666;font-weight:600;margin-bottom:12px;">You've saved</div>
                    <div id="celebrationAmount" style="font-size:56px;font-weight:900;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;margin-bottom:8px;">$0</div>
                    <div id="celebrationRank" style="font-size:28px;font-weight:800;color:#fbbf24;margin-bottom:16px;">Top 1% 🏆</div>
                    <div id="celebrationPercentile" style="font-size:15px;color:#555;line-height:1.5;max-width:280px;margin:0 auto;">You're in the top 1% of all SlowDay savers!</div>
                    <button onclick="document.getElementById('celebrationModal').classList.remove('active')" style="margin-top:28px;padding:14px 32px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:25px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(102,126,234,0.4);">Keep Saving!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms of Use Modal -->
    <div class="modal" id="termsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📜 Terms of Use</h2>
                <button class="close-btn" onclick="document.getElementById('termsModal').classList.remove('active')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body" style="padding:20px;max-height:60vh;overflow-y:auto;">
                <p style="color:#666;margin-bottom:16px;font-size:14px;line-height:1.6;">Effective Date: February 17, 2026</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">1. Acceptance of Terms</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">By accessing and using SlowDay Deals ("the Service"), you agree to be bound by these Terms of Use. If you do not agree, please discontinue use immediately.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">2. Service Description</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">SlowDay Deals is a marketplace connecting customers with service providers offering time-limited deals. We facilitate bookings but are not a party to agreements between customers and providers.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">3. User Accounts</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">You are responsible for maintaining the confidentiality of your account credentials and for all activities under your account.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">4. Provider Obligations</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">Service providers must accurately represent their services, honor confirmed bookings, and comply with all applicable laws.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">5. Customer Obligations</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">Customers must provide accurate booking information and honor confirmed appointments.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">6. Limitation of Liability</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">SlowDay Deals is not liable for the quality, safety, or legality of services provided. Disputes are between customers and providers.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">7. Termination</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We reserve the right to suspend or terminate accounts that violate these terms or engage in fraudulent activity.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">8. Changes to Terms</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We may update these terms at any time. Continued use constitutes acceptance of modified terms.</p>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="display:flex;align-items:center;gap:8px;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>Privacy Policy</h2>
                <button class="close-btn" onclick="document.getElementById('privacyModal').classList.remove('active')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body" style="padding:20px;max-height:60vh;overflow-y:auto;">
                <p style="color:#666;margin-bottom:16px;font-size:14px;line-height:1.6;">Effective Date: February 17, 2026</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">1. Information We Collect</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We collect: account information (name, email, phone), booking details, service listings, and usage analytics.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">2. How We Use Your Information</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">To facilitate bookings, send notifications, improve the Service, and communicate updates.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">3. Information Sharing</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We share booking information between customers and providers. We do not sell personal data to third parties.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">4. Data Security</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We implement industry-standard security measures to protect your data, but cannot guarantee absolute security.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">5. Your Rights</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">You may access, update, or delete your personal information through your account settings.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">6. Cookies and Tracking</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We use cookies and similar technologies to enhance user experience and analyze usage patterns.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">7. Third-Party Services</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">We use SendGrid for email and Twilio for SMS. These services have their own privacy policies.</p>
                <h3 style="font-size:16px;font-weight:700;margin:20px 0 10px;">8. Contact Us</h3>
                <p style="color:#555;font-size:14px;line-height:1.7;">For privacy questions, contact us at <a href="mailto:privacy@slowdaydeals.com" style="color:#667eea;font-weight:600;">privacy@slowdaydeals.com</a>.
                </p>
            </div>
        </div>
    </div>

</div>

        <!-- SlowDay+ Upgrade Modal -->
        <div id="slowdayPlusModal" class="modal">
            <div class="modal-content" style="max-width:380px;padding:0;overflow:hidden;border-radius:24px;">
                <!-- Header gradient -->
                <div style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:28px 24px 20px;text-align:center;position:relative;">
                    <button onclick="document.getElementById('slowdayPlusModal').classList.remove('active')" style="position:absolute;top:14px;right:14px;background:rgba(0,0,0,0.2);border:none;color:white;width:28px;height:28px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">×</button>
                    <div style="font-size:44px;margin-bottom:8px;">⚡</div>
                    <h2 style="color:white;margin:0;font-size:24px;font-weight:800;">SlowDay<span style="color:#fef3c7;">+</span></h2>
                    <p style="color:rgba(255,255,255,0.9);margin:6px 0 0;font-size:14px;">Members-only perks, every day</p>
                </div>
                <!-- Body -->
                <div style="padding:24px;">
                    <!-- Perks -->
                    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:36px;height:36px;border-radius:10px;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">👑</div>
                            <div><div style="font-weight:700;font-size:14px;color:#1a1a2e;">Members-Only Badge</div><div style="font-size:12px;color:#888;">Stand out on every service card</div></div>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:36px;height:36px;border-radius:10px;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">💸</div>
                            <div><div style="font-weight:700;font-size:14px;color:#1a1a2e;">10% Off All Deals</div><div style="font-size:12px;color:#888;">Extra discount on every booking</div></div>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div style="width:36px;height:36px;border-radius:10px;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">🎟️</div>
                            <div><div style="font-weight:700;font-size:14px;color:#1a1a2e;">First Access to Slots</div><div style="font-size:12px;color:#888;">See available spots before anyone else</div></div>
                        </div>
                    </div>
                    <!-- Pricing -->
                    <div style="background:#f8f9ff;border-radius:14px;padding:16px;text-align:center;margin-bottom:16px;">
                        <div style="font-size:13px;color:#888;margin-bottom:4px;">Only</div>
                        <div style="font-size:36px;font-weight:800;color:#1a1a2e;">$4.99<span style="font-size:16px;font-weight:500;color:#888;">/mo</span></div>
                        <div style="display:inline-block;background:#d1fae5;color:#065f46;font-size:12px;font-weight:700;padding:4px 12px;border-radius:20px;margin-top:6px;">✨ 14-day free trial — cancel anytime</div>
                    </div>
                    <!-- CTA -->
                    <div id="plusModalAction">
                        <button onclick="startSlowDayPlus()" style="width:100%;padding:15px;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:14px;font-size:16px;font-weight:800;cursor:pointer;letter-spacing:0.3px;">Start Free Trial →</button>
                        <p style="text-align:center;font-size:11px;color:#aaa;margin-top:10px;">No charge for 14 days. $4.99/mo after.</p>
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
